{% extends 'base.html' %}

{% block titulo %}
Tratamientos
{% endblock %}

{% block contenido %}
<div class="container mt-4">
  <h3>Listar Tratamientos</h3>

  <!-- Tarjeta -->
  <div class="card">
    <div class="card-header">
      <button type="button" class="btn btn-outline-info" id="btnAgregar">Agregar</button>
    </div>
    <div class="card-body">

      <!-- Contenedor con scroll horizontal -->
      <div style="overflow-x: auto; white-space: nowrap;">
        <table class="table table-striped" id="tbl">
          <thead class="table-info">
            <tr>
              <th>ID Consulta</th>
              <th>Médico</th>
              <th>Paciente</th>
              <th>Descripción</th>
              <th>Fecha</th>
              <th>Duración</th>
              <th>Costo</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
    </div>
  </div>

  <!-- Modal Formulario Tratamiento -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
      <div class="modal-content">
        
        <!-- Header -->
        <div class="modal-header table-info d-flex justify-content-between align-items-center">
          <h4 class="modal-title" id="modalTitle">Nuevo Tratamiento</h4>
          <button type="button" class="close ml-2" data-dismiss="modal">&times;</button>
        </div>

        <!-- Cuerpo del modal -->
        <div class="modal-body">
          <input type="hidden" id="txtIdTratamiento">

          <div class="row">
            <!-- ID Consulta Detalle -->
            <div class="col-md-6">
              <div class="form-group">
                <label>ID Consulta Detalle: <span class="text-danger">*</span></label>
                <input type="number" id="id_consulta_detalle" class="form-control" placeholder="Ingrese ID de consulta">
              </div>
            </div>

            <!-- Médico -->
            <div class="col-md-6">
              <div class="form-group">
                <input type="hidden" id="id_medico">
                <label>Médico: <span class="text-danger">*</span></label>
                <input type="text" id="txtMedico" class="form-control" placeholder="Click para seleccionar Médico" readonly>
              </div>
            </div>

            <!-- Paciente -->
            <div class="col-md-6">
              <div class="form-group">
                <input type="hidden" id="id_paciente">
                <label>Paciente: <span class="text-danger">*</span></label>
                <input type="text" id="txtPaciente" class="form-control" placeholder="Click para seleccionar Paciente" readonly>
              </div>
            </div>

            <!-- Descripción Tratamiento -->
            <div class="col-md-12">
              <div class="form-group">
                <label>Descripción Tratamiento: <span class="text-danger">*</span></label>
                <textarea id="descripcion_tratamiento" class="form-control" rows="3" placeholder="Ingrese descripción del tratamiento"></textarea>
              </div>
            </div>

            <!-- Fecha Tratamiento -->
            <div class="col-md-6">
              <div class="form-group">
                <label>Fecha Tratamiento:</label>
                <input type="date" id="fecha_tratamiento" class="form-control">
              </div>
            </div>

            <!-- Duración Estimada -->
            <div class="col-md-6">
              <div class="form-group">
                <label>Duración Estimada:</label>
                <input type="text" id="duracion_estimada" class="form-control" placeholder="Ej: 3 sesiones, 1 mes">
              </div>
            </div>

            <!-- Costo Estimado -->
            <div class="col-md-6">
              <div class="form-group">
                <label>Costo Estimado:</label>
                <input type="number" step="0.01" id="costo_estimado" class="form-control" placeholder="0.00">
              </div>
            </div>

            <!-- Estado -->
            <div class="col-md-6">
              <div class="form-group">
                <label>Estado:</label>
                <select id="estado" class="form-control">
                  <option value="pendiente">Pendiente</option>
                  <option value="en_proceso">En Proceso</option>
                  <option value="completado">Completado</option>
                  <option value="cancelado">Cancelado</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer fijo -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal Médico -->
  <div class="modal fade" id="modalBuscarMedico" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Médico</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblMedico">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Paciente -->
  <div class="modal fade" id="modalBuscarPaciente" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Paciente</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblPaciente">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Librerías necesarias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

function formatDateForDisplay(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${day}/${month}/${year}`;
}

// --- Tabla principal Tratamientos ---
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/Tratamiento',
    columns: [
      { data: 'id_consulta_detalle' },
      { data: 'medico_nombre' },
      { data: 'paciente_nombre' },
      { 
        data: 'descripcion_tratamiento',
        render: function(data) {
          return data && data.length > 50 ? data.substring(0, 50) + '...' : data;
        }
      },
      {
        data: 'fecha_tratamiento',
        render: function(data) {
          return formatDateForDisplay(data);
        }
      },
      { data: 'duracion_estimada', render: d => d || '-' },
      {
  data: 'costo_estimado',
  render: function(data) {
    if (!data) return '-';
    return new Intl.NumberFormat('es-PY', {
      style: 'currency',
      currency: 'PYG',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(data);
  }
      },
      {
        data: 'estado',
        render: function(data) {
          let color = '#155724', bg = '#d4edda';
          if(data === 'cancelado') { color = '#721c24'; bg = '#f8d7da'; }
          if(data === 'en_proceso') { color = '#856404'; bg = '#fff3cd'; }
          if(data === 'pendiente') { color = '#004085'; bg = '#cce5ff'; }
          return `<span style="color:${color}; background-color:${bg}; padding:2px 6px; border-radius:4px;">${data}</span>`;
        }
      },
      {
        data: function(row) {
          return `
          <button type="button" name="btn_editar" class="btn btn-info btn-sm" data-id="${row.id_tratamiento}" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" name="btn_eliminar" class="btn btn-danger btn-sm" data-id="${row.id_tratamiento}" title="Eliminar">
            <i class="fas fa-trash-alt"></i>
          </button>`;
        }
      }
    ]
  });
};

// --- Modal Médico ---
const initDatatableMedico = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/medico',
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_medico" class="btn btn-primary" data-id="${row.id_medico}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblMedico').on('click', 'button[name="btn_seleccionar_medico"]', function() {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    $('#id_medico').val(id);
    $('#txtMedico').val(`${nombre} ${apellido}`);
    $('#modalBuscarMedico').modal('hide');
  });
};

// --- Modal Paciente ---
const initDatatablePaciente = () => {
  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/paciente',
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_paciente" class="btn btn-primary" data-id="${row.id_paciente}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblPaciente').on('click', 'button[name="btn_seleccionar_paciente"]', function() {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    $('#id_paciente').val(id);
    $('#txtPaciente').val(`${nombre} ${apellido}`);
    $('#modalBuscarPaciente').modal('hide');
  });
};

// --- Apertura de modales ---
const buscarMedico = () => $('#txtMedico').on('click', () => $('#modalBuscarMedico').modal());
const buscarPaciente = () => $('#txtPaciente').on('click', () => $('#modalBuscarPaciente').modal());

// --- Agregar ---
const agregar = () => {
  $('#btnAgregar').on('click', () => {
    $('#modalTitle').text("Agregar Tratamiento");
    $('#txtIdTratamiento, #id_consulta_detalle, #txtMedico, #txtPaciente, #descripcion_tratamiento, #fecha_tratamiento, #duracion_estimada, #costo_estimado').val("");
    $('#id_medico, #id_paciente').val("");
    $('#estado').val('pendiente');
    $('#modalFormulario').modal();
  });
};

// --- Guardar ---
const guardar = () => $('#btnGuardar').on('click', function() {
  const idTratamiento = $('#txtIdTratamiento').val();

  const payload = {
    id_consulta_detalle: parseInt($('#id_consulta_detalle').val()),
    id_medico: parseInt($('#id_medico').val()),
    id_paciente: parseInt($('#id_paciente').val()),
    descripcion_tratamiento: $('#descripcion_tratamiento').val(),
    fecha_tratamiento: $('#fecha_tratamiento').val() || null,
    duracion_estimada: $('#duracion_estimada').val() || null,
    costo_estimado: $('#costo_estimado').val() ? parseFloat($('#costo_estimado').val()) : null,
    estado: $('#estado').val()
  };

  if (!payload.id_consulta_detalle || !payload.id_medico || !payload.id_paciente || !payload.descripcion_tratamiento) {
    Swal.fire("Error", "Complete los campos obligatorios (Consulta, Médico, Paciente y Descripción)", "error");
    return;
  }

  const tabla = $('#tbl').DataTable();
  const method = idTratamiento ? 'PUT' : 'POST';
  const url = idTratamiento ? `/api/v1/Tratamiento/${idTratamiento}` : '/api/v1/Tratamiento';

  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
    body: JSON.stringify(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      tabla.ajax.reload();
      Swal.fire(idTratamiento ? "Actualizado" : "Registrado", "Tratamiento guardado correctamente.", "success");
      $('#modalFormulario').modal("hide");
    } else {
      Swal.fire("Error", data.error, "error");
    }
  })
  .catch(err => Swal.fire("Error", "Ocurrió un error al guardar el tratamiento.", "error"));
});

// --- Editar ---
const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function() {
    const idTratamiento = $(this).data('id');

    fetch(`/api/v1/Tratamiento/${idTratamiento}`)
      .then(resp => resp.json())
      .then(data => {
        const d = data.data;

        $('#txtIdTratamiento').val(d.id_tratamiento);
        $('#id_consulta_detalle').val(d.id_consulta_detalle);
        $('#id_medico').val(d.id_medico);
        $('#txtMedico').val(d.medico_nombre);
        $('#id_paciente').val(d.id_paciente);
        $('#txtPaciente').val(d.paciente_nombre);
        $('#descripcion_tratamiento').val(d.descripcion_tratamiento);
        $('#fecha_tratamiento').val(formatDateForInput(d.fecha_tratamiento));
        $('#duracion_estimada').val(d.duracion_estimada || "");
        $('#costo_estimado').val(d.costo_estimado || "");
        $('#estado').val(d.estado);

        $('#modalTitle').text("Editar Tratamiento");
        $('#modalFormulario').modal();
      })
      .catch(err => Swal.fire("Error", "No se pudo cargar el tratamiento", "error"));
  });
};

// --- Eliminar ---
const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
    const idTratamiento = $(this).data('id');
    const fila = $(this).closest('tr');

    Swal.fire({
      title: "¿Deseas eliminar este tratamiento?",
      showCancelButton: true,
      confirmButtonText: "Si",
      cancelButtonText: "No"
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/v1/Tratamiento/${idTratamiento}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken }
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.success) {
            $('#tbl').DataTable().row(fila).remove().draw();
            Swal.fire("Eliminado", "", "success");
          } else {
            Swal.fire("Error", data.error, "error");
          }
        })
        .catch(err => Swal.fire("Error", "No se pudo eliminar", "error"));
      }
    });
  });
};

// --- Inicialización ---
const addEvents = () => {
  agregar();
  guardar();
  editar();
  eliminar();
  buscarMedico();
  buscarPaciente();
};

$(function() {
  initDatatable();
  initDatatableMedico();
  initDatatablePaciente();
  addEvents();
});
</script>
{% endblock %}