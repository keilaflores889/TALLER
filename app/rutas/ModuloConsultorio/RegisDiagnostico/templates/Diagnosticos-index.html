{% extends 'base.html' %}

{% block titulo %}
Diagnósticos
{% endblock %}

{% block contenido %}
<div class="container mt-4">
  <h3>Listar Diagnósticos</h3>

  <!-- Tarjeta -->
  <div class="card">
    <div class="card-header">
      <button type="button" class="btn btn-outline-info" id="btnAgregar">Agregar</button>
    </div>
    <div class="card-body">

      <!-- Contenedor con scroll horizontal -->
      <div style="overflow-x: auto; white-space: nowrap;">
        <table class="table table-striped" id="tbl">
          <thead class="table-info">
            <tr>
              <th>ID Consulta</th>
              <th>Médico</th>
              <th>Paciente</th>
              <th>Tipo Diagnóstico</th>
              <th>Descripción</th>
              <th>Fecha</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
    </div>
  </div>

  <!-- Modal Formulario Diagnóstico -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
      <div class="modal-content">
        
        <!-- Header -->
        <div class="modal-header table-info d-flex justify-content-between align-items-center">
          <h4 class="modal-title" id="modalTitle">Nuevo Diagnóstico</h4>
          <button type="button" class="close ml-2" data-dismiss="modal">&times;</button>
        </div>

        <!-- Cuerpo del modal -->
        <div class="modal-body">
          <input type="hidden" id="txtIdDiagnostico">

          <div class="row">
            <!-- ID Consulta Detalle -->
            <div class="col-md-6">
              <div class="form-group">
                <label>ID Consulta Detalle: <span class="text-danger">*</span></label>
                <input type="number" id="id_consulta_detalle" class="form-control" placeholder="Ingrese ID de consulta">
              </div>
            </div>

            <!-- Médico -->
            <div class="col-md-6">
              <div class="form-group">
                <input type="hidden" id="id_medico">
                <label>Médico: <span class="text-danger">*</span></label>
                <input type="text" id="txtMedico" class="form-control" placeholder="Click para seleccionar Médico" readonly>
              </div>
            </div>

            <!-- Paciente -->
            <div class="col-md-6">
              <div class="form-group">
                <input type="hidden" id="id_paciente">
                <label>Paciente: <span class="text-danger">*</span></label>
                <input type="text" id="txtPaciente" class="form-control" placeholder="Click para seleccionar Paciente" readonly>
              </div>
            </div>

            <!-- Tipo Diagnóstico -->
            <div class="col-md-6">
              <div class="form-group">
                <input type="hidden" id="id_tipo_diagnostico">
                <label>Tipo Diagnóstico:</label>
                <input type="text" id="txtTipoDiagnostico" class="form-control" placeholder="Click para seleccionar Tipo" readonly>
              </div>
            </div>

            <!-- Descripción Diagnóstico -->
            <div class="col-md-12">
              <div class="form-group">
                <label>Descripción Diagnóstico: <span class="text-danger">*</span></label>
                <textarea id="descripcion_diagnostico" class="form-control" rows="3" placeholder="Ingrese descripción del diagnóstico"></textarea>
              </div>
            </div>

            <!-- Fecha Diagnóstico -->
            <div class="col-md-6">
              <div class="form-group">
                <label>Fecha Diagnóstico:</label>
                <input type="date" id="fecha_diagnostico" class="form-control">
              </div>
            </div>

            <!-- Observaciones -->
            <div class="col-md-12">
              <div class="form-group">
                <label>Observaciones:</label>
                <textarea id="observaciones" class="form-control" rows="3" placeholder="Observaciones adicionales (opcional)"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer fijo -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal Médico -->
  <div class="modal fade" id="modalBuscarMedico" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Médico</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblMedico">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Paciente -->
  <div class="modal fade" id="modalBuscarPaciente" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Paciente</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblPaciente">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Documento</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tipo Diagnóstico -->
  <div class="modal fade" id="modalBuscarTipoDiagnostico" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Tipo Diagnóstico</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblTipoDiagnostico">
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Librerías necesarias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

// --- Tabla principal Diagnósticos ---
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/Diagnostico',
    columns: [
      { data: 'id_consulta_detalle' },
      { data: 'medico_nombre' },
      { data: 'paciente_nombre' },
      { data: 'tipo_diagnostico' },
      { 
        data: 'descripcion_diagnostico',
        render: function(data) {
          return data && data.length > 50 ? data.substring(0, 50) + '...' : data;
        }
      },
      {
        data: 'fecha_diagnostico',
        render: function(data) {
          if (!data) return '';
          const d = new Date(data);
          if (isNaN(d)) return '';
          const day = String(d.getUTCDate()).padStart(2, '0');
          const month = String(d.getUTCMonth() + 1).padStart(2, '0');
          const year = d.getUTCFullYear();
          return `${day}/${month}/${year}`;
        }
      },
      { 
        data: 'observaciones',
        render: function(data) {
          return data && data.length > 30 ? data.substring(0, 30) + '...' : (data || '');
        }
      },
      {
        data: function(row) {
          return `
          <button type="button" name="btn_editar" class="btn btn-info btn-sm" data-id="${row.id_diagnostico}" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" name="btn_eliminar" class="btn btn-danger btn-sm" data-id="${row.id_diagnostico}" title="Eliminar">
            <i class="fas fa-trash-alt"></i>
          </button>`;
        }
      }
    ]
  });
};

// --- Modal Médico ---
const initDatatableMedico = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/medico',
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_medico" class="btn btn-primary" data-id="${row.id_medico}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblMedico').on('click', 'button[name="btn_seleccionar_medico"]', function() {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    $('#id_medico').val(id);
    $('#txtMedico').val(`${nombre} ${apellido}`);
    $('#modalBuscarMedico').modal('hide');
  });
};

// --- Modal Paciente ---
const initDatatablePaciente = () => {
  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/paciente',
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_paciente" class="btn btn-primary" data-id="${row.id_paciente}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblPaciente').on('click', 'button[name="btn_seleccionar_paciente"]', function() {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    $('#id_paciente').val(id);
    $('#txtPaciente').val(`${nombre} ${apellido}`);
    $('#modalBuscarPaciente').modal('hide');
  });
};

// --- Modal Tipo Diagnóstico ---
const initDatatableTipoDiagnostico = () => {
  $('#tblTipoDiagnostico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/diagnosticos',
    columns: [
      { data: 'tipo_diagnostico' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_tipo" class="btn btn-primary" data-id="${row.id_tipo_diagnostico}" data-tipo_diagnostico="${row.tipo_diagnostico}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblTipoDiagnostico').on('click', 'button[name="btn_seleccionar_tipo"]', function() {
    const id = $(this).data('id');
    const tipo_diagnostico = $(this).data('tipo_diagnostico');
    $('#id_tipo_diagnostico').val(id);
    $('#txtTipoDiagnostico').val(tipo_diagnostico);
    $('#modalBuscarTipoDiagnostico').modal('hide');
  });
};

// --- Apertura de modales ---
const buscarMedico = () => $('#txtMedico').on('click', () => $('#modalBuscarMedico').modal());
const buscarPaciente = () => $('#txtPaciente').on('click', () => $('#modalBuscarPaciente').modal());
const buscarTipoDiagnostico = () => $('#txtTipoDiagnostico').on('click', () => $('#modalBuscarTipoDiagnostico').modal());

// --- Agregar ---
const agregar = () => {
  $('#btnAgregar').on('click', () => {
    $('#modalTitle').text("Agregar Diagnóstico");
    $('#txtIdDiagnostico, #id_consulta_detalle, #txtMedico, #txtPaciente, #txtTipoDiagnostico, #descripcion_diagnostico, #fecha_diagnostico, #observaciones').val("");
    $('#id_medico, #id_paciente, #id_tipo_diagnostico').val("");
    $('#modalFormulario').modal();
  });
};

// --- Guardar ---
const guardar = () => $('#btnGuardar').on('click', function() {
  const idDiagnostico = $('#txtIdDiagnostico').val();

  const payload = {
    id_consulta_detalle: parseInt($('#id_consulta_detalle').val()),
    id_medico: parseInt($('#id_medico').val()),
    id_paciente: parseInt($('#id_paciente').val()),
    id_tipo_diagnostico: $('#id_tipo_diagnostico').val() ? parseInt($('#id_tipo_diagnostico').val()) : null,
    descripcion_diagnostico: $('#descripcion_diagnostico').val(),
    fecha_diagnostico: $('#fecha_diagnostico').val() || null,
    observaciones: $('#observaciones').val() || null
  };

  if (!payload.id_consulta_detalle || !payload.id_medico || !payload.id_paciente || !payload.descripcion_diagnostico) {
    Swal.fire("Error", "Complete los campos obligatorios (Consulta, Médico, Paciente y Descripción)", "error");
    return;
  }

  const tabla = $('#tbl').DataTable();
  const method = idDiagnostico ? 'PUT' : 'POST';
  const url = idDiagnostico ? `/api/v1/Diagnostico/${idDiagnostico}` : '/api/v1/Diagnostico';

  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
    body: JSON.stringify(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      tabla.ajax.reload();
      Swal.fire(idDiagnostico ? "Actualizado" : "Registrado", "Diagnóstico guardado correctamente.", "success");
      $('#modalFormulario').modal("hide");
    } else {
      Swal.fire("Error", data.error, "error");
    }
  })
  .catch(err => Swal.fire("Error", "Ocurrió un error al guardar el diagnóstico.", "error"));
});

// --- Editar ---
const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function() {
    const idDiagnostico = $(this).data('id');

    fetch(`/api/v1/Diagnostico/${idDiagnostico}`)
      .then(resp => resp.json())
      .then(data => {
        const d = data.data;

        $('#txtIdDiagnostico').val(d.id_diagnostico);
        $('#id_consulta_detalle').val(d.id_consulta_detalle);
        $('#id_medico').val(d.id_medico);
        $('#txtMedico').val(d.medico_nombre);
        $('#id_paciente').val(d.id_paciente);
        $('#txtPaciente').val(d.paciente_nombre);
        $('#id_tipo_diagnostico').val(d.id_tipo_diagnostico || "");
        $('#txtTipoDiagnostico').val(d.tipo_diagnostico || "");
        $('#descripcion_diagnostico').val(d.descripcion_diagnostico);
        $('#fecha_diagnostico').val(formatDateForInput(d.fecha_diagnostico));
        $('#observaciones').val(d.observaciones || "");

        $('#modalTitle').text("Editar Diagnóstico");
        $('#modalFormulario').modal();
      })
      .catch(err => Swal.fire("Error", "No se pudo cargar el diagnóstico", "error"));
  });
};

// --- Eliminar ---
const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
    const idDiagnostico = $(this).data('id');
    const fila = $(this).closest('tr');

    Swal.fire({
      title: "¿Deseas eliminar este diagnóstico?",
      showCancelButton: true,
      confirmButtonText: "Si",
      cancelButtonText: "No"
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/v1/Diagnostico/${idDiagnostico}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken }
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.success) {
            $('#tbl').DataTable().row(fila).remove().draw();
            Swal.fire("Eliminado", "", "success");
          } else {
            Swal.fire("Error", data.error, "error");
          }
        })
        .catch(err => Swal.fire("Error", "No se pudo eliminar", "error"));
      }
    });
  });
};

// --- Inicialización ---
const addEvents = () => {
  agregar();
  guardar();
  editar();
  eliminar();
  buscarMedico();
  buscarPaciente();
  buscarTipoDiagnostico();
};

$(function() {
  initDatatable();
  initDatatableMedico();
  initDatatablePaciente();
  initDatatableTipoDiagnostico();
  addEvents();
});
</script>
{% endblock %}