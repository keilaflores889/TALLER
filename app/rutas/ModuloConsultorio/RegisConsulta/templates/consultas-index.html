{% extends 'base.html' %}

{% block titulo %}
Consultas M√©dicas
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

  <!-- Tarjetas de estad√≠sticas -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                Consultas de Hoy
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="consultasHoy">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                En Seguimiento
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="consultasEnSeguimiento">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Finalizadas
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="consultasFinalizadas">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                Total Consultas
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalConsultas">0</div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">
    <!-- Header: Bot√≥n Agregar y T√≠tulo -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-light btn-sm" id="btnAgregar">
        <i class="fas fa-plus-circle mr-1"></i> Agregar Consulta
      </button>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-stethoscope mr-2"></i> Gesti√≥n de Consultas M√©dicas
      </h5>
    </div>

    <!-- Body: Tabla de consultas -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered align-middle text-center" id="tbl">
          <thead class="bg-info text-white">
            <tr>
              <th>Personal</th>
              <th>Consultorio</th>
              <th>Fecha Cita</th>
              <th>Hora Cita</th>
              <th>Paciente</th>
              <th>M√©dico</th>
              <th>Duraci√≥n (min)</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- =========================== -->
<!-- Modal Formulario Consulta -->
<!-- =========================== -->
<div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content shadow-lg border-0 rounded-lg">

      <!-- Header -->
      <div class="modal-header bg-info text-white rounded-top d-flex justify-content-between align-items-center">
        <h5 class="modal-title font-weight-bold">
          <i class="fas fa-stethoscope mr-2"></i> <span id="modalTitle">Nueva Consulta</span>
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <input type="hidden" id="txtIdConsulta">

              <div class="row">
        <!-- Personal -->
        <div class="col-md-6 mb-3">
          <input type="hidden" id="id_personal">
          <label class="font-weight-bold">
            <i class="fas fa-user-tie label-icon"></i>Personal: <span style="color:red">*</span>
          </label>
          <input type="text" id="txtPersonal" class="form-control" placeholder="Click para seleccionar Personal" readonly required>
          <div class="text-danger small" id="error_txtPersonal" style="display:none;">Campo obligatorio</div>
        </div>

        <!-- Consultorio -->
        <div class="col-md-6 mb-3">
          <input type="hidden" id="id_consultorio">
          <label class="font-weight-bold">
            <i class="fas fa-door-open label-icon"></i>Consultorio: <span style="color:red">*</span>
          </label>
          <input type="text" id="txtConsultorio" class="form-control" placeholder="Click para seleccionar Consultorio" readonly required>
          <div class="text-danger small" id="error_txtConsultorio" style="display:none;">Campo obligatorio</div>
        </div>

        <!-- M√©dico -->
        <div class="col-md-6 mb-3">
          <input type="hidden" id="id_medico">
          <label class="font-weight-bold">
            <i class="fas fa-user-md label-icon"></i>M√©dico: <span style="color:red">*</span>
          </label>
          <input type="text" id="txtMedico" class="form-control" placeholder="Click para seleccionar M√©dico" readonly required>
          <div class="text-danger small" id="error_txtMedico" style="display:none;">Campo obligatorio</div>
        </div>

        <!-- Paciente -->
        <div class="col-md-6 mb-3">
          <input type="hidden" id="id_paciente">
          <label class="font-weight-bold">
            <i class="fas fa-user-injured label-icon"></i>Paciente: <span style="color:red">*</span>
          </label>
          <input type="text" id="txtPaciente" class="form-control" placeholder="Click para seleccionar Paciente" readonly required>
          <div class="text-danger small" id="error_txtPaciente" style="display:none;">Campo obligatorio</div>
        </div>

        <!-- Fecha Cita -->
        <div class="col-md-6 mb-3">
          <label class="font-weight-bold">
            <i class="fas fa-calendar-alt label-icon"></i>Fecha Cita: <span style="color:red">*</span>
          </label>
          <input type="date" id="fecha_cita" class="form-control" required>
          <div class="text-danger small" id="error_fecha_cita" style="display:none;">Campo obligatorio</div>
        </div>

        <!-- Hora Cita -->
        <div class="col-md-6 mb-3">
          <label class="font-weight-bold">
            <i class="fas fa-clock label-icon"></i>Hora Cita: <span style="color:red">*</span>
          </label>
          <div class="input-group">
            <input type="number" id="hora_input" class="form-control" placeholder="HH" min="1" max="12" style="max-width: 70px;">
            <span class="input-group-text">:</span>
            <input type="number" id="minuto_input" class="form-control" placeholder="MM" min="0" max="59" style="max-width: 70px;">
            <select id="ampm_input" class="form-control" style="max-width: 80px;">
              <option value="a.m">a.m</option>
              <option value="p.m">p.m</option>
            </select>
          </div>
          <small class="text-muted">Formato: HH:MM AM/PM</small>
          <div class="text-danger small" id="error_hora_cita" style="display:none;">Campo obligatorio</div>
        </div>

        <!-- Duraci√≥n -->
        <div class="col-md-6 mb-3">
          <label class="font-weight-bold">
            <i class="fas fa-hourglass-half label-icon"></i>Duraci√≥n (minutos):
          </label>
          <input type="number" id="duracion_minutos" class="form-control" placeholder="30" min="1">
        </div>

        <!-- Estado -->
        <div class="col-md-6 mb-3">
          <label class="font-weight-bold">
            <i class="fas fa-info-circle label-icon"></i>Estado:
          </label>
          <select id="estado" class="form-control">
            <option value="programada">Programada</option>
            <option value="en_proceso">En Proceso</option>
            <option value="finalizada">Finalizada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>
      </div>
    </div>
  
      <!-- Footer -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-info" id="btnGuardar">
          <i class="fas fa-save mr-1"></i> Guardar
        </button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">
          <i class="fas fa-times mr-1"></i> Cerrar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal Detalles de Consulta (ACTUALIZADO) -->
<div class="modal fade" id="modalDetalles" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header table-success">
        <h4 class="modal-title">Detalles de Consulta</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="idConsultaDetalle">
        
        <!-- Informaci√≥n de la consulta -->
        <div class="alert alert-info">
          <strong>üìã Informaci√≥n de la Consulta</strong><br>
          <span id="infoConsulta"></span>
        </div>

        <!-- BOTONES PRINCIPALES -->
        <div class="mb-3">
          <button type="button" class="btn btn-outline-primary btn-sm" id="btnGestionarDiagnosticos">
            <i class="fas fa-stethoscope"></i> Registrar Diagn√≥sticos
          </button>
          <button type="button" class="btn btn-outline-success btn-sm" id="btnRegistrarTratamientos">
            <i class="fas fa-notes-medical"></i> Registrar Tratamientos
          </button>
          <button type="button" class="btn btn-warning btn-sm" id="btnAbrirOdontograma">
            <i class="fas fa-tooth"></i> Ver Odontograma
          </button>
          <!--<button type="button" class="btn btn-primary btn-sm" id="btnGenerarFichaMedica">
          <i class="fas fa-file-medical"></i> Generar Ficha M√©dica
        </button>-->
        </div>

        <hr>
        <h5>Agregar Detalle Cl√≠nico</h5>
        
        <div class="row">
          <!-- S√≠ntoma -->
          <div class="col-md-6">
          <div class="form-group">
            <input type="hidden" id="id_sintoma">
            <label>
              <i class="fas fa-heartbeat label-icon"></i>S√≠ntoma: <span style="color:red">*</span>
            </label>
            <input type="text" id="txtSintoma" class="form-control" placeholder="Click para seleccionar S√≠ntoma" readonly required>
            <div class="text-danger small" id="error_txtSintoma" style="display:none;">Campo obligatorio</div>
          </div>
        </div>

        <!-- Pieza Dental -->
        <div class="col-md-6">
          <div class="form-group">
            <label>
              <i class="fas fa-tooth label-icon"></i>Pieza Dental: <span style="color:red">*</span>
            </label>
            <input type="text" id="pieza_dental" class="form-control" placeholder="Ej: 18, 21, 4.6">
          </div>
        </div>

        <!-- Diagn√≥stico -->
        <div class="col-md-12">
          <div class="form-group">
            <label>
              <i class="fas fa-stethoscope label-icon"></i>Diagn√≥stico: <span style="color:red">*</span>
            </label>
            <textarea id="diagnostico" class="form-control" rows="2" placeholder="Diagn√≥stico general..." required></textarea>
            <div class="text-danger small" id="error_diagnostico" style="display:none;">Campo obligatorio</div>
          </div>
        </div>

        <!-- Tipo de Diagn√≥stico -->
        <div class="col-md-12">
          <div class="form-group">
            <label>
              <i class="fas fa-clipboard-list label-icon"></i>Tipo de Diagn√≥stico: <span style="color:red">*</span>
            </label>
            <input type="hidden" id="id_tipo_diagnostico">
            <input type="text" id="txtTipoDiagnostico" class="form-control" placeholder="Click para seleccionar Tipo de Diagn√≥stico" readonly style="cursor: pointer;">
            <div class="text-danger small" id="error_tipo_diagnostico" style="display:none;">Campo obligatorio</div>
          </div>
        </div>

        <!-- Tratamiento -->
        <div class="col-md-12">
          <div class="form-group">
            <label>
              <i class="fas fa-pills label-icon"></i>Tratamiento: <span style="color:red">*</span>
            </label>
            <textarea id="tratamiento" class="form-control" rows="2" placeholder="Tratamiento general..." required></textarea>
            <div class="text-danger small" id="error_tratamiento" style="display:none;">Campo obligatorio</div>
          </div>
        </div>

        <!-- Procedimiento -->
        <div class="col-md-12">
          <div class="form-group">
            <label>
              <i class="fas fa-procedures label-icon"></i>Procedimiento: <span style="color:red">*</span>
            </label>
            <textarea id="procedimiento" class="form-control" rows="2" placeholder="Procedimiento realizado..."></textarea>
          </div>
        </div>
      
        <!-- Tipo de Procedimiento -->
        <div class="col-md-12">
          <div class="form-group">
            <label>
              <i class="fas fa-tasks label-icon"></i>Tipo de Procedimiento: <span style="color:red">*</span>
            </label>
            <input type="hidden" id="id_tipo_procedimiento">
            <input type="text" id="txtTipoProcedimiento" class="form-control" placeholder="Click para seleccionar Tipo de Procedimiento" readonly style="cursor: pointer;">
            <div class="text-danger small" id="error_tipo_procedimiento" style="display:none;">Campo obligatorio</div>
          </div>
        </div>
       </div>

        <button type="button" class="btn btn-success mb-3" id="btnAgregarDetalle">
          <i class="fas fa-plus"></i> Agregar Detalle
        </button>

        <!-- Lista de detalles agregados -->
        <hr>
        <h5>Detalles Registrados</h5>
        <div class="table-responsive">
          <table class="table table-sm table-bordered" id="tblDetalles">
            <thead class="table-secondary">
              <tr>
                <th>S√≠ntoma</th>
                <th>Pieza Dental</th>
                <th>Diagn√≥stico</th>
                <th>Tipo diagnostico</th>
                <th>Tratamiento</th>
                <th>Procedimiento</th>
                <th>Tipo de procedimiento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- NUEVO: Modal Gestionar Diagn√≥sticos -->
<div class="modal fade" id="modalGestionarDiagnosticos" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #E3F2FD;">
        <h4 class="modal-title">
          <i class="fas fa-stethoscope"></i> Registrar Diagn√≥sticos
        </h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="id_tipo_diagnostico_principal">
        
        <!-- Informaci√≥n del paciente y m√©dico -->
        <div class="card mb-3" style="background-color: #E3F2FD;">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <strong><i class="fas fa-hospital-user"></i> PACIENTE</strong><br>
                <span id="diag_paciente_nombre"></span><br>
                <small class="text-muted" id="diag_paciente_info"></small>
              </div>
              <div class="col-md-4">
                <strong><i class="fas fa-user-md"></i> M√âDICO</strong><br>
                <span id="diag_medico_nombre"></span><br>
                <small class="text-muted" id="diag_medico_info"></small>
              </div>
              <div class="col-md-4">
                <strong><i class="fas fa-calendar-check"></i> CONSULTA</strong><br>
                <span id="diag_consulta_fecha"></span><br>
                <small class="text-muted" id="diag_consulta_info"></small>
              </div>
            </div>
          </div>
        </div>

        <!-- Diagn√≥stico Principal -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <h5 class="fas fa-stethoscope label-icon"> Diagn√≥stico Principal </h5>
          </div>
          <div class="card-body">
            <div class="form-group">
              <!--<label >Diagn√≥stico principal:</label>-->
              <textarea id="diagnostico_principal" class="form-control" rows="3"></textarea>
              <div class="form-group">
              <label>
                <i class="fas fa-clipboard-list label-icon"></i> Tipo de Diagn√≥stico:
              </label>
              <input type="text" id="txtTipoDiagnosticoPrincipal" class="form-control" 
                    placeholder="Click para seleccionar Tipo de Diagn√≥stico" 
                    readonly style="cursor: pointer;">
              <div class="text-danger small" id="error_tipo_diagnostico_principal" style="display:none;">
                Campo obligatorio
              </div>
            </div>
            </div>
            <button type="button" class="btn btn-primary" id="btnGuardarDiagnosticoPrincipal">
              <i class="fas fa-save"></i> Guardar Diagn√≥stico Principal
            </button>
          </div>
        </div>
        <!-- Mensaje informativo -->
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> 
          Los diagnosticos detallados se implementar√°n en la siguiente fase del sistema.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="$('#modalGestionarDiagnosticos').modal('hide');">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- NUEVO: Modal Registrar Tratamientos -->
<div class="modal fade" id="modalRegistrarTratamientos" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #FFF3E0;">
        <h4 class="modal-title">
          <i class="fas fa-notes-medical"></i> Registrar Tratamientos
        </h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Informaci√≥n del paciente y m√©dico -->
        <div class="card mb-3" style="background-color: #FFF3E0;">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <strong><i class="fas fa-hospital-user"></i> PACIENTE</strong><br>
                <span id="trat_paciente_nombre"></span><br>
                <small class="text-muted" id="trat_paciente_info"></small>
              </div>
              <div class="col-md-4">
                <strong><i class="fas fa-user-md"></i> M√âDICO</strong><br>
                <span id="trat_medico_nombre"></span><br>
                <small class="text-muted" id="trat_medico_info"></small>
              </div>
              <div class="col-md-4">
                <strong><i class="fas fa-calendar-check"></i> CONSULTA</strong><br>
                <span id="trat_consulta_fecha"></span><br>
                <small class="text-muted" id="trat_consulta_info"></small>
              </div>
            </div>
          </div>
        </div>

        <!-- Tratamiento Principal -->
        <div class="card mb-3">
          <div class="card-header" style="background-color: #FF9800; color: white;">
            <h5 class="fas fa-pills label-icon"> Tratamiento Principal </h5>
          </div>
          <div class="card-body">
            <div class="form-group">
               <!--<label>Tratamiento principal:</label>-->
              <textarea id="tratamiento_principal" class="form-control" rows="3"></textarea>
            </div>
            <button type="button" class="btn btn-warning" id="btnGuardarTratamientoPrincipal">
              <i class="fas fa-save"></i> Guardar Tratamiento Principal
            </button>
          </div>
        </div>

        <!-- Mensaje informativo -->
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> 
          Los tratamientos detallados se implementar√°n en la siguiente fase del sistema.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="$('#modalRegistrarTratamientos').modal('hide');">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modales de selecci√≥n (MISMO C√ìDIGO ANTERIOR) -->
<!-- Modal Personal -->
<div class="modal fade" id="modalBuscarPersonal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar Personal</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblPersonal">
            <thead class="bg-info text-white">
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Consultorio -->
<div class="modal fade" id="modalBuscarConsultorio" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar Consultorio</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblConsultorio">
            <thead class="bg-info text-white">
              <tr>
                <th>Consultorio</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal M√©dico -->
<div class="modal fade" id="modalBuscarMedico" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar M√©dico</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblMedico">
            <thead class="bg-info text-white">
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Paciente -->
<div class="modal fade" id="modalBuscarPaciente" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar Paciente</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblPaciente">
            <thead class="bg-info text-white">
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>C√©dula</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal S√≠ntoma -->
<div class="modal fade" id="modalBuscarSintoma" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar S√≠ntoma</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblSintoma">
            <thead class="bg-info text-white">
              <tr>
                <th>Sintomas</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tipo Diagn√≥stico -->
<div class="modal fade" id="modalBuscarTipoDiagnostico" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar Tipo de Diagn√≥stico</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblTipoDiagnostico">
            <thead class="bg-info text-white">
              <tr>
                <th>Tipo de Diagn√≥stico</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tipo Procedimiento -->
<!-- Modal Tipo Procedimiento -->
<div class="modal fade" id="modalBuscarTipoProcedimiento" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h4 class="modal-title">Seleccionar Tipo de Procedimiento</h4>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblTipoProcedimiento">
            <thead class="bg-info text-white">
              <tr>
                <th>Tipo de Procedimiento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Librer√≠as -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<style>
.border-left-primary {
  border-left: 0.25rem solid #4e73df !important;
}
.border-left-success {
  border-left: 0.25rem solid #1cc88a !important;
}
.border-left-info {
  border-left: 0.25rem solid #36b9cc !important;
}
.border-left-warning {
  border-left: 0.25rem solid #f6c23e !important;
}
</style>
{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

let consultaActualId = null;
let detalleEditandoId = null;
let consultaDetalleActualId = null;
let idMedicoActual = null;  // NUEVO
let idPacienteActual = null; // NUEVO

let isSubmittingDetalle = false;
let isSubmittingDiagnostico = false;
let isSubmittingTratamiento = false;

// Convertir hora 12h a 24h
function convertTo24Hour(hora, minuto, ampm) {
  let hour24 = parseInt(hora);
  
  if (ampm === 'p.m' && hour24 !== 12) {
    hour24 += 12;
  } else if (ampm === 'a.m' && hour24 === 12) {
    hour24 = 0;
  }
  
  const h = String(hour24).padStart(2, '0');
  const m = String(minuto).padStart(2, '0');
  return `${h}:${m}`;
}

// Convertir hora 24h a 12h con AM/PM
function convertTo12Hour(time24) {
  if (!time24) return { hora: '', minuto: '', ampm: 'a.m' };
  
  const [hours, minutes] = time24.split(':');
  let hour = parseInt(hours);
  const ampm = hour >= 12 ? 'p.m' : 'a.m';
  
  hour = hour % 12;
  hour = hour ? hour : 12;
  
  return {
    hora: hour,
    minuto: parseInt(minutes),
    ampm: ampm
  };
}

// Formatear para mostrar
function formatTimeToAMPM(time24) {
  if (!time24) return '';
  const time = convertTo12Hour(time24);
  const h = String(time.hora).padStart(2, '0');
  const m = String(time.minuto).padStart(2, '0');
  return `${h}:${m} ${time.ampm}`;
}


// --- Formato de fecha ---
function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

function formatDateForDisplay(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${day}/${month}/${year}`;
}

// --- Actualizar estad√≠sticas ---
function actualizarEstadisticas() {
  fetch('/api/v1/consultas')
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const consultas = d.data;
        const hoy = new Date().toISOString().split('T')[0];
        
        const consultasHoy = consultas.filter(c => c.fecha_cita === hoy).length;
        $('#consultasHoy').text(consultasHoy);
        
        const enSeguimiento = consultas.filter(c => 
          c.estado === 'programada' || c.estado === 'en_proceso'
        ).length;
        $('#consultasEnSeguimiento').text(enSeguimiento);
        
        const finalizadas = consultas.filter(c => c.estado === 'finalizada').length;
        $('#consultasFinalizadas').text(finalizadas);
        
        $('#totalConsultas').text(consultas.length);
      }
    });
}

// --- Tabla principal Consultas ---
const initDatatable = () => {
  if ($.fn.DataTable.isDataTable('#tbl')) {
    $('#tbl').DataTable().destroy();
  }

  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/consultas', dataSrc: 'data' },
    columns: [
      { data: 'nombre_personal',width: "100px" },
      { data: 'nombre_consultorio',width: "100px" },
      { data: 'fecha_cita',width: "100px", render: d => formatDateForDisplay(d) },
      { 
        data: 'hora_cita', 
        width: "100px",
        render: d => formatTimeToAMPM(d)  // ‚úÖ Mostrar en formato 12h
      },
      { data: 'nombre_paciente',width: "100px"  },
      { data: 'nombre_medico',width: "100px" },
      { data: 'duracion_minutos', render: d => d || 'N/A',width: "100px" },
      { 
        data: 'estado',width: "100px",
        render: d => {
          let color = '#155724', bg = '#d4edda';
          if (d === 'cancelada') { color = '#721c24'; bg = '#f8d7da'; }
          if (d === 'en_proceso') { color = '#856404'; bg = '#fff3cd'; }
          if (d === 'programada') { color = '#004085'; bg = '#cce5ff'; }
          return `<span style="color:${color}; background-color:${bg}; padding:2px 6px; border-radius:4px;">${d}</span>`;
        }
      },
      { 
        data: row => `
          <button class="btn btn-success btn-sm" name="btn_detalles" data-id="${row.id_consulta_cab}" title="Ver Detalles">
            <i class="fas fa-eye"></i>
          </button>

          <button class="btn btn-info btn-sm" name="btn_editar" data-id="${row.id_consulta_cab}" title="Editar">
            <i class="fas fa-edit"></i>
          </button>

          <!-- ü©∫ Nuevo bot√≥n para generar ficha m√©dica -->
          <button class="btn btn-warning btn-sm" name="btn_ficha" data-id-paciente="${row.id_paciente}" title="Generar Ficha M√©dica">
            <i class="fas fa-file-medical"></i>
          </button>

          <button class="btn btn-danger btn-sm" name="btn_eliminar" data-id="${row.id_consulta_cab}" title="Eliminar">
            <i class="fas fa-trash-alt"></i>
          </button>
        `,
         width: "150px" 
      }
    ],
    drawCallback: function() {
      actualizarEstadisticas();
    }
  });
};

// --- Modales de selecci√≥n ---
const initDatatablePersonal = () => {
  $('#tblPersonal').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/personal', dataSrc: 'data' },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_personal"
          data-id="${row.id_personal}"
          data-nombre="${row.nombre}"
          data-apellido="${row.apellido}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>`,
       className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblPersonal').on('click', 'button[name="btn_seleccionar_personal"]', function() {
    $('#id_personal').val($(this).data('id'));
    $('#txtPersonal').val(`${$(this).data('nombre')} ${$(this).data('apellido')}`);
    $('#modalBuscarPersonal').modal('hide');
  });
};

const initDatatableConsultorio = () => {
  $('#tblConsultorio').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/consultorios', dataSrc: 'data' },
    columns: [
      { data: 'nombre_consultorio' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_consultorio"
          data-id="${row.codigo}"
          data-nombre_consultorio="${row.nombre_consultorio}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>`,
        className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblConsultorio').on('click', 'button[name="btn_seleccionar_consultorio"]', function() {
    $('#id_consultorio').val($(this).data('id'));
    $('#txtConsultorio').val($(this).data('nombre_consultorio'));
    $('#modalBuscarConsultorio').modal('hide');
  });
};

const initDatatableMedico = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/medico', dataSrc: 'data' },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_medico"
          data-id="${row.id_medico}"
          data-nombre="${row.nombre}"
          data-apellido="${row.apellido}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>`,
        className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblMedico').on('click', 'button[name="btn_seleccionar_medico"]', function() {
    $('#id_medico').val($(this).data('id'));
    $('#txtMedico').val(`${$(this).data('nombre')} ${$(this).data('apellido')}`);
    $('#modalBuscarMedico').modal('hide');
  });
};

const initDatatablePaciente = () => {
  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/paciente', dataSrc: 'data' },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula_entidad' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_paciente"
          data-id="${row.id_paciente}"
          data-nombre="${row.nombre}"
          data-apellido="${row.apellido}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>` ,
        className: 'text-center',
        orderable: false
      }
      
    ]
  });

  $('#tblPaciente').on('click', 'button[name="btn_seleccionar_paciente"]', function() {
    $('#id_paciente').val($(this).data('id'));
    $('#txtPaciente').val(`${$(this).data('nombre')} ${$(this).data('apellido')}`);
    $('#modalBuscarPaciente').modal('hide');
  });
};

const initDatatableSintoma = () => {
  $('#tblSintoma').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/sintomas', dataSrc: 'data' },
    columns: [
      { data: 'descripcion_sintoma' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_sintoma"
          data-id="${row.id_sintoma}"
          data-descripcion_sintoma="${row.descripcion_sintoma}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>`, 
      className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblSintoma').on('click', 'button[name="btn_seleccionar_sintoma"]', function() {
    $('#id_sintoma').val($(this).data('id'));
    $('#txtSintoma').val($(this).data('descripcion_sintoma'));
    $('#modalBuscarSintoma').modal('hide');
  });
};


const initDatatableTipoDiagnostico = () => {
  $('#tblTipoDiagnostico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/diagnosticos', dataSrc: 'data' },
    columns: [
      { data: 'tipo_diagnostico' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_tipo_diag"
          data-id="${row.id_tipo_diagnostico}"
          data-descripcion="${row.tipo_diagnostico}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>`,
       className: 'text-center',
        orderable: false
      }
    ]
  });

    $('#tblTipoDiagnostico').on('click', 'button[name="btn_seleccionar_tipo_diag"]', function() {
    const modalAbierto = $('.modal.show').attr('id');
    
    if (modalAbierto === 'modalGestionarDiagnosticos') {
      // Si estamos en el modal de diagn√≥sticos principales
      $('#id_tipo_diagnostico_principal').val($(this).data('id'));
      $('#txtTipoDiagnosticoPrincipal').val($(this).data('descripcion'));
    } else {
      // Si estamos en el modal de detalles
      $('#id_tipo_diagnostico').val($(this).data('id'));
      $('#txtTipoDiagnostico').val($(this).data('descripcion'));
    }
    
    $('#modalBuscarTipoDiagnostico').modal('hide');
  });
};


const initDatatableTipoProcedimiento = () => {
  if ($.fn.DataTable.isDataTable('#tblTipoProcedimiento')) {
    $('#tblTipoProcedimiento').DataTable().destroy();
  }
  
  $('#tblTipoProcedimiento').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { 
      url: '/api/v1/procedimientos',
      dataSrc: 'data' 
    },
    columns: [
      { data: 'procedimiento' },
      { data: null, render: row => `
        <button class="btn btn-warning btn-sm" name="btn_seleccionar_tipo_proc"
          data-id="${row.id_tipo_procedimiento}"
          data-procedimiento="${row.procedimiento}"><i class="fas fa-check mr-1"></i>
          Seleccionar
        </button>`, 
        className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblTipoProcedimiento').on('click', 'button[name="btn_seleccionar_tipo_proc"]', function() {
    $('#id_tipo_procedimiento').val($(this).data('id'));
    $('#txtTipoProcedimiento').val($(this).data('procedimiento'));
    $('#modalBuscarTipoProcedimiento').modal('hide');
  });
};

// --- Generar ficha m√©dica ---
$(document).on('click', 'button[name="btn_ficha"]', function() {
  const idPaciente = $(this).data('id-paciente');

  if (!idPaciente) {
    alert('‚ö†Ô∏è No se encontr√≥ el ID del paciente.');
    return;
  }

  // Abre la ficha m√©dica en una nueva pesta√±a o ventana
  window.open(`/api/v1/ficha-medica/${idPaciente}`, '_blank');
});

// Abrir modal
$('#txtTipoDiagnostico').click(() => $('#modalBuscarTipoDiagnostico').modal('show'));
$('#txtTipoProcedimiento').click(() => $('#modalBuscarTipoProcedimiento').modal('show'));

// --- Abrir modales de selecci√≥n ---
$('#txtPersonal').click(() => $('#modalBuscarPersonal').modal('show'));
$('#txtConsultorio').click(() => $('#modalBuscarConsultorio').modal('show'));
$('#txtMedico').click(() => $('#modalBuscarMedico').modal('show'));
$('#txtPaciente').click(() => $('#modalBuscarPaciente').modal('show'));
$('#txtSintoma').click(() => $('#modalBuscarSintoma').modal('show'));
$('#txtTipoDiagnosticoPrincipal').click(() => $('#modalBuscarTipoDiagnostico').modal('show'));

// --- Limpiar modales ---
function limpiarModal() {
  $('#txtIdConsulta, #txtPersonal, #txtConsultorio, #txtMedico, #txtPaciente, #fecha_cita, #duracion_minutos').val('');
  $('#id_personal, #id_consultorio, #id_medico, #id_paciente').val('');
  $('#hora_input, #minuto_input').val('');
  $('#ampm_input').val('a.m');
  $('#estado').val('programada');
  $('.text-danger.small').hide();
}

function limpiarModalDetalle() {
  $('#txtSintoma, #pieza_dental, #diagnostico, #tratamiento, #procedimiento, #txtTipoDiagnostico, #txtTipoProcedimiento').val('');
  $('#id_sintoma, #id_tipo_diagnostico, #id_tipo_procedimiento').val('');
  $('#error_txtSintoma, #error_diagnostico, #error_tratamiento, #error_tipo_diagnostico, #error_tipo_procedimiento').hide();
  detalleEditandoId = null;
  $('#btnAgregarDetalle').html('<i class="fas fa-plus"></i> Agregar Detalle');
}

// --- Guardar Consulta Cabecera ---
$('#btnGuardar').on('click', () => {
  const idConsulta = $('#txtIdConsulta').val();
  
  // Obtener hora, minuto y AM/PM
  const hora = $('#hora_input').val();
  const minuto = $('#minuto_input').val();
  const ampm = $('#ampm_input').val();
  
  // Convertir a formato 24 horas
  const hora24 = hora && minuto ? convertTo24Hour(hora, minuto, ampm) : null;
  
  const payload = {
    id_personal: parseInt($('#id_personal').val()),
    id_consultorio: parseInt($('#id_consultorio').val()),
    id_medico: parseInt($('#id_medico').val()),
    id_paciente: parseInt($('#id_paciente').val()),
    fecha_cita: $('#fecha_cita').val(),
    hora_cita: hora24,  // ‚úÖ Enviar en formato 24h al backend
    duracion_minutos: $('#duracion_minutos').val() ? parseInt($('#duracion_minutos').val()) : null,
    estado: $('#estado').val()
  };

  let valido = true;
  $('.text-danger.small').hide();
  
  if (!payload.id_personal) { $('#error_txtPersonal').show(); valido = false; }
  if (!payload.id_consultorio) { $('#error_txtConsultorio').show(); valido = false; }
  if (!payload.id_medico) { $('#error_txtMedico').show(); valido = false; }
  if (!payload.id_paciente) { $('#error_txtPaciente').show(); valido = false; }
  if (!payload.fecha_cita) { $('#error_fecha_cita').show(); valido = false; }
  if (!payload.hora_cita) { $('#error_hora_cita').show(); valido = false; }

  if (!valido) return;

  const url = idConsulta ? `/api/v1/consultas/${idConsulta}` : '/api/v1/consultas';
  const method = idConsulta ? 'PUT' : 'POST';

  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      $('#modalFormulario').modal('hide');
      $('#tbl').DataTable().ajax.reload();
      Swal.fire('√âxito', 'Consulta guardada correctamente', 'success');
    } else {
      Swal.fire('Error', d.error || 'No se pudo guardar', 'error');
    }
  });
});

// --- Abrir modal nuevo ---
$('#btnAgregar').on('click', () => {
  limpiarModal();
  $('#modalTitle').text('Nueva Consulta');
  $('#modalFormulario').modal('show');
});

// --- Editar ---
$('#tbl').on('click', 'button[name="btn_editar"]', function() {
  const id = $(this).data('id');
  fetch(`/api/v1/consultas/${id}`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const c = d.data;
        $('#txtIdConsulta').val(c.id_consulta_cab);
        $('#id_personal').val(c.id_personal);
        $('#txtPersonal').val(c.nombre_personal);
        $('#id_consultorio').val(c.id_consultorio);
        $('#txtConsultorio').val(c.nombre_consultorio);
        $('#id_medico').val(c.id_medico);
        $('#txtMedico').val(c.nombre_medico);
        $('#id_paciente').val(c.id_paciente);
        $('#txtPaciente').val(c.nombre_paciente);
        $('#fecha_cita').val(c.fecha_cita);
        
        // ‚úÖ Convertir hora 24h a formato 12h con AM/PM
        const time = convertTo12Hour(c.hora_cita);
        $('#hora_input').val(time.hora);
        $('#minuto_input').val(time.minuto);
        $('#ampm_input').val(time.ampm);
        
        $('#duracion_minutos').val(c.duracion_minutos);
        $('#estado').val(c.estado);

        $('#modalTitle').text('Editar Consulta');
        $('#modalFormulario').modal('show');
      }
    });
});


// --- Eliminar ---
$('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
  const id = $(this).data('id');
  Swal.fire({
    title: '¬øEliminar consulta?',
    text: 'Esta acci√≥n eliminar√° la consulta y todos sus detalles',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(res => {
    if (res.isConfirmed) {
      fetch(`/api/v1/consultas/${id}`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': CSRFToken }
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          $('#tbl').DataTable().ajax.reload();
          Swal.fire('Eliminado', 'Consulta eliminada correctamente', 'success');
        } else {
          Swal.fire('Error', d.error || 'No se pudo eliminar', 'error');
        }
      });
    }
  });
});

// --- Ver Detalles ---
$('#tbl').on('click', 'button[name="btn_detalles"]', function() {
  const id = $(this).data('id');
  consultaActualId = id;

  fetch(`/api/v1/consultas/${id}`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const c = d.data;
        idMedicoActual = c.id_medico;  // GUARDAR
        idPacienteActual = c.id_paciente;  // GUARDAR
        
        $('#infoConsulta').html(`
          <strong>Paciente:</strong> ${c.nombre_paciente}<br>
          <strong>M√©dico:</strong> ${c.nombre_medico}<br>
          <strong>Fecha:</strong> ${formatDateForDisplay(c.fecha_cita)} - ${formatTimeToAMPM(c.hora_cita)}<br>

          <strong>Estado:</strong> ${c.estado}
        `);
      } else {
        $('#infoConsulta').html(`<span class="text-danger">No se pudo cargar la informaci√≥n</span>`);
      }
    });

  cargarDetallesConsulta(id);
  limpiarModalDetalle();
  $('#modalDetalles').modal('show');
});

// --- Cargar detalles de la consulta ---
// --- Cargar detalles de la consulta ---
function cargarDetallesConsulta(idConsulta) {
  fetch(`/api/v1/consultas/${idConsulta}/detalles`)
    .then(r => r.json())
    .then(d => {
      console.log('Datos recibidos del API:', d);
      
      const tbody = $('#tblDetalles tbody');
      tbody.empty();

      if (d.success && d.data.length > 0) {
        d.data.forEach(det => {
          console.log('Detalle individual:', det);
          
          tbody.append(`
            <tr>
              <td>${det.descripcion_sintoma || det.sintoma || 'N/A'}</td>
              <td>${det.pieza_dental || '-'}</td>
              <td>${det.diagnostico || '-'}</td>
              <td>${det.tipo_diagnostico || det.descripcion_tipo_diagnostico || '-'}</td>
              <td>${det.tratamiento || '-'}</td>
              <td>${det.procedimiento || '-'}</td>
              <td>${det.procedimiento_medico || det.tipo_procedimiento || det.descripcion_tipo_procedimiento || '-'}</td>
              <td class="text-center align-middle">
                <div class="btn-group" role="group">
                  <button class="btn btn-info btn-sm" name="btn_editar_detalle" 
                    data-id="${det.id_consulta_detalle}"
                    data-id_sintoma="${det.id_sintoma || ''}"
                    data-descripcion_sintoma="${det.descripcion_sintoma || det.sintoma || ''}"
                    data-pieza_dental="${det.pieza_dental || ''}"
                    data-diagnostico="${det.diagnostico || ''}"
                    data-tratamiento="${det.tratamiento || ''}"
                    data-procedimiento="${det.procedimiento || ''}"
                    data-id_tipo_diagnostico="${det.id_tipo_diagnostico || ''}"
                    data-descripcion_tipo_diagnostico="${det.tipo_diagnostico || det.descripcion_tipo_diagnostico || ''}"
                    data-id_tipo_procedimiento="${det.id_tipo_procedimiento || ''}"
                    data-descripcion_tipo_procedimiento="${det.procedimiento_medico || det.tipo_procedimiento || det.descripcion_tipo_procedimiento || ''}"
                    title="Editar"> 
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-danger btn-sm" name="btn_eliminar_detalle" 
                    data-id="${det.id_consulta_detalle}"
                    title="Eliminar">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </td>
            </tr>
          `);
        });
      } else {
        tbody.append(`
          <tr>
            <td colspan="8" class="text-center text-muted">No hay detalles registrados</td>
          </tr>
        `);
      }
    })
    .catch(err => {
      console.error('Error al cargar detalles:', err);
      $('#tblDetalles tbody').html(`
        <tr>
          <td colspan="8" class="text-center text-danger">Error al cargar los detalles</td>
        </tr>
      `);
    });
}
// --- Editar Detalle ---
$('#tblDetalles').on('click', 'button[name="btn_editar_detalle"]', function() {
  const btn = $(this);
  detalleEditandoId = btn.data('id');
  
  // Cargar datos b√°sicos
  $('#id_sintoma').val(btn.data('id_sintoma'));
  $('#txtSintoma').val(btn.data('descripcion_sintoma'));
  $('#pieza_dental').val(btn.data('pieza_dental'));
  $('#diagnostico').val(btn.data('diagnostico'));
  $('#tratamiento').val(btn.data('tratamiento'));
  $('#procedimiento').val(btn.data('procedimiento'));
  
  // Cargar tipo de diagn√≥stico
  $('#id_tipo_diagnostico').val(btn.data('id_tipo_diagnostico') || '');
  $('#txtTipoDiagnostico').val(btn.data('descripcion_tipo_diagnostico') || '');
  
  // ‚úÖ AGREGAR: Cargar tipo de procedimiento
  $('#id_tipo_procedimiento').val(btn.data('id_tipo_procedimiento') || '');
  $('#txtTipoProcedimiento').val(btn.data('descripcion_tipo_procedimiento') || '');
  
  $('#btnAgregarDetalle').html('<i class="fas fa-save"></i> Actualizar Detalle');
  
  $('html, body').animate({
    scrollTop: $('#txtSintoma').offset().top - 100
  }, 500);
});

// --- Agregar/Actualizar Detalle ---
// --- Agregar/Actualizar Detalle ---
$('#btnAgregarDetalle').on('click', () => {
  const idTipoDiagnostico = $('#id_tipo_diagnostico').val();
  const idTipoProcedimiento = $('#id_tipo_procedimiento').val();
  
  const payload = {
    id_consulta_cab: consultaActualId,
    id_sintoma: parseInt($('#id_sintoma').val()),
    pieza_dental: $('#pieza_dental').val() || null,
    diagnostico: $('#diagnostico').val(),
    tratamiento: $('#tratamiento').val(),
    procedimiento: $('#procedimiento').val() || null,
    id_tipo_diagnostico: (idTipoDiagnostico && idTipoDiagnostico !== '') ? parseInt(idTipoDiagnostico) : null,
    id_tipo_procedimiento: (idTipoProcedimiento && idTipoProcedimiento !== '') ? parseInt(idTipoProcedimiento) : null
  };

  let valido = true;
  $('#error_txtSintoma, #error_diagnostico, #error_tratamiento').hide();
  
  if (!payload.id_sintoma) { $('#error_txtSintoma').show(); valido = false; }
  if (!payload.diagnostico) { $('#error_diagnostico').show(); valido = false; }
  if (!payload.tratamiento) { $('#error_tratamiento').show(); valido = false; }

  if (!valido) return;

  const url = detalleEditandoId 
    ? `/api/v1/consultas-detalle/${detalleEditandoId}` 
    : '/api/v1/consultas-detalle';
  const method = detalleEditandoId ? 'PUT' : 'POST';
  const mensajeExito = detalleEditandoId ? 'actualizado' : 'agregado';

  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      // ‚úÖ SI ES EDICI√ìN, SINCRONIZAR CON DIAGN√ìSTICOS Y TRATAMIENTOS
      if (detalleEditandoId) {
        sincronizarDiagnosticoYTratamiento(detalleEditandoId, payload);
      }
      
      limpiarModalDetalle();
      cargarDetallesConsulta(consultaActualId);
      Swal.fire('√âxito', `Detalle ${mensajeExito} correctamente`, 'success');
    } else {
      Swal.fire('Error', d.error || `No se pudo ${mensajeExito}`, 'error');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    Swal.fire('Error', 'Error al guardar el detalle', 'error');
  });
});

// ========================================
// FUNCI√ìN PARA SINCRONIZAR DIAGN√ìSTICO Y TRATAMIENTO
// ========================================
function sincronizarDiagnosticoYTratamiento(idConsultaDetalle, payload) {
  // Obtener fecha de consulta formateada
  const fechaConsulta = $('#diag_consulta_fecha').text().split(' - ')[0];
  const partes = fechaConsulta.split('/');
  const fechaFormateada = partes.length === 3 ? `${partes[2]}-${partes[1]}-${partes[0]}` : new Date().toISOString().split('T')[0];

  // 1. ACTUALIZAR EN TABLA DIAGN√ìSTICOS
  fetch(`/api/v1/Diagnostico/consulta-detalle/${idConsultaDetalle}`)
    .then(r => r.json())
    .then(d => {
      if (d.success && d.data && d.data.length > 0) {
        // Actualizar el diagn√≥stico m√°s reciente
        const diagnostico = d.data[0];
        
        return fetch(`/api/v1/Diagnostico/${diagnostico.id_diagnostico}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
          body: JSON.stringify({
            id_consulta_detalle: idConsultaDetalle,
            id_medico: idMedicoActual,
            id_paciente: idPacienteActual,
            id_tipo_diagnostico: payload.id_tipo_diagnostico,
            descripcion_diagnostico: payload.diagnostico,
            pieza_dental: payload.pieza_dental,
            fecha_diagnostico: diagnostico.fecha_diagnostico || fechaFormateada
          })
        });
      } else if (payload.diagnostico) {
        // Si no existe, crear uno nuevo
        return fetch('/api/v1/Diagnostico', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
          body: JSON.stringify({
            id_consulta_detalle: idConsultaDetalle,
            id_medico: idMedicoActual,
            id_paciente: idPacienteActual,
            id_tipo_diagnostico: payload.id_tipo_diagnostico,
            descripcion_diagnostico: payload.diagnostico,
            pieza_dental: payload.pieza_dental,
            fecha_diagnostico: fechaFormateada
          })
        });
      }
    })
    .then(r => r ? r.json() : null)
    .then(d => {
      if (d && d.success) {
        console.log('‚úÖ Diagn√≥stico sincronizado correctamente');
      }
    })
    .catch(err => console.error('Error al sincronizar diagn√≥stico:', err));

  // 2. ACTUALIZAR EN TABLA TRATAMIENTOS
  fetch(`/api/v1/Tratamiento/consulta-detalle/${idConsultaDetalle}`)
    .then(r => r.json())
    .then(d => {
      if (d.success && d.data && d.data.length > 0) {
        // Actualizar el tratamiento m√°s reciente
        const tratamiento = d.data[0];
        
        return fetch(`/api/v1/Tratamiento/${tratamiento.id_tratamiento}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
          body: JSON.stringify({
            id_consulta_detalle: idConsultaDetalle,
            id_medico: idMedicoActual,
            id_paciente: idPacienteActual,
            id_tipo_procedimiento: payload.id_tipo_procedimiento,
            descripcion_tratamiento: payload.tratamiento,
            procedimiento: payload.procedimiento,
            fecha_tratamiento: tratamiento.fecha_tratamiento || fechaFormateada,
            estado: tratamiento.estado || 'pendiente'
          })
        });
      } else if (payload.tratamiento) {
        // Si no existe, crear uno nuevo
        return fetch('/api/v1/Tratamiento', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
          body: JSON.stringify({
            id_consulta_detalle: idConsultaDetalle,
            id_medico: idMedicoActual,
            id_paciente: idPacienteActual,
            id_tipo_procedimiento: payload.id_tipo_procedimiento,
            descripcion_tratamiento: payload.tratamiento,
            procedimiento: payload.procedimiento,
            fecha_tratamiento: fechaFormateada,
            estado: 'pendiente'
          })
        });
      }
    })
    .then(r => r ? r.json() : null)
    .then(d => {
      if (d && d.success) {
        console.log('‚úÖ Tratamiento sincronizado correctamente');
      }
    })
    .catch(err => console.error('Error al sincronizar tratamiento:', err));
}
// --- Eliminar Detalle ---
$('#tblDetalles').on('click', 'button[name="btn_eliminar_detalle"]', function() {
  const idDetalle = $(this).data('id');
  
  Swal.fire({
    title: '¬øEliminar detalle?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(res => {
    if (res.isConfirmed) {
      fetch(`/api/v1/consultas-detalle/${idDetalle}`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': CSRFToken }
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          cargarDetallesConsulta(consultaActualId);
          Swal.fire('Eliminado', 'Detalle eliminado correctamente', 'success');
        } else {
          Swal.fire('Error', d.error || 'No se pudo eliminar', 'error');
        }
      });
    }
  });
});


// ========================================
// GESTIONAR DIAGN√ìSTICOS (CORREGIDO)
// ========================================
$('#btnGestionarDiagnosticos').on('click', function() {
  fetch(`/api/v1/consultas-detalle-info`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const detalle = d.data.find(det => det.id_consulta_cab === consultaActualId);
        
        if (detalle) {
          consultaDetalleActualId = detalle.id_consulta_detalle;
          idMedicoActual = detalle.id_medico;
          idPacienteActual = detalle.id_paciente;
          
          $('#diag_paciente_nombre').text(detalle.nombre_paciente);
          $('#diag_paciente_info').text(`Consulta del ${formatDateForDisplay(detalle.fecha_cita)}`);
          
          $('#diag_medico_nombre').text(detalle.nombre_medico);
          $('#diag_medico_info').text(`Consultorio: ${detalle.nombre_consultorio || 'N/A'}`);
          
          $('#diag_consulta_fecha').text(`${formatDateForDisplay(detalle.fecha_cita)} - ${formatTimeToAMPM(detalle.hora_cita)}`);
          
          let infoExtra = `S√≠ntoma: ${detalle.descripcion_sintoma}`;
          if (detalle.pieza_dental) {
            infoExtra += ` | Pieza Dental: ${detalle.pieza_dental}`;
          }
          $('#diag_consulta_info').text(infoExtra);
          
          $('#diagnostico_principal').val(detalle.diagnostico || '');
          
          // ‚úÖ ASEGURAR QUE SE CARGUE CORRECTAMENTE
          if (detalle.id_tipo_diagnostico) {
            $('#id_tipo_diagnostico_principal').val(detalle.id_tipo_diagnostico);
            
            // Obtener el nombre del tipo de diagn√≥stico
            const descripcionTipo = detalle.tipo_diagnostico || 
                                   detalle.descripcion_tipo_diagnostico || 
                                   '';
            $('#txtTipoDiagnosticoPrincipal').val(descripcionTipo);
            
            // ‚úÖ LOG PARA VERIFICAR
            console.log('‚úÖ Tipo diagn√≥stico cargado:', {
              id: detalle.id_tipo_diagnostico,
              descripcion: descripcionTipo
            });
          } else {
            $('#id_tipo_diagnostico_principal').val('');
            $('#txtTipoDiagnosticoPrincipal').val('');
            console.warn('‚ö†Ô∏è No hay tipo de diagn√≥stico en el detalle');
          }
          
          $('#modalGestionarDiagnosticos').modal('show');
        } else {
          Swal.fire('Advertencia', 'Primero debe agregar un detalle cl√≠nico en esta consulta', 'warning');
        }
      }
    })
    .catch(err => {
      console.error('Error:', err);
      Swal.fire('Error', 'Error al cargar informaci√≥n', 'error');
    });
});

// --- Agregar diagn√≥stico detallado (CORREGIDO) ---
$('#btnAgregarDiagnostico').on('click', function() {
  // Primero validamos que los campos requeridos existan
  if (!consultaDetalleActualId || !idMedicoActual || !idPacienteActual) {
    Swal.fire('Error', 'Faltan datos necesarios para agregar el diagn√≥stico', 'error');
    return;
  }

  const descripcion = $('#nuevo_diag_descripcion').val();
  
  if (!descripcion || !descripcion.trim()) {
    Swal.fire('Advertencia', 'Debe ingresar una descripci√≥n', 'warning');
    return;
  }

  // Obtenemos el detalle de la consulta para obtener el id_tipo_diagnostico
  fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}`)
    .then(r => r.json())
    .then(detalleData => {
      if (detalleData.success) {
        const payload = {
          id_consulta_detalle: consultaDetalleActualId,
          id_medico: idMedicoActual,
          id_paciente: idPacienteActual,
          id_tipo_diagnostico: detalleData.data.id_tipo_diagnostico || null,
          pieza_dental: $('#nuevo_diag_pieza').val() || null,
          descripcion_diagnostico: descripcion.trim(),
          gravedad: $('#nuevo_diag_gravedad').val() || null
          
        };
        
        console.log('Enviando payload:', payload); // üîç Para debug
        
        // ‚úÖ IMPORTANTE: Usar POST para crear un nuevo diagn√≥stico
        fetch('/api/v1/Diagnostico', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': CSRFToken 
          },
          body: JSON.stringify(payload)
        })
        .then(r => {
          if (!r.ok) {
            // Si la respuesta no es OK, lanzamos un error con el status
            throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
        })
        .then(d => {
          console.log('Respuesta del servidor:', d); // üîç Para debug
          if (d.success) {
            // Limpiar campos
            $('#nuevo_diag_pieza').val('');
            $('#nuevo_diag_descripcion').val('');
            $('#nuevo_diag_observaciones').val('');
            $('#nuevo_diag_gravedad').val('');
          
            Swal.fire('√âxito', 'Diagn√≥stico agregado correctamente', 'success');
            
            // Opcional: Recargar la lista de diagn√≥sticos si tienes una funci√≥n para eso
            // cargarDiagnosticos(consultaDetalleActualId);
          } else {
            Swal.fire('Error', d.error || 'Error al guardar el diagn√≥stico', 'error');
          }
        })
        .catch(err => {
          console.error('Error en la petici√≥n:', err);
          Swal.fire('Error', `Error al guardar el diagn√≥stico: ${err.message}`, 'error');
        });
      } else {
        Swal.fire('Error', detalleData.error || 'No se pudo obtener informaci√≥n del detalle', 'error');
      }
    })
    .catch(err => {
      console.error('Error al obtener detalle:', err);
      Swal.fire('Error', 'No se pudo obtener informaci√≥n del detalle', 'error');
    });
});

// --- Eliminar diagn√≥stico (CORREGIDO) ---
$('#tblDiagnosticos').on('click', 'button[name="btn_eliminar_diagnostico"]', function() {
  const idDiagnostico = $(this).data('id');
  
  Swal.fire({
    title: '¬øEliminar diagn√≥stico?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(res => {
    if (res.isConfirmed) {
      fetch(`/api/v1/Diagnostico/${idDiagnostico}`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': CSRFToken }
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          
          Swal.fire('Eliminado', 'Diagn√≥stico eliminado', 'success');
        } else {
          Swal.fire('Error', d.error, 'error');
        }
      });
    }
  });
});


// --- Guardar diagn√≥stico principal ---
$('#btnGuardarDiagnosticoPrincipal').on('click', function() {
  if (isSubmittingDiagnostico) {
    console.warn('‚ö†Ô∏è Ya hay una operaci√≥n en proceso...');
    return;
  }

  const diagnostico = $('#diagnostico_principal').val();
  const idTipoDiagnostico = $('#id_tipo_diagnostico_principal').val();
  
  // ‚úÖ LOG PARA VER QU√â VALOR TIENE
  console.log('üîç id_tipo_diagnostico_principal:', idTipoDiagnostico);
  console.log('üîç Tipo de dato:', typeof idTipoDiagnostico);
  
  if (!diagnostico.trim()) {
    Swal.fire('Advertencia', 'Debe ingresar un diagn√≥stico', 'warning');
    return;
  }
  
  if (!idTipoDiagnostico || idTipoDiagnostico === '' || idTipoDiagnostico === 'null') {
    Swal.fire({
      icon: 'warning',
      title: 'Campo requerido',
      text: 'Debe seleccionar un tipo de diagn√≥stico',
      confirmButtonText: 'Entendido'
    });
    return;
  }
  
  if (!consultaDetalleActualId || !idMedicoActual || !idPacienteActual) {
    Swal.fire('Error', 'Faltan datos necesarios para guardar el diagn√≥stico', 'error');
    return;
  }

  isSubmittingDiagnostico = true;
  const $btn = $('#btnGuardarDiagnosticoPrincipal');
  const btnOriginalText = $btn.html();
  $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
  
  const fechaConsulta = $('#diag_consulta_fecha').text().split(' - ')[0];
  const partes = fechaConsulta.split('/');
  const fechaFormateada = `${partes[2]}-${partes[1]}-${partes[0]}`;
  
  fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}`)
    .then(r => r.json())
    .then(d => {
      if (!d.success) {
        throw new Error(d.error || 'Error al obtener detalle');
      }
      
      const detalle = d.data;
      
      // ‚úÖ CONVERTIR A ENTERO
      const idTipoDiagInt = parseInt(idTipoDiagnostico);
      
      // ‚úÖ LOG PARA DEBUG
      console.log('üì¶ Payload para actualizar detalle:', {
        id_tipo_diagnostico: idTipoDiagInt,
        diagnostico: diagnostico
      });
      
      return fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
        body: JSON.stringify({
          id_consulta_cab: consultaActualId,
          id_sintoma: detalle.id_sintoma,
          pieza_dental: detalle.pieza_dental,
          diagnostico: diagnostico,
          tratamiento: detalle.tratamiento,
          procedimiento: detalle.procedimiento,
          id_tipo_diagnostico: idTipoDiagInt,
          id_tipo_procedimiento: detalle.id_tipo_procedimiento
        })
      })
      .then(r => r.json())
      .then(updateResult => {
        if (!updateResult.success) {
          throw new Error(updateResult.error || 'Error al actualizar detalle');
        }
        
        return fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}/diagnosticos`)
          .then(r => r.json())
          .then(diagData => {
            const yaExiste = diagData.success && diagData.data.some(
              diag => diag.descripcion_diagnostico.trim().toLowerCase() === diagnostico.trim().toLowerCase()
            );
            
            if (yaExiste) {
              Swal.fire({
                icon: 'info',
                title: 'Informaci√≥n',
                text: 'Este diagn√≥stico ya fue registrado',
                confirmButtonText: 'Entendido'
              });
              return { success: true, message: 'Este diagn√≥stico ya fue registrado', duplicado: true };
            }
            
            // ‚úÖ PAYLOAD PARA INSERTAR EN DIAGNOSTICOS
            const payloadDiagnostico = {
              id_consulta_detalle: consultaDetalleActualId,
              id_medico: idMedicoActual,
              id_paciente: idPacienteActual,
              id_tipo_diagnostico: idTipoDiagInt,
              descripcion_diagnostico: diagnostico.trim(),
              fecha_diagnostico: fechaFormateada,
              pieza_dental: detalle.pieza_dental
            };
            
            console.log('üì¶ Payload para insertar diagn√≥stico:', payloadDiagnostico);
            
            return fetch('/api/v1/Diagnostico', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
              body: JSON.stringify(payloadDiagnostico)
            }).then(r => r.json());
          });
      });
    })
    .then(d => {
      if (d.success && !d.duplicado) {
        Swal.fire('√âxito', 'Diagn√≥stico guardado correctamente', 'success');
        cargarDetallesConsulta(consultaActualId);
      } else if (d.success && d.duplicado) {
        cargarDetallesConsulta(consultaActualId);
      } else {
        const esDuplicado = d.error && d.error.includes('Ya existe');
        Swal.fire({
          icon: esDuplicado ? 'info' : 'error',
          title: esDuplicado ? 'Informaci√≥n' : 'Error',
          text: d.error || 'Error al guardar',
          confirmButtonText: 'Entendido'
        });
      }
    })
    .catch(err => {
      console.error('‚ùå Error:', err);
      Swal.fire('Error', `Error al guardar: ${err.message}`, 'error');
    })
    .finally(() => {
      isSubmittingDiagnostico = false;
      $btn.prop('disabled', false).html(btnOriginalText);
    });
});

// ========================================
// REGISTRAR TRATAMIENTOS
// ========================================
$('#btnRegistrarTratamientos').on('click', function() {
  fetch(`/api/v1/consultas-detalle-info`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const detalle = d.data.find(det => det.id_consulta_cab === consultaActualId);
        
        if (detalle) {
          consultaDetalleActualId = detalle.id_consulta_detalle;
          
          $('#trat_paciente_nombre').text(detalle.nombre_paciente);
          $('#trat_paciente_info').text(`Consulta del ${formatDateForDisplay(detalle.fecha_cita)}`);
          
          $('#trat_medico_nombre').text(detalle.nombre_medico);
          $('#trat_medico_info').text(`Consultorio: ${detalle.nombre_consultorio || 'N/A'}`);
          
          $('#trat_consulta_fecha').text(`${formatDateForDisplay(detalle.fecha_cita)} - ${formatTimeToAMPM(detalle.hora_cita)}`);
          $('#trat_consulta_info').text(`S√≠ntoma: ${detalle.descripcion_sintoma}`);
          
          $('#tratamiento_principal').val(detalle.tratamiento || '');
          
          $('#modalRegistrarTratamientos').modal('show');
        } else {
          Swal.fire('Advertencia', 'Primero debe agregar un detalle cl√≠nico en esta consulta', 'warning');
        }
      }
    })
    .catch(err => {
      Swal.fire('Error', 'Error al cargar la informaci√≥n de la consulta', 'error');
    });
});


// --- Guardar tratamiento principal ---
// --- Guardar tratamiento principal ---
$('#btnGuardarTratamientoPrincipal').on('click', function() {
  // ‚úÖ PREVENIR DOBLE CLICK
  if (isSubmittingTratamiento) {
    console.warn('‚ö†Ô∏è Ya hay una operaci√≥n en proceso...');
    return;
  }

  const tratamiento = $('#tratamiento_principal').val();
  
  if (!tratamiento.trim()) {
    Swal.fire('Advertencia', 'Debe ingresar un tratamiento', 'warning');
    return;
  }

  // ‚úÖ VALIDAR QUE TENGAMOS TODOS LOS DATOS NECESARIOS
  if (!consultaDetalleActualId) {
    Swal.fire('Error', 'No se ha cargado correctamente el detalle de consulta', 'error');
    return;
  }

  // ‚úÖ BLOQUEAR BOT√ìN
  isSubmittingTratamiento = true;
  const $btn = $('#btnGuardarTratamientoPrincipal');
  const btnOriginalText = $btn.html();
  $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
  
  const fechaConsulta = $('#trat_consulta_fecha').text().split(' - ')[0];
  const partes = fechaConsulta.split('/');
  const fechaFormateada = `${partes[2]}-${partes[1]}-${partes[0]}`;
  
  // 1. Primero obtener el detalle completo
  fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}`)
    .then(r => r.json())
    .then(d => {
      if (!d.success) {
        throw new Error(d.error || 'Error al obtener detalle');
      }
      
      const detalle = d.data;
      
      // 2. Actualizar consultas_detalle
      return fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
        body: JSON.stringify({
          id_consulta_cab: consultaActualId,
          id_sintoma: detalle.id_sintoma,
          pieza_dental: detalle.pieza_dental,
          diagnostico: detalle.diagnostico,
          tratamiento: tratamiento,
          id_tipo_diagnostico: detalle.id_tipo_diagnostico,
          procedimiento: detalle.procedimiento,
          id_tipo_procedimiento: detalle.id_tipo_procedimiento
        })
      })
      .then(r => r.json())
      .then(updateResult => {
        if (!updateResult.success) {
          throw new Error(updateResult.error || 'Error al actualizar detalle');
        }
        
        // 3. Verificar si ya existe un tratamiento con el mismo texto
        return fetch(`/api/v1/consultas-detalle/${consultaDetalleActualId}/Tratamiento`)
          .then(r => r.json())
          .then(tratData => {
            const yaExiste = tratData.success && tratData.data.some(
              trat => trat.descripcion_tratamiento.trim().toLowerCase() === tratamiento.trim().toLowerCase()
            );
            
            if (yaExiste) {
              console.log('‚ÑπÔ∏è Este registro ya fue registrado');
              // ‚úÖ MOSTRAR ALERTA DE DUPLICADO
              Swal.fire({
                icon: 'info',
                title: 'Informaci√≥n',
                text: 'Este registro ya fue registrado',
                confirmButtonText: 'Entendido'
              });
              return { success: true, message: 'Este registro ya fue registrado', duplicado: true };
            }
            
            // Si no existe, crear uno nuevo
            return fetch('/api/v1/Tratamiento', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
              body: JSON.stringify({
                id_consulta_detalle: consultaDetalleActualId,
                id_medico: idMedicoActual,
                id_paciente: idPacienteActual,
                descripcion_tratamiento: tratamiento,
                fecha_tratamiento: fechaFormateada,
                estado: 'pendiente'
              })
            }).then(r => r.json());
          });
      });
    })
    .then(d => {
      if (d.success && !d.duplicado) {
        Swal.fire('√âxito', d.message || 'Tratamiento guardado correctamente', 'success');
        cargarDetallesConsulta(consultaActualId);
      } else if (d.success && d.duplicado) {
        // Ya se mostr√≥ el mensaje, solo recargar
        cargarDetallesConsulta(consultaActualId);
      } else {
        // ‚úÖ MOSTRAR ERROR DE VALIDACI√ìN
        Swal.fire({
          icon: 'warning',
          title: 'Advertencia',
          text: d.error || 'Error al guardar',
          confirmButtonText: 'Entendido'
        });
      }
    })
    .catch(err => {
      console.error('Error:', err);
      Swal.fire('Error', `Error al guardar: ${err.message}`, 'error');
    })
    .finally(() => {
      // ‚úÖ REHABILITAR BOT√ìN
      isSubmittingTratamiento = false;
      $btn.prop('disabled', false).html(btnOriginalText);
    });
});


$('#btnAbrirOdontograma').on('click', function() {
  if (!idPacienteActual) {
    Swal.fire('Error', 'No se ha identificado al paciente', 'error');
    return;
  }

  fetch(`/api/v1/odontograma/paciente/${idPacienteActual}`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        // ‚úÖ CON EL PREFIJO /api/v1
        window.location.href = `/api/v1/odontograma-index?action=ver&id=${d.data.id_odontograma}&paciente=${idPacienteActual}`;
      } else {
        Swal.fire({
          title: 'Sin Odontograma',
          text: 'El paciente no tiene un odontograma registrado. ¬øDesea crear uno?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'S√≠, crear',
          cancelButtonText: 'Cancelar'
        }).then(result => {
          if (result.isConfirmed) {
            window.location.href = `/api/v1/odontograma-index?action=nuevo&paciente=${idPacienteActual}&medico=${idMedicoActual}`;
          }
        });
      }
    });
});

// AGREGAR despu√©s de la l√≠nea 1093 (despu√©s del evento btnAbrirOdontograma)
$('#btnGenerarFichaMedica').on('click', function() {
  if (!idPacienteActual) {
    Swal.fire('Error', 'No se ha identificado al paciente', 'error');
    return;
  }
  
  // Abrir la ficha m√©dica en una nueva ventana
  window.open(`/api/v1/ficha-medica/${idPacienteActual}`, '_blank');
});


// ==========================================
// FIX MODAL
// ==========================================
const fixModalShift = () => {
  $.fn.modal.Constructor.prototype._setScrollbar = function() {};
  $.fn.modal.Constructor.prototype._resetScrollbar = function() {};
  
  $(document).on('show.bs.modal', '.modal', function () {
    setTimeout(() => {
      $('body').css('padding-right', '0');
      $('.modal').css('padding-right', '0');
      $('.navbar-fixed-top, .navbar-fixed-bottom').css('padding-right', '0');
    }, 0);
  });

  $(document).on('hidden.bs.modal', '.modal', function () {
    $('body').css('padding-right', '0');
  });
};

// --- Inicializar todo ---
$(document).ready(() => {
  initDatatable();
  initDatatablePersonal();
  initDatatableConsultorio();
  initDatatableMedico();
  initDatatablePaciente();
  initDatatableSintoma();
  initDatatableTipoDiagnostico();
  initDatatableTipoProcedimiento();
  actualizarEstadisticas();
  fixModalShift();
});
</script>
{% endblock %}