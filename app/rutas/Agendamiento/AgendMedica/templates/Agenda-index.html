
{% extends 'base.html' %}

{% block titulo %}
Agenda Médica
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

  <!-- Tarjeta -->
  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">
    <!-- Header: Botón Agregar y Título -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-light btn-sm" id="btnAgregar">
        <i class="fas fa-plus-circle mr-1"></i> Agregar
      </button>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-calendar-alt mr-2"></i> Agenda Médica
      </h5>
    </div>

    <!-- Body: Tabla de agenda -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered align-middle text-center" id="tbl">
          <thead class="bg-info text-white">
            <tr>
              <th>Médico</th>
              <th>Día</th>
              <th>Turno</th>
              <th>Especialidad</th>
              <th>Consultorio</th>
              <th>Personal</th>
              <th>Fecha Agenda</th>
              <th>Horario Disponible</th>
              <th>Cupos</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Formulario Agenda -->
  <!-- =========================== -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top d-flex justify-content-between align-items-center">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-calendar-alt mr-2"></i> <span id="modalTitle">Nueva Agenda</span>
          </h5>
          
          <!-- Estado arriba a la derecha -->
          <div class="form-group mb-0 d-flex align-items-center">
            <label for="estado" class="mr-2 mb-0 text-white">Estado:</label>
            <select id="estado" class="form-control form-control-sm">
              <option value="Activo">Activo</option>
              <option value="Inactivo">Inactivo</option>
            </select>
          </div>

          <button type="button" class="close text-white ml-2" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <input type="hidden" id="txtIdAgenda">

          <div class="row">

            <!-- Médico -->
            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_medico">
              <label class="font-weight-bold">Médico:</label>
              <input type="text" id="txtmedico" class="form-control" placeholder="Click para seleccionar Médico" readonly>
            </div>

            <!-- Día -->
            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_dia">
              <label class="font-weight-bold">Día:</label>
              <input type="text" id="txtDia" class="form-control" placeholder="Click para seleccionar día" readonly>
            </div>

            <!-- Turno -->
            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_turno">
              <label class="font-weight-bold">Turno:</label>
              <input type="text" id="txtTurno" class="form-control" placeholder="Click para seleccionar turno" readonly>
            </div>

            <!-- Especialidad -->
            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_especialidad">
              <label class="font-weight-bold">Especialidad:</label>
              <input type="text" id="txtEspecialidad" class="form-control" placeholder="Click para seleccionar Especialidad" readonly>
            </div>

            <!-- Consultorio -->
            <div class="col-md-6 mb-3">
              <input type="hidden" id="codigo" name="codigo">
              <label class="font-weight-bold">Consultorio:</label>
              <input type="text" id="txtConsultorio" class="form-control" placeholder="Click para seleccionar Consultorio" readonly>
            </div>

            <!-- Personal -->
            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_personal">
              <label class="font-weight-bold">Personal:</label>
              <input type="text" id="txtPersonal" class="form-control" placeholder="Click para seleccionar Personal" readonly>
            </div>

            <!-- Horario Disponible -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Horario Disponible:</label>
              <select id="selectHorario" class="form-control">
                <option value="">Seleccione médico y fecha</option>
              </select>
            </div>

            <!-- Cupos -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Cupos:</label>
              <input type="number" id="cupos" class="form-control" min="0" value="0" readonly>
            </div>

            <!-- Fecha Agenda -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Fecha Agenda:</label>
              <input type="date" id="fecha_agenda" class="form-control">
            </div>

            <!-- Hidden inputs -->
            <input type="hidden" id="id_disponibilidad">
            <input type="hidden" id="horario_disponible">

          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-info" id="btnGuardar">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Modales de selección -->

  <!-- Modal Médico -->
  <div class="modal fade" id="modalBuscarMedico" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Médico</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblMedico">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Día -->
  <div class="modal fade" id="modalBuscarDia" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Día</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblDia">
              <thead>
                <tr>
                  <th>Día</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Turno -->
  <div class="modal fade" id="modalBuscarTurno" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Turno</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblTurno">
              <thead>
                <tr>
                  <th>Turno</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Especialidad -->
  <div class="modal fade" id="modalBuscarEspecialidad" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Especialidad</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblEspecialidad">
              <thead>
                <tr>
                  <th>Especialidad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Consultorio -->
  <div class="modal fade" id="modalBuscarConsultorio" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Consultorio</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblConsultorio">
              <thead>
                <tr>
                  <th>Consultorio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Personal -->
  <div class="modal fade" id="modalBuscarPersonal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Personal</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblPersonal">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Librerías necesarias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}



// --- Tabla principal Agenda ---
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/agenda',
    columns: [
      { data: 'medico_nombre' },
      { data: 'dia' },
      { data: 'turno' },
      { data: 'especialidad' },
      { data: 'consultorio_nombre' }, 
      { data: 'personal_nombre' },    
      {
  data: 'fecha_agenda',
  render: function(data) {
  if (!data) return '';
  const d = new Date(data);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${day}/${month}/${year}`;
}
      },
      { data: 'horario_disponible' },
      { data: 'cupos' },
      {  
        data: 'estado',
        render: function(data) {
        if(data === "Activo") {
         return '<span style="color: #155724; background-color: #d4edda; padding: 2px 6px; border-radius: 4px;">Activo</span>';
    } else {
      return '<span style="color: #721c24; background-color: #f8d7da; padding: 2px 6px; border-radius: 4px;">Inactivo</span>';
    }
  }
},
      {
        data: function(row) {
          return `
          <button type="button" name="btn_editar" class="btn btn-info btn-sm" data-id_agenda_medica="${row.id_agenda_medica}" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" name="btn_eliminar" class="btn btn-danger btn-sm" data-id_agenda_medica="${row.id_agenda_medica}" title="Eliminar">
            <i class="fas fa-trash-alt"></i>
          </button>`;
        }
      }
    ]
  });
};

// --- Inicialización de modales y seleccionadores ---
const initDatatablem = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/medico',
    columns: [
      { data: 'nombre' },
      { data: 'apellido'},
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_Medico" class="btn btn-primary" data-id="${row.id_medico}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblMedico').on('click', 'button[name="btn_seleccionar_Medico"]', function () {
    const idMedico = $(this).data('id');
    const nombreMedico = $(this).data('nombre');
    const apellidoMedico = $(this).data('apellido');
    $('#txtmedico').val(`${nombreMedico} ${apellidoMedico}`);
    $('#id_medico').val(idMedico);
    $('#modalBuscarMedico').modal('hide');
  });
};

const initDatatabled = () => {
  $('#tblDia').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/dias',
    columns: [
      { data: 'descripcion' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_dia" class="btn btn-primary" data-id="${row.id_dia}" data-dia="${row.descripcion}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblDia').on('click', 'button[name="btn_seleccionar_dia"]', function () {
    $('#txtDia').val($(this).data('dia'));
    $('#id_dia').val($(this).data('id'));
    $('#modalBuscarDia').modal('hide');
  });
};

const initDatatablet = () => {
  $('#tblTurno').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/turnos',
    columns: [
      { data: 'descripcion' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_Turno" class="btn btn-primary" data-id="${row.id_turno}" data-turno="${row.descripcion}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblTurno').on('click', 'button[name="btn_seleccionar_Turno"]', function () {
    $('#txtTurno').val($(this).data('turno'));
    $('#id_turno').val($(this).data('id'));
    $('#modalBuscarTurno').modal('hide');
  });
};

const initDatatableEspecialidad = () => {
  $('#tblEspecialidad').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/especialidades',
    columns: [
      { data: 'descripcion' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_especialidad" class="btn btn-primary" data-id="${row.id_especialidad}" data-especialidad="${row.descripcion}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblEspecialidad').on('click', 'button[name="btn_seleccionar_especialidad"]', function () {
    $('#txtEspecialidad').val($(this).data('especialidad'));
    $('#id_especialidad').val($(this).data('id'));
    $('#modalBuscarEspecialidad').modal('hide');
  });
};

const initDatatableConsultorio = () => {
  $('#tblConsultorio').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/consultorios',
    columns: [
      { data: 'nombre_consultorio' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_consultorio" class="btn btn-primary" data-codigo="${row.codigo}" data-consultorio="${row.nombre_consultorio}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblConsultorio').on('click', 'button[name="btn_seleccionar_consultorio"]', function () {
    $('#txtConsultorio').val($(this).data('consultorio'));
    $('#codigo').val($(this).data('codigo'));
    $('#modalBuscarConsultorio').modal('hide');
  });
};

// --- Cargar horarios disponibles ---
const cargarDisponibilidades = () => {
  $('#id_medico, #fecha_agenda').on('change', function() {
    const id_medico = $('#id_medico').val();
    const fecha = $('#fecha_agenda').val();
    const select = $('#selectHorario');

    select.empty().append('<option value="">Seleccione un horario</option>');
    $('#id_disponibilidad').val('');
    $('#horario_disponible').val('');
    $('#cupos').val('');

    if (!id_medico || !fecha) return;

    fetch(`/api/v1/agenda/disponibilidad?id_medico=${id_medico}&fecha=${fecha}`)
      .then(resp => resp.json())
      .then(result => {
        if (result.success && result.data.length > 0) {
          result.data.forEach(d => {
            const horaInicio = d.disponibilidad_hora_inicio?.substring(0,5) || '';
            const horaFin = d.disponibilidad_hora_fin?.substring(0,5) || '';
            select.append(`
              <option value="${d.id_disponibilidad}"
                      data-cupos="${d.disponibilidad_cupos}"
                      data-hora_inicio="${horaInicio}"
                      data-hora_fin="${horaFin}">
                ${horaInicio} - ${horaFin} (Cupos: ${d.disponibilidad_cupos})
              </option>
            `);
          });
        } else {
          select.append('<option value="">No hay horarios disponibles</option>');
        }
      })
      .catch(err => {
        console.error("Error al cargar disponibilidades:", err);
        select.empty().append('<option value="">Error al cargar</option>');
      });
  });

  $('#selectHorario').on('change', function() {
    const opt = $(this).find('option:selected');
    const id = $(this).val();

    $('#id_disponibilidad').val(id || '');
    const horaInicio = opt.data('hora_inicio') || '';
    const horaFin = opt.data('hora_fin') || '';
    const cupos = opt.data('cupos') || 0;

    $('#horario_disponible').val(`${horaInicio} - ${horaFin}`);
    $('#cupos').val(cupos);
  });
};

// --- Personal ---
const initDatatablePersonal = () => {
  $('#tblPersonal').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/personal',
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_personal" class="btn btn-primary" data-id="${row.id_personal}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });

  $('#tblPersonal').on('click', 'button[name="btn_seleccionar_personal"]', function () {
    $('#txtPersonal').val(`${$(this).data('nombre')} ${$(this).data('apellido')}`);
    $('#id_personal').val($(this).data('id'));
    $('#modalBuscarPersonal').modal('hide');
  });
};

// --- Apertura de modales ---
const buscarMedico = () => $('#txtmedico').on('click', () => $('#modalBuscarMedico').modal());
const buscarDia = () => $('#txtDia').on('click', () => $('#modalBuscarDia').modal());
const buscarTurno = () => $('#txtTurno').on('click', () => $('#modalBuscarTurno').modal());
const buscarEspecialidad = () => $('#txtEspecialidad').on('click', () => $('#modalBuscarEspecialidad').modal());
const buscarConsultorio = () => $('#txtConsultorio').on('click', () => $('#modalBuscarConsultorio').modal());
const buscarPersonal = () => $('#txtPersonal').on('click', () => $('#modalBuscarPersonal').modal());


// --- Agregar ---
const agregar = () => {
  $('#btnAgregar').on('click', () => {
    $('#modalTitle').text("Agregar Agenda");

    // Limpiar inputs visibles
    $('#txtIdAgenda, #txtmedico, #txtDia, #txtTurno, #txtEspecialidad, #txtConsultorio, #txtPersonal, #horario_disponible, #cupos, #fecha_agenda').val("");

    // Limpiar hidden
    $('#id_medico, #id_dia, #id_turno, #id_especialidad, #codigo, #id_personal, #id_disponibilidad').val("");

    // Limpiar select de horarios
    const select = $('#selectHorario');
    select.empty(); // eliminamos opciones previas
    select.append('<option value="">Seleccione médico y fecha</option>');

    // Estado por defecto
    $('#estado').val('Activo');

    // Abrir modal
    $('#modalFormulario').modal();
  });
};


// --- Guardar ---
const guardar = () => $('#btnGuardar').on('click', function() {
  const idAgenda = $('#txtIdAgenda').val();
  const fecha = $('#fecha_agenda').val();
  const hora = $('#horario_disponible').val();

  const payload = {
    id_medico: $('#id_medico').val(),
    id_dia: $('#id_dia').val(),
    id_turno: $('#id_turno').val(),
    id_especialidad: $('#id_especialidad').val(),
    codigo: $('#codigo').val(),
    id_personal: $('#id_personal').val(),
    fecha_agenda: fecha,
    id_disponibilidad: parseInt($('#id_disponibilidad').val() || 0),
    horario_disponible: hora,
    cupos: parseInt($('#cupos').val() || 0),
    estado: $('#estado').val(),
  };

  const tabla = $('#tbl').DataTable();
  const method = idAgenda ? 'PUT' : 'POST';
  const url = idAgenda ? `/api/v1/agenda/${idAgenda}` : '/api/v1/agenda';

  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken },
    body: JSON.stringify(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      tabla.ajax.reload();
      Swal.fire(idAgenda ? "Actualizado" : "Registrado", "Agenda guardada correctamente.", "success");
    } else {
      Swal.fire("Error", data.error, "error");
    }
  })
  .catch(err => Swal.fire("Error", "Ocurrió un error al guardar la agenda.", "error"));

  $('#modalFormulario').modal("hide");
});

// --- Editar ---
// --- Editar ---
// --- Editar ---
const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function() {
    const idAgenda = $(this).data('id_agenda_medica');

    fetch(`/api/v1/agenda/${idAgenda}`)
      .then(resp => resp.json())
      .then(data => {
        const d = data.data;

        // --- Datos básicos ---
        $('#txtIdAgenda').val(d.id_agenda_medica);
        $('#id_medico').val(d.id_medico); $('#txtmedico').val(d.medico_nombre);
        $('#id_dia').val(d.id_dia); $('#txtDia').val(d.dia);
        $('#id_turno').val(d.id_turno); $('#txtTurno').val(d.turno);
        $('#id_especialidad').val(d.id_especialidad); $('#txtEspecialidad').val(d.especialidad);
        $('#codigo').val(d.consultorio_id); $('#txtConsultorio').val(d.consultorio_nombre);
        $('#fecha_agenda').val(formatDateForInput(d.fecha_agenda));

        // --- Personal ---
        $('#id_personal').val(d.id_personal || "");
        $('#txtPersonal').val(d.personal_nombre || "");

        // --- Otros ---
        $('#cupos').val(d.cupos || "");
        $('#estado').val(d.estado);

        // --- Cargar horarios disponibles ---
        fetch(`/api/v1/agenda/disponibilidad?id_medico=${d.id_medico}&fecha=${formatDateForInput(d.fecha_agenda)}`)
          .then(resp => resp.json())
          .then(result => {
            const select = $('#selectHorario');
            select.empty(); // eliminamos cualquier opción previa

            if (result.success && result.data.length > 0) {
              result.data.forEach(h => {
                const horaInicio = h.disponibilidad_hora_inicio?.substring(0,5) || '';
                const horaFin = h.disponibilidad_hora_fin?.substring(0,5) || '';
                const selected = h.id_disponibilidad == d.id_disponibilidad ? 'selected' : '';
                select.append(`
                  <option value="${h.id_disponibilidad}" 
                          data-cupos="${h.disponibilidad_cupos}" 
                          data-hora_inicio="${horaInicio}" 
                          data-hora_fin="${horaFin}" ${selected}>
                    ${horaInicio} - ${horaFin} (Cupos: ${h.disponibilidad_cupos})
                  </option>
                `);
              });

              // Setear los hidden
              $('#id_disponibilidad').val(d.id_disponibilidad);
              $('#horario_disponible').val(d.horario_disponible);
              $('#cupos').val(d.cupos);
            }

            // abrir modal
            $('#modalFormulario').modal();
          });
      });
  });
};



// --- Eliminar ---
const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
    const idAgenda = $(this).data('id_agenda_medica');
    const fila = $(this).closest('tr');
    Swal.fire({
      title: "¿Deseas eliminar este registro?",
      showCancelButton: true,
      confirmButtonText: "Si",
      cancelButtonText: "No"
    }).then(result => {
      if (result.isConfirmed) {
        fetch(`/api/v1/agenda/${idAgenda}`, {
          method:'DELETE',
          headers:{'Content-Type':'application/json','X-CSRFToken':CSRFToken}
        })
        .then(resp => resp.json())
        .then(data => {
          if(data.success) { $('#tbl').DataTable().row(fila).remove().draw(); Swal.fire("Eliminado","","success"); }
          else Swal.fire("Error", data.error,"error");
        })
      }
    });
  });
};

// --- Inicialización ---
const addEvents = () => {
  agregar(); guardar(); editar(); eliminar();
  buscarMedico(); buscarDia(); buscarTurno();
  buscarEspecialidad(); buscarConsultorio(); buscarPersonal();
};

$(function() {
  initDatatable(); 
  initDatatablem(); 
  initDatatabled(); 
  initDatatablet();
  initDatatableEspecialidad(); 
  initDatatableConsultorio(); 
  initDatatablePersonal();
  addEvents();
  cargarDisponibilidades();
});
</script>
{% endblock %}


