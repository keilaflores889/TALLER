{% extends 'base.html' %}

{% block titulo %}
Pacientes
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">
    <!-- Header: Botón Agregar y Título -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-light btn-sm" id="btnAgregar">
        <i class="fas fa-plus-circle mr-1"></i> Agregar
      </button>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-user-injured mr-2"></i> Listado de Pacientes
      </h5>
    </div>

    <!-- Body: Tabla de pacientes -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered align-middle text-center" id="tbl">
          <thead class="bg-info text-white">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>N° Cédula</th>
              <th>Fecha Nacimiento</th>
              <th>Ciudad</th>
              <th>Dirección</th>
              <th>Teléfono</th>
              <th>Correo</th>
              <th>Fecha Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Formulario Paciente -->
  <!-- =========================== -->
  <div class="modal fade" 
       id="modalFormulario" 
       tabindex="-1" 
       role="dialog"
       data-backdrop="static"
       data-keyboard="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-user-injured mr-2"></i> <span id="modalTitle">Nuevo Paciente</span>
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form id="formPaciente">
            <input type="hidden" id="txtIdPaciente">
            
            <div class="row">
              <!-- Nombre -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-user mr-1"></i> Nombre: <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       id="nombre" 
                       class="form-control" 
                       placeholder="Ingrese el nombre"
                       maxlength="50"
                       required>
              </div>

              <!-- Apellido -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-user mr-1"></i> Apellido: <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       id="apellido" 
                       class="form-control" 
                       placeholder="Ingrese el apellido"
                       maxlength="50"
                       required>
              </div>

              <!-- Cédula -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-id-card mr-1"></i> N° Cédula: <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       id="cedula" 
                       class="form-control" 
                       placeholder="Ingrese el número de cédula"
                       maxlength="20"
                       required>
                <small class="form-text text-muted">
                  <i class="fas fa-info-circle"></i> Solo números
                </small>
              </div>

              <!-- Fecha Nacimiento -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-birthday-cake mr-1"></i> Fecha Nacimiento: <span class="text-danger">*</span>
                </label>
                <input type="date" 
                       id="fecha_nacimiento" 
                       class="form-control"
                       required>
              </div>

              <!-- Ciudad -->
              <div class="col-md-6 mb-3">
                <input type="hidden" id="id_ciudad">
                <label class="font-weight-bold">
                  <i class="fas fa-city mr-1"></i> Ciudad: <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       id="txtCiudad" 
                       class="form-control" 
                       placeholder="Click para seleccionar ciudad" 
                       readonly>
              </div>

              <!-- Dirección -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-map-marker-alt mr-1"></i> Dirección:
                </label>
                <input type="text" 
                       id="direccion" 
                       class="form-control" 
                       placeholder="Ingrese la dirección" 
                       autocomplete="off"
                       maxlength="200">
              </div>

              <!-- Teléfono -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-phone mr-1"></i> Teléfono: <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       id="telefono" 
                       class="form-control" 
                       placeholder="Ingrese el teléfono"
                       maxlength="15"
                       required>
                <small class="form-text text-muted">
                  <i class="fas fa-info-circle"></i> Solo números
                </small>
              </div>

              <!-- Correo -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-envelope mr-1"></i> Correo:
                </label>
                <input type="email" 
                       id="correo" 
                       class="form-control" 
                       placeholder="correo@ejemplo.com" 
                       autocomplete="off"
                       maxlength="100">
              </div>

              <!-- Fecha Registro -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-calendar-plus mr-1"></i> Fecha Registro: <span class="text-danger">*</span>
                </label>
                <input type="date" 
                       id="fecha_registro" 
                       class="form-control"
                       required>
              </div>

            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-info" id="btnGuardar">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Buscar Ciudad -->
  <!-- =========================== -->
  <div class="modal fade" 
       id="modalBuscarCiudad" 
       tabindex="-1" 
       role="dialog"
       data-backdrop="static"
       data-keyboard="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">
        
        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-search mr-2"></i> Seleccionar Ciudad
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover w-100" id="tblCiudad">
              <thead class="bg-info text-white">
                <tr>
                  <th>Ciudad</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

// ==========================================
// FUNCIÓN PARA FORMATEAR FECHAS
// ==========================================
const formatearFechaDMY = (fecha) => {
  if (!fecha) return '-';
  // Si la fecha viene en formato YYYY-MM-DD, la parseamos correctamente
  const partes = fecha.split('-');
  if (partes.length === 3) {
    const dia = partes[2].padStart(2, '0');
    const mes = partes[1].padStart(2, '0');
    const anio = partes[0];
    return `${dia}/${mes}/${anio}`;
  }
  // Fallback si viene en otro formato
  const d = new Date(fecha);
  if (isNaN(d)) return fecha;
  const dia = String(d.getDate()).padStart(2, '0');
  const mes = String(d.getMonth() + 1).padStart(2, '0');
  const anio = d.getFullYear();
  return `${dia}/${mes}/${anio}`;
};

// ==========================================
// DATATABLES
// ==========================================
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { 
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" 
    },
    ajax: '/api/v1/paciente',
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula_entidad' },
      { 
        data: 'fecha_nacimiento',
        render: function(data) {
          return formatearFechaDMY(data);
        }
      },
      { data: 'ciudad' },
      { data: 'direccion' },
      { 
        data: function(row) {
          return formatearTelefonoParaMostrar(row.telefono || '');
        },
        width: "120px",           
        className: "text-nowrap"
      },
      { data: 'correo' },
      { 
        data: 'fecha_registro',
        render: function(data) {
          return formatearFechaDMY(data);
        },
        width: "120px",           
        className: "text-nowrap"
      },
      {
        data: function(row) {
          return `
            <button type="button" name="btn_editar" class="btn btn-sm btn-info" 
                    data-id_paciente="${row.id_paciente}" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" name="btn_eliminar" class="btn btn-sm btn-danger" 
                    data-id_paciente="${row.id_paciente}" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;
          
        },
        className: 'text-center',
        orderable: false,
        width: "95px"
      }
    ]
  });
};

const initDatatablec = () => {
  if ($.fn.DataTable.isDataTable('#tblCiudad')) {
    $('#tblCiudad').DataTable().destroy();
  }
  
  $('#tblCiudad').DataTable({
    language: { 
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" 
    },
    ajax: '/api/v1/ciudades',
    columns: [
      { data: 'descripcion' },
      { 
        data: function(row) {
          return `
            <button type="button" name="btn_seleccionar_ciudad" 
                    class="btn btn-sm btn-warning" 
                    data-id="${row.id_ciudad}" 
                    data-ciudad="${row.descripcion}">
              <i class="fas fa-check mr-1"></i> Seleccionar
            </button>
          `;
        },
        className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblCiudad').off('click', 'button[name="btn_seleccionar_ciudad"]').on('click', 'button[name="btn_seleccionar_ciudad"]', function() {
    const idCiudad = $(this).data('id');
    const nombreCiudad = $(this).data('ciudad');
    $('#txtCiudad').val(nombreCiudad);
    $('#id_ciudad').val(idCiudad);
    $('#modalBuscarCiudad').modal('hide');
  });
};

// ==========================================
// FORMATO DE TELÉFONO
// ==========================================
const formatearTelefonoParaMostrar = (telefono) => {
  let limpio = telefono.replace(/\D/g, '');
  
  if (limpio.startsWith('595')) {
    limpio = limpio.substring(3);
  }
  
  if (limpio.length > 3) {
    return limpio.substring(0, 3) + ' ' + limpio.substring(3);
  }
  return limpio;
};

const formatearTelefonoParaGuardar = (telefono) => {
  let limpio = telefono.replace(/\D/g, '');
  
  if (limpio.startsWith('595')) {
    return limpio;
  }
  
  if (limpio.startsWith('0')) {
    limpio = limpio.substring(1);
  }
  
  return '595' + limpio;
};

// ==========================================
// VALIDACIONES
// ==========================================
const validarCamposRequeridos = (datos) => {
  if (!datos.nombre || datos.nombre.trim() === '') {
    return { valido: false, mensaje: 'El nombre es obligatorio.' };
  }
  if (!datos.apellido || datos.apellido.trim() === '') {
    return { valido: false, mensaje: 'El apellido es obligatorio.' };
  }
  if (!datos.cedula_entidad || datos.cedula_entidad.trim() === '') {
    return { valido: false, mensaje: 'El número de cédula es obligatorio.' };
  }
  if (!datos.fecha_nacimiento) {
    return { valido: false, mensaje: 'La fecha de nacimiento es obligatoria.' };
  }
  if (!datos.id_ciudad) {
    return { valido: false, mensaje: 'Debe seleccionar una ciudad.' };
  }
  if (!datos.telefono || datos.telefono.trim() === '') {
    return { valido: false, mensaje: 'El teléfono es obligatorio.' };
  }
  if (!datos.fecha_registro) {
    return { valido: false, mensaje: 'La fecha de registro es obligatoria.' };
  }
  return { valido: true };
};

const validarEmail = (email) => {
  if (!email || email.trim() === '') return { valido: true };
  
  const patron = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!patron.test(email)) {
    return { valido: false, mensaje: 'El formato del correo electrónico no es válido.' };
  }
  return { valido: true };
};

const validarTelefono = () => {
  $('#telefono').on('keypress', function(e) {
    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
        (e.keyCode === 65 && e.ctrlKey === true) ||
        (e.keyCode === 67 && e.ctrlKey === true) ||
        (e.keyCode === 86 && e.ctrlKey === true) ||
        (e.keyCode === 88 && e.ctrlKey === true)) {
      return;
    }
    if ((e.which < 48 || e.which > 57)) {
      e.preventDefault();
    }
  });

  $('#telefono').on('input', function(e) {
    const input = e.target;
    let valor = input.value.replace(/\D/g, '');
    
    if (valor.length > 9) {
      valor = valor.substring(0, 9);
    }
    
    if (valor.length > 3) {
      input.value = valor.substring(0, 3) + ' ' + valor.substring(3);
    } else {
      input.value = valor;
    }
  });

  $('#telefono').on('paste', function(e) {
    setTimeout(() => {
      let valor = this.value.replace(/\D/g, '');
      if (valor.length > 9) valor = valor.substring(0, 9);
      if (valor.length > 3) {
        this.value = valor.substring(0, 3) + ' ' + valor.substring(3);
      } else {
        this.value = valor;
      }
    }, 0);
  });
};

const validarCedula = () => {
  $('#cedula').on('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
  });
};

// ==========================================
// CRUD
// ==========================================
const agregar = () => {
  $('#btnAgregar').on('click', function() {
    $('#modalTitle').text("Nuevo Paciente");
    $('#formPaciente')[0].reset();
    $('#txtIdPaciente').val("");
    $('#id_ciudad').val("");
    $('#txtCiudad').val("");
    
    $('#modalFormulario').modal('show');
  });
};

const guardar = () => {
  $('#btnGuardar').on('click', function() {
    const idPaciente = $('#txtIdPaciente').val();
    const datos = {
      nombre: $('#nombre').val().trim(),
      apellido: $('#apellido').val().trim(),
      cedula_entidad: $('#cedula').val().trim(),
      fecha_nacimiento: $('#fecha_nacimiento').val(),
      fecha_registro: $('#fecha_registro').val(),
      telefono: formatearTelefonoParaGuardar($('#telefono').val().trim()),
      direccion: $('#direccion').val().trim(),
      correo: $('#correo').val().trim(),
      id_ciudad: $('#id_ciudad').val()
    };

    const validacionCampos = validarCamposRequeridos(datos);
    if (!validacionCampos.valido) {
      Swal.fire({
        icon: 'warning',
        title: 'Campos incompletos',
        text: validacionCampos.mensaje,
        confirmButtonColor: '#f39c12'
      });
      return;
    }

    if (datos.correo) {
      const validacionEmail = validarEmail(datos.correo);
      if (!validacionEmail.valido) {
        Swal.fire({
          icon: 'warning',
          title: 'Correo inválido',
          text: validacionEmail.mensaje,
          confirmButtonColor: '#f39c12'
        });
        return;
      }
    }

    const url = idPaciente ? `/api/v1/paciente/${idPaciente}` : '/api/v1/paciente';
    const method = idPaciente ? 'PUT' : 'POST';
    const tabla = $('#tbl').DataTable();

    fetch(url, {
      method: method,
      headers: { 
        'Content-Type': 'application/json', 
        'X-CSRFToken': CSRFToken 
      },
      body: JSON.stringify(datos)
    })
    .then(resp => resp.json())
    .then(result => {
      if (result && !result.error && result.success) {
        tabla.ajax.reload();
        $('#modalFormulario').modal('hide');
        Swal.fire({
          icon: 'success',
          title: idPaciente ? 'Actualizado' : 'Registrado',
          text: `El paciente ha sido ${idPaciente ? 'actualizado' : 'registrado'} correctamente.`,
          confirmButtonColor: '#28a745'
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: result.error || 'No se pudo guardar el paciente.',
          confirmButtonColor: '#dc3545'
        });
      }
    })
    .catch(err => {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Error de conexión',
        text: 'Ocurrió un error al guardar. Por favor, intente nuevamente.',
        confirmButtonColor: '#dc3545'
      });
    });
  });
};

const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function() {
    const idPaciente = $(this).data('id_paciente');

    Swal.fire({
      title: "¿Deseas editar este registro?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: "Sí, editar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: '#17a2b8',
      cancelButtonColor: '#6c757d'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/v1/paciente/${idPaciente}`)
        .then(resp => resp.json())
        .then(data => {
          if (data && data.success && data.data) {
            const p = data.data;
            $('#modalTitle').text("Editar Paciente");
            $('#txtIdPaciente').val(p.id_paciente);
            $('#nombre').val(p.nombre);
            $('#apellido').val(p.apellido);
            $('#cedula').val(p.cedula_entidad);
            $('#fecha_nacimiento').val(p.fecha_nacimiento);
            $('#fecha_registro').val(p.fecha_registro);
            $('#telefono').val(formatearTelefonoParaMostrar(p.telefono || ''));
            $('#direccion').val(p.direccion);
            $('#correo').val(p.correo);
            $('#id_ciudad').val(p.id_ciudad);
            $('#txtCiudad').val(p.ciudad);
            $('#modalFormulario').modal('show');
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo cargar el paciente.',
              confirmButtonColor: '#dc3545'
            });
          }
        })
        .catch(err => {
          console.error(err);
          Swal.fire({
            icon: 'error',
            title: 'Error de conexión',
            text: 'Ocurrió un error al cargar el paciente.',
            confirmButtonColor: '#dc3545'
          });
        });
      }
    });
  });
};

const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
    const idPaciente = $(this).data('id_paciente');
    const botonEliminar = $(this);

    Swal.fire({
      title: "¿Deseas eliminar este paciente?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/v1/paciente/${idPaciente}`, {
          method: 'DELETE',
          headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': CSRFToken 
          }
        })
        .then(resp => resp.json())
        .then(result => {
          if (result && !result.error && result.success) {
            const fila = botonEliminar.closest('tr');
            const tabla = $('#tbl').DataTable();
            tabla.row(fila).remove().draw();
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'El paciente ha sido eliminado correctamente.',
              confirmButtonColor: '#28a745'
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error al eliminar',
              text: result.error || 'No se pudo eliminar el paciente.',
              confirmButtonColor: '#dc3545'
            });
          }
        })
        .catch(err => {
          console.error(err);
          Swal.fire({
            icon: 'error',
            title: 'Error de conexión',
            text: 'Ocurrió un error al eliminar. Por favor, intente nuevamente.',
            confirmButtonColor: '#dc3545'
          });
        });
      }
    });
  });
};

// ==========================================
// EVENTOS ADICIONALES
// ==========================================
const buscarCiudad = () => {
  $('#txtCiudad').on('click', function() {
    $('#modalBuscarCiudad').modal('show');
    initDatatablec();
  });
};

// ==========================================
// FIX MODAL
// ==========================================
const fixModalShift = () => {
  $.fn.modal.Constructor.prototype._setScrollbar = function() {};
  $.fn.modal.Constructor.prototype._resetScrollbar = function() {};
  
  $(document).on('show.bs.modal', '.modal', function () {
    setTimeout(() => {
      $('body').css('padding-right', '0');
      $('.modal').css('padding-right', '0');
      $('.navbar-fixed-top, .navbar-fixed-bottom').css('padding-right', '0');
    }, 0);
  });

  $(document).on('hidden.bs.modal', '.modal', function () {
    $('body').css('padding-right', '0');
  });
};

// ==========================================
// INICIALIZACIÓN
// ==========================================
$(function() {
  initDatatable();
  initDatatablec();
  
  agregar();
  guardar();
  editar();
  eliminar();
  buscarCiudad();
  validarTelefono();
  validarCedula();
  fixModalShift();
});
</script>
{% endblock %}