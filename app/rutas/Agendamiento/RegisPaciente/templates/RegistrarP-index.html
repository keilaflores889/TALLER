{% extends 'base.html' %}

{% block titulo %}
Registrar Paciente
{% endblock %}

{% block contenido %}
<div class="container mt-4">
  <h3>Datos del Paciente</h3>

  <!-- Tarjeta -->
  <div class="card">
    <div class="card-header">
      <button type="button" class="btn btn-outline-info" id="btnAgregar">Agregar Paciente</button>
    </div>
    <div class="card-body">
      <table class="table table-striped" id="tbl">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>N° Cedula</th>
            <th>Fecha de Nacimiento</th>
            <th>Teléfono</th>
            <th>Fecha de Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <!-- /Tarjeta -->

  <!-- Modal -->
  <div class="modal" id="modalFormulario">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <!-- Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitle">Registrar Paciente</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <!-- Cuerpo -->
        <div class="modal-body">
          <div class="row">
            <!-- Campo Nombre -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="nombre">Nombre:</label>
                <input type="text" id="nombre" class="form-control" placeholder="Ingrese el nombre">
              </div>
            </div>
            <!-- Campo Apellido -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="apellido">Apellido:</label>
                <input type="text" id="apellido" class="form-control" placeholder="Ingrese el apellido">
              </div>
            </div>
          </div>
          <div class="row">
            <!-- Campo Documento -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="documento">Documento de Identidad:</label>
                <input type="text" id="documento" class="form-control" placeholder="Ingrese el documento">
              </div>
            </div>
            <!-- Campo Fecha de Nacimiento -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="fechaNacimiento">Fecha de Nacimiento:</label>
                <input type="date" id="fechaNacimiento" class="form-control">
              </div>
            </div>
          </div>
          <div class="row">
            <!-- Campo Teléfono -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="telefono">Teléfono:</label>
                <input type="text" id="telefono" class="form-control" placeholder="Ingrese el teléfono">
              </div>
            </div>
            <!-- Campo Fecha de Registro -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="fechaRegistro">Fecha de Registro:</label>
                <input type="date" id="fechaRegistro" class="form-control">
              </div>
            </div>
          </div>
          <div class="row">
            <!-- Campo Ciudad -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="ciudad">Ciudad:</label>
                <input type="text" id="ciudad" class="form-control" placeholder="Ingrese la ciudad">
              </div>
            </div>
            <!-- Campo Barrio -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="barrio">Barrio:</label>
                <input type="text" id="barrio" class="form-control" placeholder="Ingrese el barrio">
              </div>
            </div>
          </div>
        </div>
        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Librerías necesarias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock %}


{% block js %}
<script>
  $(document).ready(function () {
    const STORAGE_KEY = 'pacientes'; // Clave para localStorage
    let pacientes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; // Cargar datos existentes o iniciar vacío

    // Inicializar DataTable
    const tabla = $('#tbl').DataTable({
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
      },
      columns: [
        { title: 'Nombre' },
        { title: 'Apellido' },
        { title: 'Documento' },
        { title: 'Fecha Nacimiento' },
        { title: 'Teléfono' },
        { title: 'Fecha Registro' },
       
        { title: 'Acciones', orderable: false }
      ],
    });

    // Función para cargar datos en la tabla
    const cargarTabla = () => {
      tabla.clear();
      pacientes.forEach((item, index) => {
        tabla.row.add([
          item.nombre,
          item.apellido,
          item.documento,
          item.fechaNacimiento,
          item.telefono,
          item.fechaRegistro,
          
          `<button class="btn btn-info btnEditar" data-index="${index}" title="Editar">
          <i class="fas fa-pencil-alt"></i>
          </button>
          <button class="btn btn-danger btnEliminar" data-index="${index}" title="Eliminar">
          <i class="fas fa-trash"></i>
          </button>`,
        ]);
      });
      tabla.draw();
    };

    // Guardar cambios en localStorage
    const guardarLocalStorage = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pacientes));
    };

    // Cargar tabla al iniciar
    cargarTabla();

    // Abrir modal para agregar
    $('#btnAgregar').on('click', function () {
      $('#modalFormulario').data('index', undefined).modal('show');
      $('#nombre, #apellido, #documento, #fechaNacimiento, #telefono, #fechaRegistro, #ciudad, #barrio').val('');
    });

    // Guardar datos del modal
    $('#btnGuardar').on('click', function () {
      const nombre = $('#nombre').val();
      const apellido = $('#apellido').val();
      const documento = $('#documento').val();
      const fechaNacimiento = $('#fechaNacimiento').val();
      const telefono = $('#telefono').val();
      const fechaRegistro = $('#fechaRegistro').val();
      const ciudad = $('#ciudad').val();
      const barrio = $('#barrio').val();
      const index = $('#modalFormulario').data('index');

      if (!nombre || !apellido || !documento || !telefono || !fechaRegistro || !ciudad || !barrio) {
        Swal.fire('Error', 'Por favor complete todos los campos obligatorios.', 'error');
        return;
      }

      const nuevoPaciente = { nombre, apellido, documento, fechaNacimiento, telefono, fechaRegistro, ciudad, barrio };

      if (index !== undefined) {
        pacientes[index] = nuevoPaciente; // Actualizar
      } else {
        pacientes.push(nuevoPaciente); // Agregar nuevo
      }

      guardarLocalStorage(); // Guardar cambios en almacenamiento local
      $('#modalFormulario').modal('hide');
      cargarTabla(); // Recargar tabla con los datos actualizados
    });

    // Editar registro
    $('#tbl').on('click', '.btnEditar', function () {
      const index = $(this).data('index');
      const registro = pacientes[index];
      $('#modalFormulario').data('index', index).modal('show');
      $('#nombre').val(registro.nombre);
      $('#apellido').val(registro.apellido);
      $('#documento').val(registro.documento);
      $('#fechaNacimiento').val(registro.fechaNacimiento);
      $('#telefono').val(registro.telefono);
      $('#fechaRegistro').val(registro.fechaRegistro);
      $('#ciudad').val(registro.ciudad);
      $('#barrio').val(registro.barrio);
    });

    // Eliminar registro
    $('#tbl').on('click', '.btnEliminar', function () {
      const index = $(this).data('index');
      Swal.fire({
        title: '¿Está seguro de eliminar este registro?',
        showCancelButton: true,
        confirmButtonText: 'Sí',
        cancelButtonText: 'No',
      }).then((result) => {
        if (result.isConfirmed) {
          pacientes.splice(index, 1);
          guardarLocalStorage();
          cargarTabla();
          Swal.fire('Eliminado', 'El registro ha sido eliminado.', 'success');
        }
      });
    });
  });
</script>
{% endblock %}


