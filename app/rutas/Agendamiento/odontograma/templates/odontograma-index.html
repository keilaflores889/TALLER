{% extends 'base.html' %}

{% block titulo %}
Odontogramas
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">
    <!-- Header: Botón y Título -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-light btn-sm" id="btnNuevo">
        <i class="fas fa-plus-circle mr-1"></i> Nuevo Odontograma
      </button>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-tooth mr-2"></i> Listar Odontogramas
      </h5>
    </div>

    <!-- Body: Tabla de odontogramas -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered align-middle text-center" id="tbl">
          <thead class="bg-info text-white">
            <tr>
              <th>Paciente</th>
              <th>Cédula</th>
              <th>Edad</th>
              <th>Médico</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Odontograma -->
  <!-- =========================== -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 1300px;" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top d-flex justify-content-between align-items-center">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-tooth mr-2"></i> <span id="modalTitle">Agregar Odontograma</span>
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form id="formOdontograma">
            <input type="hidden" id="id_odontograma" name="id_odontograma" />
            <input type="hidden" id="id_paciente" name="id_paciente" />
            <input type="hidden" id="id_medico" name="id_medico" />

            <!-- Paciente -->
            <div class="form-group mb-3">
              <label class="font-weight-bold">Paciente: <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="paciente" readonly placeholder="Click para seleccionar paciente">
            </div>

            <div class="row">
              <!-- Columna izquierda -->
              <div class="col-md-6">
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Cédula:</label>
                  <input type="text" class="form-control" id="cedula" readonly>
                </div>
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Edad:</label>
                  <input type="text" class="form-control" id="edad" readonly>
                </div>
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Médico: <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="medico" readonly placeholder="Click para seleccionar médico">
                </div>
              </div>

              <!-- Columna derecha -->
              <div class="col-md-6">
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Fecha Registro:</label>
                  <input type="date" class="form-control" id="fecha_registro" name="fecha_registro" required>
                </div>
                <div class="form-group mb-3">
                  <label class="font-weight-bold">Estado:</label>
                  <select id="estado" name="estado" class="form-control">
                    <option value="Activo">Activo</option>
                    <option value="Finalizado">Finalizado</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-group mb-3">
              <label class="font-weight-bold">Observaciones:</label>
              <textarea class="form-control" id="observaciones" rows="2"></textarea>
            </div>

            <h5 class="mt-3 text-center">ODONTOGRAMA</h5>
            <div class="d-flex justify-content-center">
              <div id="leyendaOdontograma" class="mr-4"></div>
              <svg id="odontogramaSVG" width="1800" height="800">
                <!-- ================= Arcada Superior Permanente ================= -->
                <text x="10" y="30" font-size="16" font-weight="bold">Arcada Superior Permanente</text>
                {% set sup_perm = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28] %}
                {% for i in sup_perm %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},50)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}

                <!-- ================= Arcada Superior Temporal ================= -->
                <text x="10" y="180" font-size="16" font-weight="bold">Arcada Superior Temporal</text>
                {% set sup_temp = [55,54,53,52,51,61,62,63,64,65] %}
                {% for i in sup_temp %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},200)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}

                <!-- ================= Arcada Inferior Temporal ================= -->
                <text x="10" y="330" font-size="16" font-weight="bold">Arcada Inferior Temporal</text>
                {% set inf_temp = [85,84,83,82,81,71,72,73,74,75] %}
                {% for i in inf_temp %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},350)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}

                <!-- ================= Arcada Inferior Permanente ================= -->
                <text x="10" y="480" font-size="16" font-weight="bold">Arcada Inferior Permanente</text>
                {% set inf_perm = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38] %}
                {% for i in inf_perm %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},500)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}
              </svg>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-info" id="btnGuardar">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Modal Selección de Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Seleccionar Paciente</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <table id="tblPacientes" class="table table-striped table-bordered w-100">
          <thead class="table-info">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Cédula</th>
              <th>Acción</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Selección de Médico -->
<div class="modal fade" id="modalMedico" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Seleccionar Médico</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <table id="tblMedicos" class="table table-striped table-bordered w-100">
          <thead class="table-info">
            <tr>
              <th>Nombre</th>
                <th>Apellido</th>
                <th>Acciones</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Librerías -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;
let odontogramaData = [];

// Leyenda de estados dentales
const estadosOdontograma = {
  1: { nombre: 'Sano', color: '#FFFFFF' },
  2: { nombre: 'Caries', color: '#8B4513' },
  3: { nombre: 'Obturación', color: '#C0C0C0' },
  4: { nombre: 'Extracción indicada', color: '#FFA500' },
  5: { nombre: 'Extraído', color: '#ff0000ff' },
  6: { nombre: 'Endodoncia', color: '#FF1493' }
};

const superficiesDentales = {
  'O': 'Oclusal',
  'V': 'Vestibular', 
  'L': 'Lingual',
  'M': 'Mesial',
  'D': 'Distal'
};

const generarLeyenda = () => {
  let leyendaHTML = '<h6>Estados:</h6><ul class="list-unstyled">';
  for (const key in estadosOdontograma) {
    const estado = estadosOdontograma[key];
    leyendaHTML += `
      <li class="mb-1 d-flex align-items-center">
        <span style="display:inline-block;width:20px;height:20px;background:${estado.color};margin-right:8px;border:1px solid #000;"></span>
        <span>${estado.nombre}</span>
      </li>
    `;
  }
  leyendaHTML += '</ul>';
  
  leyendaHTML += '<h6>Superficies:</h6><ul class="list-unstyled">';
  for (const abrev in superficiesDentales) {
    const superficie = superficiesDentales[abrev];
    leyendaHTML += `<li class="mb-1"><strong>${abrev}:</strong> ${superficie}</li>`;
  }
  leyendaHTML += '</ul>';
  
  document.getElementById('leyendaOdontograma').innerHTML = leyendaHTML;
};

// Tabla principal
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/odontograma', dataSrc: 'data' },
    columns: [
      
      { data: 'paciente' },
      { data: 'cedula' },
      { data: 'edad' },
      { data: 'medico' },
      { data: 'fecha_registro', render: (data) => new Date(data).toLocaleDateString() },
      { data: 'estado', render: function(data) {
        if(data === "Activo") {
          return '<span style="color: #155724; background-color: #d4edda; padding: 2px 6px; border-radius: 4px;">Activo</span>';
        } else {
          return '<span style="color: #721c24; background-color: #f8d7da; padding: 2px 6px; border-radius: 4px;">Finalizado</span>';
        }
      }},
      { data: 'observaciones' },
      { data: null, render: (data, type, row) => `
        <button class="btn btn-sm btn-success" name="btn_ver" data-id="${row.id_odontograma}" title="Ver Odontograma">
          <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-info btn-sm" name="btn_editar" data-id="${row.id_odontograma}" title="Editar">
          <i class="fas fa-edit"></i> 
        </button>
        <button class="btn btn-danger btn-sm" name="btn_eliminar" data-id="${row.id_odontograma}" title="Eliminar">
          <i class="fas fa-trash-alt"></i> 
        </button>
      `}
    ]
  });
};

// Formatear fecha
function formatearFechaParaInput(fechaStr) {
  if (!fechaStr) return '';
  try {
    const fecha = new Date(fechaStr);
    if (isNaN(fecha.getTime())) return '';
    
    const año = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    
    return `${año}-${mes}-${dia}`;
  } catch (error) {
    console.error('Error formateando fecha:', error);
    return '';
  }
}

function recolectarOdontograma() {
  let datos = [];
  $("#odontogramaSVG g").each(function () {
    const diente = $(this).data("diente");
    $(this).find("rect").each(function () {
      const superficie = $(this).data("superficie");
      const fill = $(this).attr("fill");
      if (fill && fill !== "white" && fill !== "#FFFFFF") {
        let estado = 1;
        if (fill === "#8B4513" || fill === "rgb(139, 69, 19)") estado = 2;
        if (fill === "#C0C0C0" || fill === "rgb(192, 192, 192)") estado = 3;
        if (fill === "#FFA500" || fill === "rgb(255, 165, 0)") estado = 4;
        if (fill === "#ff0000ff" || fill === "hsla(0, 100%, 50%, 1.00)") estado = 5;
        if (fill === "#FF1493" || fill === "rgb(255, 20, 147)") estado = 6;

        datos.push({
          diente: diente,
          superficie: superficie,
          estado: estado
        });
      }
    });
  });
  return datos;
}

// Botón nuevo
$('#btnNuevo').on('click', () => {
  $('#modalTitle').text("Agregar Odontograma");
  $('#formOdontograma')[0].reset();
  $('#id_odontograma').val('');
  $('#id_paciente').val('');
  $('#id_medico').val('');
  odontogramaData = [];
  $('#odontogramaSVG rect').attr("fill", "white");
  $('#fecha_registro').val(new Date().toISOString().split('T')[0]);
  $('#modalFormulario').modal('show');
});

// Abrir modal al hacer click
$('#modalFormulario').on('shown.bs.modal', function () {
  generarLeyenda();
});

// --- DataTable Pacientes ---
const initDatatablePaciente = () => {
  $('#tblPacientes').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/paciente', dataSrc: 'data' },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula_entidad' },
      { data: null, render: row => `
        <button type="button" name="btn_seleccionar_Paciente" class="btn btn-primary btn-sm" 
          data-id="${row.id_paciente}" 
          data-nombre="${row.nombre}" 
          data-apellido="${row.apellido}" 
          data-cedula="${row.cedula_entidad}"
          data-fecha_nacimiento="${row.fecha_nacimiento}">
          Seleccionar
        </button>` }
    ]
  });

  $('#tblPacientes').on('click', 'button[name="btn_seleccionar_Paciente"]', function () {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    const cedula = $(this).data('cedula');
    const fecha_nac = $(this).data('fecha_nacimiento');

    // Calcular edad automáticamente
    let edad = '';
    if(fecha_nac){
      const f = new Date(fecha_nac);
      const today = new Date();
      edad = today.getFullYear() - f.getFullYear();
      const m = today.getMonth() - f.getMonth();
      if(m < 0 || (m === 0 && today.getDate() < f.getDate())) edad--;
    }

    // Setear valores en el formulario
    $('#paciente').val(`${nombre} ${apellido}`);
    $('#id_paciente').val(id);
    $('#cedula').val(cedula);
    $('#edad').val(edad);
    $('#modalPaciente').modal('hide');
  });
};

// Click en paciente
$("#paciente").on("click", function() {
  $('#modalPaciente').modal('show');
  if (!$.fn.DataTable.isDataTable('#tblPacientes')) {
    initDatatablePaciente();
  }
});

// --- DataTable Médicos ---
const initDatatableMedico = () => {
  $('#tblMedicos').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/medico', dataSrc: 'data' },
    columns:[
      { data: 'nombre' },
      { data: 'apellido' },
      { data: null, render: row => `
        <button class="btn btn-primary btn-sm" name="btn_seleccionar_Medico"
          data-id="${row.id_medico}"
          data-nombre="${row.nombre}"
          data-apellido="${row.apellido}">
          Seleccionar
        </button>` }
    ]
  });

  $('#tblMedicos').on('click','button[name="btn_seleccionar_Medico"]', function(){
    $('#id_medico').val($(this).data('id'));
    $('#medico').val(`${$(this).data('nombre')} ${$(this).data('apellido')}`);
    $('#modalMedico').modal('hide');
  });
};

// Click en médico
$("#medico").on("click", function() {
  $('#modalMedico').modal('show');
  if (!$.fn.DataTable.isDataTable('#tblMedicos')) {
    initDatatableMedico();
  }
});

// Selección de superficie
$(document).on("click", "#odontogramaSVG rect", function() {
  const diente = $(this).closest("g").data("diente");
  const superficie = $(this).data("superficie");

  Swal.fire({
    title: `Diente ${diente} - ${superficie}`,
    input: 'select',
    inputOptions: {
      1: 'Sano',
      2: 'Caries',
      3: 'Obturación',
      4: 'Extracción indicada',
      5: 'Extraído',
      6: 'Endodoncia'
    },
    inputPlaceholder: 'Seleccione estado',
    showCancelButton: true
  }).then(result => {
    if (result.isConfirmed) {
      const estado = result.value;
      const color = estadosOdontograma[estado].color;
      $(this).attr("fill", color);
    }
  });
});

// Guardar
$("#btnGuardar").click(() => {
  const id = $("#id_odontograma").val();
  const id_paciente = $("#id_paciente").val();
  const id_medico = $("#id_medico").val();

  if (!id_paciente) {
    Swal.fire("Advertencia", "Debe seleccionar un paciente", "warning");
    return;
  }
  if (!id_medico) {
    Swal.fire("Advertencia", "Debe seleccionar un médico", "warning");
    return;
  }

  const payload = {
    id_paciente: parseInt(id_paciente),
    id_medico: parseInt(id_medico),
    fecha_registro: $("#fecha_registro").val(),
    estado: $("#estado").val(),
    observaciones: $("#observaciones").val(),
    detalles: recolectarOdontograma()
  };

  let url = "/api/v1/odontograma";
  let method = "POST";

  if (id) {
    url = `/api/v1/odontograma/${id}`;
    method = "PUT";
  }

  fetch(url, {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": CSRFToken
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      $('#modalFormulario').modal('hide');
      $('#tbl').DataTable().ajax.reload();
      odontogramaData = [];
      Swal.fire("Éxito", "Odontograma guardado correctamente", "success");
    } else {
      Swal.fire("Error", data.error, "error");
    }
  });
});

// VER ODONTOGRAMA
$('#tbl').on('click', 'button[name="btn_ver"]', function() {
  const id = $(this).data('id');
  
  fetch(`/api/v1/odontograma/${id}`)
    .then(resp => resp.json())
    .then(data => {
      const o = data.data;
      
      const modalHTML = `
        <div class="modal fade" id="modalVerOdontograma" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-xl" role="document" style="max-width: 1300px;">
            <div class="modal-content">
              <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                  <i class="fas fa-tooth"></i> Odontograma - ${o.paciente}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header"><h6><i class="fas fa-user"></i> Información del Paciente</h6></div>
                      <div class="card-body">
                        <p><strong>Paciente:</strong> ${o.paciente}</p>
                        <p><strong>Cédula:</strong> ${o.cedula}</p>
                        <p><strong>Edad:</strong> ${o.edad} años</p>
                        <p><strong>Médico:</strong> ${o.medico}</p>
                        <p><strong>Fecha:</strong> ${new Date(o.fecha_registro).toLocaleDateString()}</p>
                        <p><strong>Estado:</strong> <span class="badge badge-success">${o.estado}</span></p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header"><h6><i class="fas fa-info-circle"></i> Leyenda</h6></div>
                      <div class="card-body"><div id="leyendaVer"></div></div>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header"><h6><i class="fas fa-teeth"></i> Odontograma</h6></div>
                      <div class="card-body text-center">
                        <div id="odontogramaVer" style="border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; background-color: #f8f9fa;"></div>
                      </div>
                    </div>
                  </div>
                </div>
                
                ${o.observaciones ? `
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header"><h6><i class="fas fa-comment"></i> Observaciones</h6></div>
                      <div class="card-body"><p>${o.observaciones}</p></div>
                    </div>
                  </div>
                </div>
                ` : ''}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                  <i class="fas fa-times"></i> Cerrar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      $('#modalVerOdontograma').remove();
      $('body').append(modalHTML);
      
      let leyendaHTML = '<h6>Estados:</h6><ul class="list-unstyled mb-2">';
      for (const key in estadosOdontograma) {
        const estado = estadosOdontograma[key];
        leyendaHTML += `
          <li class="mb-1 d-flex align-items-center">
            <span style="display:inline-block;width:15px;height:15px;background:${estado.color};margin-right:5px;border:1px solid #000;"></span>
            <small>${estado.nombre}</small>
          </li>
        `;
      }
      leyendaHTML += '</ul>';
      
      leyendaHTML += '<h6>Superficies:</h6><ul class="list-unstyled">';
      for (const abrev in superficiesDentales) {
        const superficie = superficiesDentales[abrev];
        leyendaHTML += `<li class="mb-1"><small><strong>${abrev}:</strong> ${superficie}</small></li>`;
      }
      leyendaHTML += '</ul>';
      
      $('#leyendaVer').html(leyendaHTML);
      
      if ($('#odontogramaSVG').length > 0) {
        const svgClone = $('#odontogramaSVG').clone();
        svgClone.attr('id', 'odontogramaSVGVer');
        svgClone.find('rect').attr('fill', 'white');
        
        if (o.detalles && Array.isArray(o.detalles)) {
          o.detalles.forEach(d => {
            const color = estadosOdontograma[d.id_estado_dental]?.color || "#FFFFFF";
            svgClone.find(`g[data-diente="${d.numero_diente}"] rect[data-superficie="${d.superficie}"]`)
              .attr("fill", color);
          });
        }
        
        $('#odontogramaVer').html(svgClone);
      } else {
        $('#odontogramaVer').html('<p class="text-muted">No se pudo cargar el odontograma visual</p>');
      }
      
      $('#modalVerOdontograma').modal('show');
    })
    .catch(error => {
      console.error('Error cargando odontograma:', error);
      Swal.fire("Error", "No se pudo cargar el odontograma", "error");
    });
});

// EDITAR
$('#tbl').on('click', 'button[name="btn_editar"]', function() {
  const id = $(this).data('id');
  fetch(`/api/v1/odontograma/${id}`)
    .then(resp => resp.json())
    .then(data => {
      const o = data.data;
      
      $('#modalTitle').text("Editar Odontograma");
      $('#id_odontograma').val(o.id_odontograma);
      $('#id_paciente').val(o.id_paciente);
      $('#id_medico').val(o.id_medico);
      $('#paciente').val(o.paciente);
      $('#medico').val(o.medico);
      $('#cedula').val(o.cedula);
      $('#edad').val(o.edad);
      $('#estado').val(o.estado);
      $('#observaciones').val(o.observaciones);

      const fechaFormateada = formatearFechaParaInput(o.fecha_registro);
      if (fechaFormateada) {
        $('#fecha_registro').val(fechaFormateada);
      }

      // ✅ IMPORTANTE: Cargar los detalles en odontogramaData
      odontogramaData = [];
      $('#odontogramaSVG rect').attr("fill", "white");

      if (o.detalles && o.detalles.length > 0) {
        o.detalles.forEach(d => {
          // Agregar a odontogramaData con el formato correcto
          odontogramaData.push({
            diente: d.numero_diente,
            estado: d.id_estado_dental,
            superficie: d.superficie || 'C'
          });

          // Pintar el diente en el SVG
          const color = estadosOdontograma[d.id_estado_dental]?.color || "#FFFFFF";
          $(`#odontogramaSVG g[data-diente="${d.numero_diente}"] rect[data-superficie="${d.superficie}"]`)
            .attr("fill", color);
        });
      }

      $('#modalFormulario').modal('show');
    })
    .catch(error => {
      console.error('Error cargando odontograma:', error);
      Swal.fire("Error", "No se pudo cargar el odontograma", "error");
    });
});

// Eliminar
$('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
  const id = $(this).data('id');
  Swal.fire({
    title: "¿Eliminar odontograma?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Sí, eliminar",
    cancelButtonText: "Cancelar"
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`/api/v1/odontograma/${id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFToken }
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          $('#tbl').DataTable().ajax.reload();
          Swal.fire("Eliminado", "Odontograma eliminado correctamente", "success");
        } else {
          Swal.fire("Error", data.error, "error");
        }
      });
    }
  });
});

$(function() {
  initDatatable();
});
</script>
{% endblock %}


