{% extends 'base.html' %}

{% block titulo %}
Odontogramas
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">
    <!-- Header: Bot√≥n y T√≠tulo -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-light btn-sm" id="btnNuevo">
        <i class="fas fa-plus-circle mr-1"></i> Nuevo Odontograma
      </button>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-tooth mr-2"></i> Listar Odontogramas
      </h5>
    </div>

    <!-- Body: Tabla de odontogramas -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered align-middle text-center" id="tbl">
          <thead class="bg-info text-white">
            <tr>
              <th>Paciente</th>
              <th>C√©dula</th>
              <th>Edad</th>
              <th>M√©dico</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Odontograma -->
  <!-- =========================== -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 1300px;" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top d-flex justify-content-between align-items-center">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-tooth mr-2"></i> <span id="modalTitle">Agregar Odontograma</span>
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form id="formOdontograma">
            <input type="hidden" id="id_odontograma" name="id_odontograma" />
            <input type="hidden" id="id_paciente" name="id_paciente" />
            <input type="hidden" id="id_medico" name="id_medico" />

            <!-- Paciente -->
              <div class="form-group mb-3">
                <label class="font-weight-bold">
                  <i class="fas fa-user mr-1"></i> Paciente: <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="paciente" readonly placeholder="Click para seleccionar paciente">
              </div>

              <div class="row">
                <!-- Columna izquierda -->
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label class="font-weight-bold">
                      <i class="fas fa-id-card mr-1"></i> C√©dula:
                    </label>
                    <input type="text" class="form-control" id="cedula" readonly>
                  </div>
                  <div class="form-group mb-3">
                    <label class="font-weight-bold">
                      <i class="fas fa-birthday-cake mr-1"></i> Edad:
                    </label>
                    <input type="text" class="form-control" id="edad" readonly>
                  </div>
                  <div class="form-group mb-3">
                    <label class="font-weight-bold">
                      <i class="fas fa-user-md mr-1"></i> M√©dico: <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="medico" readonly placeholder="Click para seleccionar m√©dico">
                  </div>
                </div>

                <!-- Columna derecha -->
                <div class="col-md-6">
                  <div class="form-group mb-3">
                    <label class="font-weight-bold">
                      <i class="fas fa-calendar-plus mr-1"></i> Fecha Registro: <span class="text-danger">*</span>
                    </label>
                    <input type="date" class="form-control" id="fecha_registro" name="fecha_registro" required>
                  </div>
                  <div class="form-group mb-3">
                    <label class="font-weight-bold">
                      <i class="fas fa-info-circle mr-1"></i> Estado: <span class="text-danger">*</span>
                    </label>
                    <select id="estado" name="estado" class="form-control">
                      <option value="Activo">Activo</option>
                      <option value="Finalizado">Finalizado</option>
                    </select>
                  </div>
                </div>
              </div>

            <div class="form-group mb-3">
              <label class="font-weight-bold">Observaciones:</label>
              <textarea class="form-control" id="observaciones" rows="2"></textarea>
            </div>

            <h5 class="mt-3 text-center">ODONTOGRAMA</h5>
            <div class="d-flex justify-content-center">
              <div id="leyendaOdontograma" class="mr-4"></div>
              <svg id="odontogramaSVG" width="1800" height="800">
                <!-- ================= Arcada Superior Permanente ================= -->
                <text x="10" y="30" font-size="16" font-weight="bold">Arcada Superior Permanente</text>
                {% set sup_perm = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28] %}
                {% for i in sup_perm %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},50)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}

                <!-- ================= Arcada Superior Temporal ================= -->
                <text x="10" y="180" font-size="16" font-weight="bold">Arcada Superior Temporal</text>
                {% set sup_temp = [55,54,53,52,51,61,62,63,64,65] %}
                {% for i in sup_temp %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},200)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}

                <!-- ================= Arcada Inferior Temporal ================= -->
                <text x="10" y="330" font-size="16" font-weight="bold">Arcada Inferior Temporal</text>
                {% set inf_temp = [85,84,83,82,81,71,72,73,74,75] %}
                {% for i in inf_temp %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},350)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}

                <!-- ================= Arcada Inferior Permanente ================= -->
                <text x="10" y="480" font-size="16" font-weight="bold">Arcada Inferior Permanente</text>
                {% set inf_perm = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38] %}
                {% for i in inf_perm %}
                <g data-diente="{{ i }}" transform="translate({{ loop.index0*70+80 }},500)">
                  <rect x="0" y="0" width="40" height="20" fill="white" stroke="black" data-superficie="O"></rect>
                  <rect x="0" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="M"></rect>
                  <rect x="20" y="20" width="20" height="40" fill="white" stroke="black" data-superficie="D"></rect>
                  <rect x="0" y="60" width="40" height="20" fill="white" stroke="black" data-superficie="L"></rect>
                  <text x="20" y="95" font-size="12" text-anchor="middle">{{ i }}</text>
                </g>
                {% endfor %}
              </svg>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-info" id="btnGuardar">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Modal Selecci√≥n de Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Seleccionar Paciente</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <table id="tblPacientes" class="table table-striped table-bordered w-100">
          <thead class="bg-info text-white">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>C√©dula</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Selecci√≥n de M√©dico -->
<div class="modal fade" id="modalMedico" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Seleccionar M√©dico</h5>
        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <table id="tblMedicos" class="table table-striped table-bordered w-100">
          <thead class="bg-info text-white">
            <tr>
              <th>Nombre</th>
                <th>Apellido</th>
                <th>Acciones</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Librer√≠as -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;
let odontogramaData = [];

// Leyenda de estados dentales
const estadosOdontograma = {
  1: { nombre: 'Sano', color: '#FFFFFF' },
  2: { nombre: 'Caries', color: '#8B4513' },
  3: { nombre: 'Obturaci√≥n', color: '#C0C0C0' },
  4: { nombre: 'Extracci√≥n indicada', color: '#FFA500' },
  5: { nombre: 'Extra√≠do', color: '#ff0000ff' },
  6: { nombre: 'Endodoncia', color: '#FF1493' }
};

const superficiesDentales = {
  'O': 'Oclusal',
  'V': 'Vestibular', 
  'L': 'Lingual',
  'M': 'Mesial',
  'D': 'Distal'
};

const generarLeyenda = () => {
  let leyendaHTML = '<h6>Estados:</h6><ul class="list-unstyled">';
  for (const key in estadosOdontograma) {
    const estado = estadosOdontograma[key];
    leyendaHTML += `
      <li class="mb-1 d-flex align-items-center">
        <span style="display:inline-block;width:20px;height:20px;background:${estado.color};margin-right:8px;border:1px solid #000;"></span>
        <span>${estado.nombre}</span>
      </li>
    `;
  }
  leyendaHTML += '</ul>';
  
  leyendaHTML += '<h6>Superficies:</h6><ul class="list-unstyled">';
  for (const abrev in superficiesDentales) {
    const superficie = superficiesDentales[abrev];
    leyendaHTML += `<li class="mb-1"><strong>${abrev}:</strong> ${superficie}</li>`;
  }
  leyendaHTML += '</ul>';
  
  document.getElementById('leyendaOdontograma').innerHTML = leyendaHTML;
};

// Tabla principal
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/odontograma', dataSrc: 'data' },
    columns: [
      
      { data: 'paciente' },
      { data: 'cedula' },
      { data: 'edad' },
      { data: 'medico' },
      { data: 'fecha_registro', render: (data) => new Date(data).toLocaleDateString() },
      { data: 'estado', render: function(data) {
        if(data === "Activo") {
          return '<span style="color: #155724; background-color: #d4edda; padding: 2px 6px; border-radius: 4px;">Activo</span>';
        } else {
          return '<span style="color: #721c24; background-color: #f8d7da; padding: 2px 6px; border-radius: 4px;">Finalizado</span>';
        }
      }},
      { data: 'observaciones' },
      { data: null, render: (data, type, row) => `
        <button class="btn btn-sm btn-success" name="btn_ver" data-id="${row.id_odontograma}" title="Ver Odontograma">
          <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-info btn-sm" name="btn_editar" data-id="${row.id_odontograma}" title="Editar">
          <i class="fas fa-edit"></i> 
        </button>
        <button class="btn btn-danger btn-sm" name="btn_eliminar" data-id="${row.id_odontograma}" title="Eliminar">
          <i class="fas fa-trash-alt"></i> 
        </button>
      `}
    ]
  });
};

// Formatear fecha
function formatearFechaParaInput(fechaStr) {
  if (!fechaStr) return '';
  try {
    const fecha = new Date(fechaStr);
    if (isNaN(fecha.getTime())) return '';
    
    const a√±o = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    
    return `${a√±o}-${mes}-${dia}`;
  } catch (error) {
    console.error('Error formateando fecha:', error);
    return '';
  }
}

function recolectarOdontograma() {
  let datos = [];
  $("#odontogramaSVG g").each(function () {
    const diente = $(this).data("diente");
    $(this).find("rect").each(function () {
      const superficie = $(this).data("superficie");
      const fill = $(this).attr("fill");
      if (fill && fill !== "white" && fill !== "#FFFFFF") {
        let estado = 1;
        if (fill === "#8B4513" || fill === "rgb(139, 69, 19)") estado = 2;
        if (fill === "#C0C0C0" || fill === "rgb(192, 192, 192)") estado = 3;
        if (fill === "#FFA500" || fill === "rgb(255, 165, 0)") estado = 4;
        if (fill === "#ff0000ff" || fill === "hsla(0, 100%, 50%, 1.00)") estado = 5;
        if (fill === "#FF1493" || fill === "rgb(255, 20, 147)") estado = 6;

        datos.push({
          diente: diente,
          superficie: superficie,
          estado: estado
        });
      }
    });
  });
  return datos;
}

// Bot√≥n nuevo
$('#btnNuevo').on('click', () => {
  $('#modalTitle').text("Agregar Odontograma");
  $('#formOdontograma')[0].reset();
  $('#id_odontograma').val('');
  $('#id_paciente').val('');
  $('#id_medico').val('');
  odontogramaData = [];
  $('#odontogramaSVG rect').attr("fill", "white");
  $('#fecha_registro').val(new Date().toISOString().split('T')[0]);
  $('#modalFormulario').modal('show');
});

// Abrir modal al hacer click
$('#modalFormulario').on('shown.bs.modal', function () {
  generarLeyenda();
});

// --- DataTable Pacientes ---
const initDatatablePaciente = () => {
  $('#tblPacientes').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/paciente', dataSrc: 'data' },
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula_entidad' },
      { 
        data: null, 
        render: row => `
          <button type="button" name="btn_seleccionar_Paciente" class="btn btn-sm btn-warning" 
            data-id="${row.id_paciente}" 
            data-nombre="${row.nombre}" 
            data-apellido="${row.apellido}" 
            data-cedula="${row.cedula_entidad}"
            data-fecha_nacimiento="${row.fecha_nacimiento}">
            <i class="fas fa-check mr-1"></i>Seleccionar
          </button>`,
        className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblPacientes').on('click', 'button[name="btn_seleccionar_Paciente"]', function (e) {
    e.stopPropagation();
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    const cedula = $(this).data('cedula');
    const fecha_nac = $(this).data('fecha_nacimiento');

    // Calcular edad autom√°ticamente
    let edad = '';
    if(fecha_nac){
      const f = new Date(fecha_nac);
      const today = new Date();
      edad = today.getFullYear() - f.getFullYear();
      const m = today.getMonth() - f.getMonth();
      if(m < 0 || (m === 0 && today.getDate() < f.getDate())) edad--;
    }

    // Setear valores en el formulario
    $('#paciente').val(`${nombre} ${apellido}`);
    $('#id_paciente').val(id);
    $('#cedula').val(cedula);
    $('#edad').val(edad);
    $('#modalPaciente').modal('hide');
  });
};

// Click en paciente
$("#paciente").on("click", function() {
  $('#modalPaciente').modal('show');
  if (!$.fn.DataTable.isDataTable('#tblPacientes')) {
    initDatatablePaciente();
  }
});

// --- DataTable M√©dicos ---
const initDatatableMedico = () => {
  $('#tblMedicos').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/medico', dataSrc: 'data' },
    columns:[
      { data: 'nombre' },
      { data: 'apellido' },
      { 
        data: null, 
        render: row => `
          <button class="btn btn-sm btn-warning" name="btn_seleccionar_Medico"
            data-id="${row.id_medico}"
            data-nombre="${row.nombre}"
            data-apellido="${row.apellido}">
            <i class="fas fa-check mr-1"></i>Seleccionar
          </button>`,
        className: 'text-center',
        orderable: false
      }
    ]
  });

  $('#tblMedicos').on('click','button[name="btn_seleccionar_Medico"]', function(e){
    e.stopPropagation();
    $('#id_medico').val($(this).data('id'));
    $('#medico').val(`${$(this).data('nombre')} ${$(this).data('apellido')}`);
    $('#modalMedico').modal('hide');
  });
};

// Click en m√©dico
$("#medico").on("click", function() {
  $('#modalMedico').modal('show');
  if (!$.fn.DataTable.isDataTable('#tblMedicos')) {
    initDatatableMedico();
  }
});


// Selecci√≥n de superficie
$(document).on("click", "#odontogramaSVG rect", function() {
  const diente = $(this).closest("g").data("diente");
  const superficie = $(this).data("superficie");

  Swal.fire({
    title: `Diente ${diente} - ${superficie}`,
    input: 'select',
    inputOptions: {
      1: 'Sano',
      2: 'Caries',
      3: 'Obturaci√≥n',
      4: 'Extracci√≥n indicada',
      5: 'Extra√≠do',
      6: 'Endodoncia'
    },
    inputPlaceholder: 'Seleccione estado',
    showCancelButton: true
  }).then(result => {
    if (result.isConfirmed) {
      const estado = result.value;
      const color = estadosOdontograma[estado].color;
      $(this).attr("fill", color);
    }
  });
});

// Guardar
$("#btnGuardar").click(() => {
  const id = $("#id_odontograma").val();
  const id_paciente = $("#id_paciente").val();
  const id_medico = $("#id_medico").val();

  if (!id_paciente) {
    Swal.fire("Advertencia", "Debe seleccionar un paciente", "warning");
    return;
  }
  if (!id_medico) {
    Swal.fire("Advertencia", "Debe seleccionar un m√©dico", "warning");
    return;
  }

  const payload = {
    id_paciente: parseInt(id_paciente),
    id_medico: parseInt(id_medico),
    fecha_registro: $("#fecha_registro").val(),
    estado: $("#estado").val(),
    observaciones: $("#observaciones").val(),
    detalles: recolectarOdontograma()
  };

  let url = "/api/v1/odontograma";
  let method = "POST";

  if (id) {
    url = `/api/v1/odontograma/${id}`;
    method = "PUT";
  }

  fetch(url, {
    method: method,
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": CSRFToken
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      $('#modalFormulario').modal('hide');
      $('#tbl').DataTable().ajax.reload();
      odontogramaData = [];
      Swal.fire("√âxito", "Odontograma guardado correctamente", "success");
    } else {
      Swal.fire("Error", data.error, "error");
    }
  });
});

// VER ODONTOGRAMA
// VER ODONTOGRAMA - CON CONTROLES DE ZOOM
$('#tbl').on('click', 'button[name="btn_ver"]', function() {
  const id = $(this).data('id');
  
  fetch(`/api/v1/odontograma/${id}`)
    .then(resp => resp.json())
    .then(data => {
      const o = data.data;
      
      const modalHTML = `
        <div class="modal fade" id="modalVerOdontograma" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-xl" role="document" style="max-width: 98%; max-height: 95vh;">
            <div class="modal-content shadow-lg border-0">
              <!-- Header -->
              <div class="modal-header bg-gradient-info text-white">
                <h4 class="modal-title font-weight-bold">
                  <i class="fas fa-tooth mr-2"></i> Odontograma - ${o.paciente}
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              
              <!-- Body -->
              <div class="modal-body" id="contenidoImprimir" style="max-height: 80vh; overflow-y: auto;">
                
                <!-- Informaci√≥n del Paciente y M√©dico -->
                <div class="row mb-4 info-section">
                  <div class="col-md-6">
                    <div class="card border-info shadow-sm">
                      <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-user-circle mr-2"></i>Informaci√≥n del Paciente</h6>
                      </div>
                      <div class="card-body">
                        <table class="table table-sm table-borderless mb-0">
                          <tr>
                            <td class="font-weight-bold" style="width: 40%;"><i class="fas fa-user mr-2 text-info"></i>Paciente:</td>
                            <td>${o.paciente}</td>
                          </tr>
                          <tr>
                            <td class="font-weight-bold"><i class="fas fa-id-card mr-2 text-info"></i>C√©dula:</td>
                            <td>${o.cedula}</td>
                          </tr>
                          <tr>
                            <td class="font-weight-bold"><i class="fas fa-birthday-cake mr-2 text-info"></i>Edad:</td>
                            <td>${o.edad} a√±os</td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="card border-info shadow-sm">
                      <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-clipboard-list mr-2"></i>Informaci√≥n de la Consulta</h6>
                      </div>
                      <div class="card-body">
                        <table class="table table-sm table-borderless mb-0">
                          <tr>
                            <td class="font-weight-bold" style="width: 40%;"><i class="fas fa-user-md mr-2 text-info"></i>M√©dico:</td>
                            <td>${o.medico}</td>
                          </tr>
                          <tr>
                            <td class="font-weight-bold"><i class="fas fa-calendar-alt mr-2 text-info"></i>Fecha:</td>
                            <td>${new Date(o.fecha_registro).toLocaleDateString('es-ES', { 
                              day: '2-digit', 
                              month: 'long', 
                              year: 'numeric' 
                            })}</td>
                          </tr>
                          <tr>
                            <td class="font-weight-bold"><i class="fas fa-info-circle mr-2 text-info"></i>Estado:</td>
                            <td>
                              ${o.estado === 'Activo' 
                                ? '<span class="badge badge-success px-3 py-2"><i class="fas fa-check-circle mr-1"></i>Activo</span>' 
                                : '<span class="badge badge-secondary px-3 py-2"><i class="fas fa-flag-checkered mr-1"></i>Finalizado</span>'}
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Odontograma y Leyenda -->
                <div class="row mb-3 odontograma-section">
                  <div class="col-12">
                    <div class="card border-info shadow-sm">
                      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-teeth mr-2"></i>Diagrama Dental Completo</h6>
                        
                        <!-- üëâ CONTROLES DE ZOOM -->
                        <div class="btn-group zoom-controls no-print" role="group">
                          <button type="button" class="btn btn-sm btn-light" id="btnZoomOut" title="Alejar">
                            <i class="fas fa-search-minus"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-light" id="btnZoomReset" title="Restablecer">
                            <i class="fas fa-compress-arrows-alt"></i> <span id="zoomLevel">100%</span>
                          </button>
                          <button type="button" class="btn btn-sm btn-light" id="btnZoomIn" title="Acercar">
                            <i class="fas fa-search-plus"></i>
                          </button>
                        </div>
                      </div>
                      <div class="card-body bg-light p-4">
                        <div class="row">
                          <!-- Leyenda -->
                          <div class="col-md-3 col-lg-2 leyenda-col">
                            <div id="leyendaVer" class="card border-secondary shadow-sm" style="position: sticky; top: 20px;"></div>
                          </div>
                          
                          <!-- Odontograma -->
                          <div class="col-md-9 col-lg-10 odontograma-col">
                            <div id="odontogramaVerContainer" class="odontograma-wrapper"
                                 style="border: 3px solid #17a2b8; border-radius: 12px; padding: 20px; background-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: auto; max-height: 600px; position: relative; cursor: grab;">
                              <div id="odontogramaVer" style="transform-origin: 0 0; transition: transform 0.2s ease;"></div>
                            </div>
                            <div class="text-center mt-2 no-print">
                              <small class="text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Usa los botones de zoom o la rueda del mouse para acercar/alejar
                              </small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Observaciones -->
                ${o.observaciones ? `
                <div class="row observaciones-section">
                  <div class="col-12">
                    <div class="card border-warning shadow-sm">
                      <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-comment-medical mr-2"></i>Observaciones Cl√≠nicas</h6>
                      </div>
                      <div class="card-body bg-light">
                        <p class="mb-0" style="white-space: pre-wrap;">${o.observaciones}</p>
                      </div>
                    </div>
                  </div>
                </div>
                ` : ''}
              </div>
              
              <!-- Footer -->
              <div class="modal-footer bg-light">
                <button type="button" class="btn btn-info" id="btnImprimirOdonto">
                  <i class="fas fa-print mr-1"></i> Imprimir
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                  <i class="fas fa-times mr-1"></i> Cerrar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Estilos para impresi√≥n -->
        <style>
          /* Estilos para zoom interactivo */
          .odontograma-wrapper:active {
            cursor: grabbing !important;
          }

          .zoom-controls .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
          }

          #zoomLevel {
            font-weight: bold;
            margin: 0 5px;
          }

          @media print {
            /* Configuraci√≥n de p√°gina HORIZONTAL */
            @page {
              size: A4 landscape;
              margin: 1cm 0.5cm;
            }

            * {
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
            }

            body * {
              visibility: hidden;
            }

            #modalVerOdontograma,
            #modalVerOdontograma * {
              visibility: visible;
            }

            .modal-header,
            .modal-footer,
            button,
            .close,
            .no-print {
              display: none !important;
            }

            #modalVerOdontograma {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              margin: 0;
              padding: 0;
            }

            .modal-dialog {
              max-width: 100% !important;
              width: 100% !important;
              height: 100% !important;
              margin: 0 !important;
            }

            .modal-content {
              border: none !important;
              box-shadow: none !important;
              height: 100%;
            }

            .modal-body {
              max-height: none !important;
              overflow: visible !important;
              padding: 0 !important;
              height: 100%;
            }

            .info-section {
              margin-bottom: 0.5cm !important;
            }

            .info-section .card {
              page-break-inside: avoid;
              margin-bottom: 0 !important;
            }

            .info-section .card-header {
              background-color: #17a2b8 !important;
              color: white !important;
              padding: 0.3cm !important;
              font-size: 11pt !important;
            }

            .info-section .card-body {
              padding: 0.3cm !important;
            }

            .info-section .table td {
              padding: 0.1cm !important;
              font-size: 10pt !important;
            }

            .odontograma-section {
              page-break-inside: avoid !important;
              margin-bottom: 0 !important;
            }

            .odontograma-section .card {
              border: 2px solid #000 !important;
              margin-bottom: 0 !important;
            }

            .odontograma-section .card-header {
              background-color: #17a2b8 !important;
              color: white !important;
              padding: 0.3cm !important;
              font-size: 12pt !important;
            }

            .odontograma-section .card-body {
              padding: 0.4cm !important;
              background-color: white !important;
            }

            .odontograma-section .row {
              display: flex !important;
              flex-wrap: nowrap !important;
            }

            .leyenda-col {
              flex: 0 0 15% !important;
              max-width: 15% !important;
              padding-right: 0.3cm !important;
            }

            .odontograma-col {
              flex: 0 0 85% !important;
              max-width: 85% !important;
            }

            #leyendaVer {
              border: 1px solid #000 !important;
              box-shadow: none !important;
            }

            #leyendaVer .card-header {
              background-color: #6c757d !important;
              color: white !important;
              padding: 0.2cm !important;
              font-size: 9pt !important;
            }

            #leyendaVer .card-body {
              padding: 0.2cm !important;
              font-size: 8pt !important;
            }

            #leyendaVer h6 {
              font-size: 8pt !important;
              margin-bottom: 0.1cm !important;
            }

            #leyendaVer li {
              margin-bottom: 0.1cm !important;
              font-size: 7pt !important;
            }

            #leyendaVer .badge {
              font-size: 7pt !important;
            }

            .odontograma-wrapper {
              border: 2px solid #000 !important;
              border-radius: 0 !important;
              padding: 0.3cm !important;
              box-shadow: none !important;
              overflow: visible !important;
              background-color: white !important;
              max-height: none !important;
            }

            /* üëâ RESETEAR ZOOM PARA IMPRESI√ìN */
            #odontogramaVer {
              transform: scale(1) !important;
            }

            #odontogramaVer svg {
              width: 100% !important;
              height: auto !important;
              max-width: 100% !important;
              display: block !important;
            }

            .observaciones-section {
              page-break-before: auto !important;
              margin-top: 0.3cm !important;
            }

            .observaciones-section .card {
              border: 1px solid #000 !important;
            }

            .observaciones-section .card-header {
              background-color: #ffc107 !important;
              padding: 0.2cm !important;
              font-size: 10pt !important;
            }

            .observaciones-section .card-body {
              padding: 0.3cm !important;
              font-size: 9pt !important;
            }

            .badge {
              border: 1px solid #000 !important;
              padding: 0.1cm 0.2cm !important;
            }

            .card {
              page-break-inside: avoid !important;
            }
          }
        </style>
      `;
      
      // Remover modal anterior si existe
      $('#modalVerOdontograma').remove();
      $('body').append(modalHTML);
      
      // Generar leyenda
      let leyendaHTML = `
        <div class="card-header bg-secondary text-white p-2">
          <h6 class="mb-0 text-center"><i class="fas fa-palette mr-1"></i>Leyenda</h6>
        </div>
        <div class="card-body p-2">
          <h6 class="font-weight-bold text-secondary mb-2" style="font-size: 13px;">Estados:</h6>
          <ul class="list-unstyled mb-2">
      `;
      
      for (const key in estadosOdontograma) {
        const estado = estadosOdontograma[key];
        leyendaHTML += `
          <li class="mb-2 d-flex align-items-center">
            <span style="display:inline-block;width:20px;height:20px;background:${estado.color};margin-right:8px;border:2px solid #333;border-radius:3px;box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></span>
            <span style="font-size: 12px;">${estado.nombre}</span>
          </li>
        `;
      }
      
      leyendaHTML += `
          </ul>
          <hr class="my-2">
          <h6 class="font-weight-bold text-secondary mb-2" style="font-size: 13px;">Superficies:</h6>
          <ul class="list-unstyled mb-0">
      `;
      
      for (const abrev in superficiesDentales) {
        const superficie = superficiesDentales[abrev];
        leyendaHTML += `
          <li class="mb-1">
            <span class="badge badge-secondary mr-1" style="font-size: 10px; min-width: 22px;">${abrev}</span>
            <span style="font-size: 11px;">${superficie}</span>
          </li>
        `;
      }
      
      leyendaHTML += '</ul></div>';
      
      $('#leyendaVer').html(leyendaHTML);
      
      // Clonar y mostrar odontograma
      if ($('#odontogramaSVG').length > 0) {
        const svgClone = $('#odontogramaSVG').clone();
        svgClone.attr('id', 'odontogramaSVGVer');
        
        // Hacer el SVG responsive
        svgClone.removeAttr('width');
        svgClone.removeAttr('height');
        svgClone.attr('viewBox', '0 0 1800 800');
        svgClone.attr('preserveAspectRatio', 'xMidYMid meet');
        svgClone.css({
          'width': '100%',
          'height': 'auto',
          'display': 'block'
        });
        
        // Resetear todos los rect√°ngulos a blanco
        svgClone.find('rect[data-superficie]').attr('fill', 'white');
        
        // APLICAR COLORES
        if (o.detalles && Array.isArray(o.detalles)) {
          o.detalles.forEach(d => {
            const color = estadosOdontograma[d.id_estado_dental]?.color || "#FFFFFF";
            const elemento = svgClone.find(`g[data-diente="${d.numero_diente}"] rect[data-superficie="${d.superficie}"]`);
            
            if (elemento.length > 0) {
              elemento.attr("fill", color);
              elemento.attr("stroke", "#000");
              elemento.attr("stroke-width", "2");
            }
          });
        }
        
        $('#odontogramaVer').html(svgClone);
      } else {
        $('#odontogramaVer').html(`
          <div class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            No se pudo cargar el odontograma visual
          </div>
        `);
      }
      
      // Mostrar modal
      $('#modalVerOdontograma').modal('show');

      // üëâ FUNCIONALIDAD DE ZOOM
      let currentZoom = 1;
      const minZoom = 0.5;
      const maxZoom = 3;
      const zoomStep = 0.1;

      function updateZoom(newZoom) {
        currentZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
        $('#odontogramaVer').css('transform', `scale(${currentZoom})`);
        $('#zoomLevel').text(Math.round(currentZoom * 100) + '%');
      }

      // Bot√≥n Zoom In
      $('#btnZoomIn').on('click', function() {
        updateZoom(currentZoom + zoomStep);
      });

      // Bot√≥n Zoom Out
      $('#btnZoomOut').on('click', function() {
        updateZoom(currentZoom - zoomStep);
      });

      // Bot√≥n Reset
      $('#btnZoomReset').on('click', function() {
        updateZoom(1);
        $('#odontogramaVerContainer').scrollTop(0).scrollLeft(0);
      });

      // Zoom con rueda del mouse
      $('#odontogramaVerContainer').on('wheel', function(e) {
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const delta = e.originalEvent.deltaY;
          updateZoom(currentZoom + (delta > 0 ? -zoomStep : zoomStep));
        }
      });

      // Arrastrar para mover (pan)
      let isDragging = false;
      let startX, startY, scrollLeft, scrollTop;

      $('#odontogramaVerContainer').on('mousedown', function(e) {
        if (e.which === 1) { // Click izquierdo
          isDragging = true;
          startX = e.pageX - $(this).offset().left;
          startY = e.pageY - $(this).offset().top;
          scrollLeft = $(this).scrollLeft();
          scrollTop = $(this).scrollTop();
          $(this).css('cursor', 'grabbing');
        }
      });

      $(document).on('mouseup', function() {
        if (isDragging) {
          isDragging = false;
          $('#odontogramaVerContainer').css('cursor', 'grab');
        }
      });

      $('#odontogramaVerContainer').on('mousemove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - $(this).offset().left;
        const y = e.pageY - $(this).offset().top;
        const walkX = (x - startX) * 1.5;
        const walkY = (y - startY) * 1.5;
        $(this).scrollLeft(scrollLeft - walkX);
        $(this).scrollTop(scrollTop - walkY);
      });

      // Bot√≥n de impresi√≥n
      $('#btnImprimirOdonto').on('click', function() {
        window.print();
      });
    })
    .catch(error => {
      console.error('Error cargando odontograma:', error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "No se pudo cargar el odontograma",
        confirmButtonColor: "#17a2b8"
      });
    });
});
// ==========================================
// EDITAR
// ==========================================
const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function() {
    const id = $(this).data('id');
    
    Swal.fire({
      title: "¬øDeseas editar este registro?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: "S√≠, editar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: '#17a2b8',
      cancelButtonColor: '#6c757d'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/v1/odontograma/${id}`)
          .then(resp => resp.json())
          .then(data => {
            if (data && data.success && data.data) {
              const o = data.data;
              
              $('#modalTitle').text("Editar Odontograma");
              $('#id_odontograma').val(o.id_odontograma);
              $('#id_paciente').val(o.id_paciente);
              $('#id_medico').val(o.id_medico);
              $('#paciente').val(o.paciente);
              $('#medico').val(o.medico);
              $('#cedula').val(o.cedula);
              $('#edad').val(o.edad);
              $('#estado').val(o.estado);
              $('#observaciones').val(o.observaciones);

              const fechaFormateada = formatearFechaParaInput(o.fecha_registro);
              if (fechaFormateada) {
                $('#fecha_registro').val(fechaFormateada);
              }

              // ‚úÖ IMPORTANTE: Cargar los detalles en odontogramaData
              odontogramaData = [];
              $('#odontogramaSVG rect').attr("fill", "white");

              if (o.detalles && o.detalles.length > 0) {
                o.detalles.forEach(d => {
                  // Agregar a odontogramaData con el formato correcto
                  odontogramaData.push({
                    diente: d.numero_diente,
                    estado: d.id_estado_dental,
                    superficie: d.superficie || 'C'
                  });

                  // Pintar el diente en el SVG
                  const color = estadosOdontograma[d.id_estado_dental]?.color || "#FFFFFF";
                  $(`#odontogramaSVG g[data-diente="${d.numero_diente}"] rect[data-superficie="${d.superficie}"]`)
                    .attr("fill", color);
                });
              }

              $('#modalFormulario').modal('show');
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo cargar el odontograma.',
                confirmButtonColor: '#dc3545'
              });
            }
          })
          .catch(error => {
            console.error('Error cargando odontograma:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error de conexi√≥n',
              text: 'Ocurri√≥ un error al cargar el odontograma.',
              confirmButtonColor: '#dc3545'
            });
          });
      }
    });
  });
};

// ==========================================
// ELIMINAR
// ==========================================
const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
    const id = $(this).data('id');
    const botonEliminar = $(this);
    
    Swal.fire({
      title: "¬øDeseas eliminar este registro?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: "S√≠, eliminar",
      cancelButtonText: "Cancelar",
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/v1/odontograma/${id}`, {
          method: 'DELETE',
          headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': CSRFToken 
          }
        })
        .then(resp => resp.json())
        .then(data => {
          if (data && !data.error && data.success) {
            const fila = botonEliminar.closest('tr');
            const tabla = $('#tbl').DataTable();
            tabla.row(fila).remove().draw();
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'El odontograma ha sido eliminado correctamente.',
              confirmButtonColor: '#28a745'
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error al eliminar',
              text: data.error || 'No se pudo eliminar el odontograma.',
              confirmButtonColor: '#dc3545'
            });
          }
        })
        .catch(error => {
          console.error('Error eliminando odontograma:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error de conexi√≥n',
            text: 'Ocurri√≥ un error al eliminar. Por favor, intente nuevamente.',
            confirmButtonColor: '#dc3545'
          });
        });
      }
    });
  });
};
// ========================================
// INICIALIZACI√ìN
// ========================================
$(function() {
  fixModalShift();
  editar();
  eliminar();
  // 1. Inicializar la tabla
  const tabla = initDatatable();
  
  // 2. Detectar par√°metros URL
  const urlParams = new URLSearchParams(window.location.search);
  const action = urlParams.get('action');
  const idOdontograma = urlParams.get('id');
  const idPaciente = urlParams.get('paciente');
  const idMedico = urlParams.get('medico');

  console.log('üîç Par√°metros detectados:', { action, idOdontograma, idPaciente, idMedico });

  // 3. Manejar acci√≥n "ver"
  if (action === 'ver' && idOdontograma) {
    console.log('‚úÖ Acci√≥n VER detectada para odontograma ID:', idOdontograma);
    
    // Esperar a que DataTable cargue los datos
    $('#tbl').on('init.dt', function() {
      console.log('‚úÖ DataTable inicializada');
      
      setTimeout(() => {
        const boton = $(`button[name="btn_ver"][data-id="${idOdontograma}"]`);
        console.log('üîç Bot√≥n encontrado:', boton.length > 0);
        
        if (boton.length > 0) {
          console.log('‚úÖ Haciendo clic en el bot√≥n...');
          boton[0].click();
          
          // Limpiar URL despu√©s de abrir
          setTimeout(() => {
            window.history.replaceState({}, document.title, '/odontograma-index');
          }, 1000);
        } else {
          console.error('‚ùå No se encontr√≥ el bot√≥n');
          Swal.fire('Error', 'No se pudo abrir el odontograma', 'error');
        }
      }, 800);
    });
  }
  
  // 4. Manejar acci√≥n "nuevo"
  else if (action === 'nuevo' && idPaciente) {
    console.log('‚úÖ Acci√≥n NUEVO detectada para paciente ID:', idPaciente);
    
    setTimeout(() => {
      $('#btnNuevo').click();
      
      // Pre-cargar datos del paciente
      fetch(`/api/v1/paciente`)
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            const paciente = d.data.find(p => p.id_paciente == idPaciente);
            if (paciente) {
              $('#id_paciente').val(paciente.id_paciente);
              $('#paciente').val(`${paciente.nombre} ${paciente.apellido}`);
              $('#cedula').val(paciente.cedula_entidad);
              
              // Calcular edad
              if (paciente.fecha_nacimiento) {
                const f = new Date(paciente.fecha_nacimiento);
                const today = new Date();
                let edad = today.getFullYear() - f.getFullYear();
                const m = today.getMonth() - f.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < f.getDate())) edad--;
                $('#edad').val(edad);
              }
            }
          }
        });
      
      // Pre-cargar m√©dico
      if (idMedico) {
        fetch(`/api/v1/medico`)
          .then(r => r.json())
          .then(d => {
            if (d.success) {
              const medico = d.data.find(m => m.id_medico == idMedico);
              if (medico) {
                $('#id_medico').val(medico.id_medico);
                $('#medico').val(`${medico.nombre} ${medico.apellido}`);
              }
            }
          });
      }
      
      // Limpiar URL
      window.history.replaceState({}, document.title, '/odontograma-index');
    }, 500);
  }
});

// ==========================================
// FIX MODAL
// ==========================================
const fixModalShift = () => {
  $.fn.modal.Constructor.prototype._setScrollbar = function() {};
  $.fn.modal.Constructor.prototype._resetScrollbar = function() {};
  
  $(document).on('show.bs.modal', '.modal', function () {
    setTimeout(() => {
      $('body').css('padding-right', '0');
      $('.modal').css('padding-right', '0');
      $('.navbar-fixed-top, .navbar-fixed-bottom').css('padding-right', '0');
    }, 0);
  });

  $(document).on('hidden.bs.modal', '.modal', function () {
    $('body').css('padding-right', '0');
  });
};
</script>
{% endblock %}


