{% extends 'base.html' %}

{% block titulo %}
Avisos Recordatorios
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">

    <!-- Header -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-light btn-sm" id="btnAgregar">
          <i class="fas fa-plus-circle mr-1"></i> Agregar
        </button>
        <!--<button type="button" class="btn btn-success btn-sm" id="btnEnviarWhatsApp">
          <i class="fab fa-whatsapp mr-1"></i> Enviar WhatsApp
        </button> -->
        <button type="button" class="btn btn-warning btn-sm" id="btnEstadisticas">
          <i class="fas fa-chart-bar mr-1"></i> Estad√≠sticas
        </button>
      </div>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-bell mr-2"></i> Avisos Recordatorios
      </h5>
    </div>

    <!-- Body -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table id="tblAvisos" class="table table-hover table-bordered align-middle text-center">
          <thead class="bg-info text-white">
            <tr>
              <th>Personal</th>
              <th>Consultorio</th>
              <th>Paciente</th>
              <th>Tel√©fono</th>
              <th>M√©dico</th>
              <th>Fecha Cita</th>
              <th>Hora Cita</th>
              <th>Forma Env√≠o</th>
              <th>Mensaje</th>
              <th>Estado Env√≠o</th>
              <th>Confirmaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

 <!-- Modal Aviso -->
  <!-- =========================== -->
  <div class="modal fade" id="modalAviso" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top d-flex justify-content-between align-items-center">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-bell mr-2"></i> <span id="modalTitle">Nuevo Aviso Recordatorio</span>
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form id="formAvisoModal">
            <input type="hidden" id="id_aviso_modal">

            <div class="row">
          <!-- Personal -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-user-nurse mr-1"></i> Personal <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="text" id="txtPersonal" class="form-control" placeholder="Click para seleccionar personal" readonly required>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarPersonal').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="id_personal_modal">
            </div>

            <!-- Consultorio -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-door-open mr-1"></i> Consultorio <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="text" id="txtConsultorio" class="form-control" placeholder="Click para seleccionar consultorio" readonly required>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarConsultorio').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="codigo">
              <input type="hidden" id="id_consultorio_modal">
            </div>

            <!-- Paciente -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-user-injured mr-1"></i> Paciente <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="text" id="txtpaciente" class="form-control" placeholder="Click para seleccionar paciente" readonly required>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarPaciente').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="id_paciente">
            </div>

            <!-- M√©dico -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-user-md mr-1"></i> M√©dico <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="text" id="txtMedico" class="form-control" placeholder="Click para seleccionar m√©dico" readonly>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarMedico').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="id_medico">
            </div>

            <!-- Fecha y hora de cita -->
            <div class="col-md-4 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-calendar-alt mr-1"></i> Fecha Cita <span class="text-danger">*</span>
              </label>
              <input type="date" id="fecha_cita_modal" class="form-control text-center" required>
            </div>
            
            <div class="col-md-4 mb-3">
              <label class="font-weight-bold">
                <i class="far fa-clock mr-1"></i> Hora Cita <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <input type="number" id="hora_cita_horas" class="form-control" placeholder="HH" min="1" max="12" style="flex: 0 0 25%;">
                <span class="input-group-text">:</span>
                <input type="number" id="hora_cita_minutos" class="form-control" placeholder="MM" min="0" max="59" style="flex: 0 0 25%;">
                <select id="hora_cita_periodo" class="form-control" style="flex: 0 0 40%;">
                  <option value="a.m.">a.m.</option>
                  <option value="p.m.">p.m.</option>
                </select>
              </div>
              <input type="hidden" id="hora_cita_modal">
            </div>

            <!-- Estado Confirmaci√≥n -->
            <div class="col-md-4 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-check-circle mr-1"></i> Estado Confirmaci√≥n
              </label>
              <select id="estado_confirmacion_modal" class="form-control">
                <option value="Pendiente">Pendiente</option>
                <option value="Confirmado">Confirmado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
            </div>

            <!-- Forma de env√≠o -->
            <div class="col-md-12 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-paper-plane mr-1"></i> Forma de Env√≠o <span class="text-danger">*</span>
              </label>
              <select id="forma_envio_modal" class="form-control" required>
                <option value="" disabled selected>Seleccione</option>
                <option value="Gmail">Gmail</option>
                <option value="SMS">SMS</option>
                <option value="WhatsApp">WhatsApp</option>
              </select>
            </div>

            <!-- Mensaje -->
            <div class="col-12 mb-3">
              <label class="font-weight-bold">
                <i class="fas fa-comment-dots mr-1"></i> Mensaje
              </label>
              <textarea id="mensaje_modal" class="form-control" rows="4"
                placeholder="Deje vac√≠o para usar mensaje autom√°tico"></textarea>
            </div>
          </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="submit" class="btn btn-info" form="formAvisoModal">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Estad√≠sticas -->
  <!-- =========================== -->
  <div class="modal fade" id="modalEstadisticas" tabindex="-1" role="dialog" aria-labelledby="modalEstadisticasLabel">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="modalEstadisticasLabel">
            <i class="fas fa-chart-bar mr-2"></i>Estad√≠sticas de Avisos
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Por Estado -->
            <div class="col-md-4">
              <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">Por Estado</div>
                <div class="card-body">
                  <p><strong>Pendientes:</strong> <span id="statPendientes" class="badge badge-warning">0</span></p>
                  <p><strong>Enviados:</strong> <span id="statEnviados" class="badge badge-success">0</span></p>
                  <p><strong>Errores:</strong> <span id="statErrores" class="badge badge-danger">0</span></p>
                </div>
              </div>
            </div>
            
            <!-- Por Forma de Env√≠o -->
            <div class="col-md-4">
              <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">Por Forma de Env√≠o</div>
                <div class="card-body">
                  <p><strong>WhatsApp:</strong> <span id="statWhatsApp" class="badge badge-success">0</span></p>
                  <p><strong>Gmail:</strong> <span id="statGmail" class="badge badge-info">0</span></p>
                  <p><strong>SMS:</strong> <span id="statSMS" class="badge badge-secondary">0</span></p>
                </div>
              </div>
            </div>
            
            <!-- Por Confirmaci√≥n -->
            <div class="col-md-4">
              <div class="card border-success mb-3">
                <div class="card-header bg-success text-white">Por Confirmaci√≥n</div>
                <div class="card-body">
                  <p><strong>Confirmados:</strong> <span id="statConfirmados" class="badge badge-success">0</span></p>
                  <p><strong>Pendientes:</strong> <span id="statPendientesConf" class="badge badge-warning">0</span></p>
                  <p><strong>Cancelados:</strong> <span id="statCancelados" class="badge badge-danger">0</span></p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Total -->
          <div class="alert alert-info">
            <strong>Total de Avisos:</strong> <span id="statTotal">0</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i>Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Modales Selecci√≥n Paciente, Personal, M√©dico, Consultorio -->
  <!-- ========================= -->
  <!-- Modal Paciente -->
  <div class="modal fade" id="modalBuscarPaciente" tabindex="-1"data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h4 class="modal-title">Seleccionar Paciente</h4>
          <button type="button" class="close text-white" onclick="$('#modalBuscarPaciente').modal('hide');">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblPaciente">
              <thead class="bg-info text-white">
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
   </div>
  </div>

  <!-- Modal Personal -->
  <div class="modal fade" id="modalBuscarPersonal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Buscar Personal</h5>
          <button type="button" class="close text-white" onclick="$('#modalBuscarPersonal').modal('hide');">&times;</button>
        </div>
        <div class="modal-body">
          <table id="tblPersonal" class="table table-bordered w-100">
            <thead class="bg-info text-white">
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal M√©dico -->
  <div class="modal fade" id="modalBuscarMedico" tabindex="-1" data-backdrop="static" data-keyboard="false">>
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Buscar M√©dico</h5>
          <button type="button" class="close text-white" onclick="$('#modalBuscarMedico').modal('hide');">&times;</button>
        </div>
        <div class="modal-body">
          <table id="tblMedico" class="table table-bordered w-100">
            <thead class="bg-info text-white">
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Consultorio -->
  <div class="modal fade" id="modalBuscarConsultorio" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h4 class="modal-title">Seleccionar Consultorio</h4>
          <button type="button" class="close text-white" onclick="$('#modalBuscarConsultorio').modal('hide');">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblConsultorio">
              <thead class="bg-info text-white">
                <tr>
                  <th>Consultorio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Librer√≠as necesarias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;


// ==========================================
// FORMATO DE HORA AM/PM
// ==========================================
// üëâ Construir hora en formato AM/PM desde los inputs
function construirHoraAMPM() {
  let horas = parseInt($('#hora_cita_horas').val());
  let minutos = parseInt($('#hora_cita_minutos').val());
  const periodo = $('#hora_cita_periodo').val();
  
  console.log("üîç Construir hora - Horas:", horas, "Minutos:", minutos, "Periodo:", periodo);
  
  if (isNaN(horas) || isNaN(minutos)) {
    console.log("‚ö†Ô∏è Falta horas o minutos v√°lidos");
    return '';
  }
  
  if (horas < 1 || horas > 12) {
    console.log("‚ö†Ô∏è Horas fuera de rango (1-12):", horas);
    Swal.fire({
      icon: 'warning',
      title: 'Hora inv√°lida',
      text: 'Las horas deben estar entre 1 y 12.',
      confirmButtonColor: '#f39c12'
    });
    return '';
  }
  
  if (minutos < 0 || minutos > 59) {
    console.log("‚ö†Ô∏è Minutos fuera de rango (0-59):", minutos);
    Swal.fire({
      icon: 'warning',
      title: 'Minutos inv√°lidos',
      text: 'Los minutos deben estar entre 0 y 59.',
      confirmButtonColor: '#f39c12'
    });
    return '';
  }
  
  const horasFormat = String(horas).padStart(2, '0');
  const minutosFormat = String(minutos).padStart(2, '0');
  
  const resultado = `${horasFormat}:${minutosFormat} ${periodo}`;
  console.log("‚úÖ Hora construida:", resultado);
  
  return resultado;
}

// üëâ Convertir hora 12h AM/PM a formato 24h para la BD
function convertirAFormato24h(horaAMPM) {
  console.log("üîç Entrada a convertirAFormato24h:", horaAMPM);
  
  if (!horaAMPM) {
    console.log("‚ö†Ô∏è Hora vac√≠a");
    return '';
  }
  
  const match = horaAMPM.match(/(\d+):(\d+)\s*(a\.m\.|p\.m\.)/i);
  console.log("üîç Match resultado:", match);
  
  if (!match) {
    console.log("‚ö†Ô∏è No coincide el formato, devolviendo tal cual:", horaAMPM);
    return horaAMPM;
  }
  
  let horas = parseInt(match[1]);
  const minutos = match[2];
  const periodo = match[3].toLowerCase();
  
  console.log("üìä Horas originales:", horas, "Minutos:", minutos, "Periodo:", periodo);
  
  // Convertir a formato 24 horas
  if (periodo === 'p.m.') {
    if (horas !== 12) {
      horas += 12;
    }
  } else { // a.m.
    if (horas === 12) {
      horas = 0;
    }
  }
  
  const resultado = `${String(horas).padStart(2, '0')}:${minutos}`;
  console.log("‚úÖ Hora convertida a 24h:", resultado);
  
  return resultado;
}

// üëâ Separar hora en componentes para edici√≥n
function separarHoraAMPM(hora24h) {
  console.log("üîç Entrada a separarHoraAMPM:", hora24h);
  
  if (!hora24h) {
    return { horas: '', minutos: '', periodo: 'a.m.' };
  }
  
  // Si ya viene en formato AM/PM
  const matchAMPM = hora24h.match(/(\d+):(\d+)\s*(a\.m\.|p\.m\.)/i);
  if (matchAMPM) {
    return {
      horas: parseInt(matchAMPM[1]),
      minutos: matchAMPM[2],
      periodo: matchAMPM[3].toLowerCase()
    };
  }
  
  // Si viene en formato 24h (HH:MM:SS o HH:MM)
  const match24h = hora24h.match(/(\d+):(\d+)/);
  if (!match24h) {
    return { horas: '', minutos: '', periodo: 'a.m.' };
  }
  
  let horas = parseInt(match24h[1]);
  const minutos = match24h[2];
  let periodo = 'a.m.';
  
  console.log("üìä Horas 24h:", horas, "Minutos:", minutos);
  
  // Convertir de 24h a 12h
  if (horas >= 12) {
    periodo = 'p.m.';
    if (horas > 12) {
      horas = horas - 12;
    }
  } else if (horas === 0) {
    horas = 12;
  }
  
  const resultado = {
    horas: horas,
    minutos: minutos,
    periodo: periodo
  };
  
  console.log("‚úÖ Hora separada:", resultado);
  
  return resultado;
}

// üëâ Formatear hora de 24h a AM/PM para mostrar en tabla
function formatTimeToAMPM(hora24h) {
  if (!hora24h) return '';
  
  // Si ya viene en formato AM/PM, devolverlo tal cual
  if (hora24h.includes('a.m.') || hora24h.includes('p.m.')) {
    return hora24h;
  }
  
  const match = hora24h.match(/(\d+):(\d+)/);
  if (!match) return hora24h;
  
  let horas = parseInt(match[1]);
  const minutos = match[2];
  let periodo = 'a.m.';
  
  if (horas >= 12) {
    periodo = 'p.m.';
    if (horas > 12) {
      horas = horas - 12;
    }
  } else if (horas === 0) {
    horas = 12;
  }
  
  return `${horas}:${minutos} ${periodo}`;
}

// ==========================================
// VALIDACI√ìN DE DUPLICADOS
// ==========================================
async function verificarDuplicado(id_paciente, id_medico, fecha_cita, hora_cita, id_aviso_actual = null) {
  try {
    const response = await fetch('/api/v1/avisos/verificar-duplicado', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify({
        id_paciente: id_paciente,
        id_medico: id_medico,
        fecha_cita: fecha_cita,
        hora_cita: hora_cita,
        id_aviso_excluir: id_aviso_actual
      })
    });
    
    const result = await response.json();
    return result.duplicado || false;
  } catch (error) {
    console.error('Error al verificar duplicado:', error);
    return false;
  }
}

// ==========================================
// VALIDACI√ìN DE FECHA Y HORA FUTURAS
// ==========================================
function validarFechaHoraFutura(fecha, hora24h) {
  if (!fecha || !hora24h) {
    return { valido: false, mensaje: 'Fecha y hora son obligatorias' };
  }
  
  // Construir fecha y hora completa de la cita
  const fechaHoraCita = new Date(fecha + 'T' + hora24h + ':00');
  const ahora = new Date();
  
  console.log("üîç Validaci√≥n de fecha/hora:");
  console.log("   Fecha cita:", fechaHoraCita.toLocaleString('es-PY'));
  console.log("   Ahora:", ahora.toLocaleString('es-PY'));
  console.log("   Diferencia (ms):", fechaHoraCita - ahora);
  
  // ‚úÖ Permitir fechas de HOY si la hora es futura
  // ‚ùå NO permitir fechas pasadas ni horas pasadas de hoy
  if (fechaHoraCita <= ahora) {
    const esFechaHoy = fecha === ahora.toISOString().split('T')[0];
    
    if (esFechaHoy) {
      return { 
        valido: false, 
        mensaje: 'La hora seleccionada ya pas√≥. Debe seleccionar una hora futura del d√≠a de hoy.' 
      };
    } else {
      return { 
        valido: false, 
        mensaje: 'No puede crear avisos para fechas pasadas. Seleccione una fecha desde hoy en adelante.' 
      };
    }
  }
  
  return { valido: true };
}

// ==========================================
// FORMATO DE TEL√âFONO
// ==========================================
const formatearTelefonoParaMostrar = (telefono) => {
  if (!telefono) return 'Sin tel√©fono';
  let limpio = telefono.replace(/\D/g, '');
  
  if (limpio.startsWith('595')) {
    limpio = limpio.substring(3);
  }
  
  if (limpio.length > 3) {
    return limpio.substring(0, 3) + ' ' + limpio.substring(3);
  }
  return limpio;
};

const formatearTelefonoParaGuardar = (telefono) => {
  let limpio = telefono.replace(/\D/g, '');
  
  if (limpio.startsWith('595')) {
    return limpio;
  }
  
  if (limpio.startsWith('0')) {
    limpio = limpio.substring(1);
  }
  
  return '595' + limpio;
};


function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

function formatDateForDisplay(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${day}/${month}/${year}`;
}

const initDatatableAvisos = () => {
  $('#tblAvisos').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/avisos', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'personal' },
      { data: 'nombre_consultorio' },
      { data: 'paciente' },
      { 
        data: 'telefono_paciente', 
        render: data => formatearTelefonoParaMostrar(data),
        width: "120px",           
        className: "text-nowrap"
      },
      { data: 'medico', render: data => data || 'Sin m√©dico' },
      { data: 'fecha_cita', render: data => formatDateForDisplay(data) },
      { 
        data: 'hora_cita',
        render: data => formatTimeToAMPM(data)
      },
      { 
        data: 'forma_envio',
        render: function(data) {
          const icons = {
            'WhatsApp': '<i class="fab fa-whatsapp text-success"></i>',
            'Gmail': '<i class="fas fa-envelope text-primary"></i>',
            'SMS': '<i class="fas fa-sms text-info"></i>'
          };
          return (icons[data] || '') + ' ' + data;
        }
      },
      { 
        data: 'mensaje',
        render: function(data, type, row) {
          if (!data || data.trim() === '') {
            return `<span class="badge badge-info">Autom√°tico</span>
                    <button type="button" class="btn btn-sm btn-link p-0 ml-1" 
                            onclick="verMensajeAutomatico(${row.id_aviso})" 
                            title="Ver mensaje">
                      <i class="fas fa-eye"></i>
                    </button>`;
          } else {
            const mensajeCorto = data.length > 30 ? data.substring(0, 30) + '...' : data;
            return `<span title="Click en el ojo para ver completo">${mensajeCorto}</span>
                    <button type="button" class="btn btn-sm btn-link p-0 ml-1 btn-ver-mensaje" 
                            data-id="${row.id_aviso}"
                            title="Ver completo">
                      <i class="fas fa-eye"></i>
                    </button>`;
          }
        }
      },
      { 
        data: 'estado_envio', 
        render: function(data) {
          const badges = {
            'Pendiente': 'badge-warning',
            'Enviado': 'badge-success',
            'Error': 'badge-danger'
          };
          return `<span class="badge ${badges[data] || 'badge-secondary'}">${data}</span>`;
        }
      },
      { 
        data: 'estado_confirmacion', 
        render: function(data) {
          const badges = {
            'Pendiente': 'badge-warning',
            'Confirmado': 'badge-success',
            'Cancelado': 'badge-danger'
          };
          return `<span class="badge ${badges[data] || 'badge-secondary'}">${data || 'Pendiente'}</span>`;
        }
      },
      {
        data: function(row) {
          let buttons = `
            <div class="d-flex justify-content-center gap-1">
              <button type="button" name="btn_editar" class="btn btn-info btn-sm" data-id_aviso="${row.id_aviso}" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" name="btn_eliminar" class="btn btn-danger btn-sm" data-id_aviso="${row.id_aviso}" title="Eliminar">
                <i class="fas fa-trash-alt"></i>
              </button>`;
          
          if (row.forma_envio === 'WhatsApp' && 
              row.estado_envio === 'Pendiente' && 
              row.estado_confirmacion === 'Pendiente') {
            buttons += `
              <button type="button" name="btn_enviar_individual" class="btn btn-success btn-sm" data-id_aviso="${row.id_aviso}" title="Enviar ahora">
                <i class="fab fa-whatsapp"></i>
              </button>`;
          }
          
          buttons += `</div>`;
          return buttons;
        },
        width: "180px",
        className: "text-center"
      }
    ]
  });
};


const validarTelefonoAviso = () => {
  $('#telefono_aviso').on('keypress', function(e) {
    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
        (e.keyCode === 65 && e.ctrlKey === true) ||
        (e.keyCode === 67 && e.ctrlKey === true) ||
        (e.keyCode === 86 && e.ctrlKey === true) ||
        (e.keyCode === 88 && e.ctrlKey === true)) {
      return;
    }
    if ((e.which < 48 || e.which > 57)) {
      e.preventDefault();
    }
  });

  $('#telefono_aviso').on('input', function(e) {
    const input = e.target;
    let valor = input.value.replace(/\D/g, '');
    
    if (valor.length > 9) {
      valor = valor.substring(0, 9);
    }
    
    if (valor.length > 3) {
      input.value = valor.substring(0, 3) + ' ' + valor.substring(3);
    } else {
      input.value = valor;
    }
  });
};

// Funci√≥n para ver mensaje autom√°tico
function verMensajeAutomatico(idAviso) {
  fetch(`/api/v1/avisos/${idAviso}/mensaje-preview`)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        Swal.fire({
          title: 'Mensaje Autom√°tico',
          html: `<pre style="text-align: left; white-space: pre-wrap;">${result.mensaje}</pre>`,
          icon: 'info',
          width: '600px',
          confirmButtonColor: '#17a2b8'
        });
      } else {
        Swal.fire('Error', result.error, 'error');
      }
    })
    .catch(error => {
      Swal.fire('Error', 'No se pudo cargar el mensaje: ' + error, 'error');
    });
}

// Funci√≥n para ver mensaje personalizado completo
function verMensajeCompleto(mensaje, tipo) {
  Swal.fire({
    title: `Mensaje ${tipo}`,
    html: `<pre style="text-align: left; white-space: pre-wrap;">${mensaje}</pre>`,
    icon: 'info',
    width: '600px',
    confirmButtonColor: '#17a2b8'
  });
}

$('#btnEnviarWhatsApp').on('click', function() {
  Swal.fire({
    title: '¬øEnviar avisos por WhatsApp?',
    text: 'Se enviar√°n todos los avisos pendientes de WhatsApp',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'S√≠, enviar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#25D366',
    showLoaderOnConfirm: true,
    preConfirm: () => {
      return fetch('/api/v1/avisos/enviar-whatsapp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRFToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          throw new Error(data.error || 'Error al enviar');
        }
        return data;
      })
      .catch(error => {
        Swal.showValidationMessage(`Error: ${error}`);
      });
    },
    allowOutsideClick: () => !Swal.isLoading()
  }).then((result) => {
    if (result.isConfirmed) {
      $('#tblAvisos').DataTable().ajax.reload();
      Swal.fire({
        icon: 'success',
        title: 'Proceso completado',
        text: 'Los avisos han sido procesados. Revisa la columna de estado.',
        confirmButtonColor: '#25D366'
      });
    }
  });
});

$('#tblAvisos').on('click', 'button[name="btn_editar"]', async function() {
  const idAviso = $(this).data('id_aviso');
  try {
    const response = await fetch(`/api/v1/avisos/${idAviso}`);
    const result = await response.json();
    if (result.success) {
      const aviso = result.data;
      $('#id_aviso_modal').val(aviso.id_aviso);
      
      if (aviso.paciente_nombre) {
        $('#txtpaciente').val(aviso.paciente_nombre);
        $('#id_paciente').val(aviso.id_paciente);
      }
      
      if (aviso.personal_nombre) {
        $('#txtPersonal').val(aviso.personal_nombre);
        $('#id_personal_modal').val(aviso.id_personal);
      }
      
      if (aviso.medico_nombre) {
        $('#txtMedico').val(aviso.medico_nombre);
        $('#id_medico').val(aviso.id_medico);
      }
      
      if (aviso.nombre_consultorio) {
        $('#txtConsultorio').val(aviso.nombre_consultorio);
        $('#codigo').val(aviso.codigo);
      }
      
      $('#fecha_cita_modal').val(formatDateForInput(aviso.fecha_cita));
      
      // ‚úÖ Separar hora en componentes
      const horaPartes = separarHoraAMPM(aviso.hora_cita);
      $('#hora_cita_horas').val(horaPartes.horas);
      $('#hora_cita_minutos').val(horaPartes.minutos);
      $('#hora_cita_periodo').val(horaPartes.periodo);
      
      $('#forma_envio_modal').val(aviso.forma_envio);
      $('#mensaje_modal').val(aviso.mensaje || '');
      $('#estado_confirmacion_modal').val(aviso.estado_confirmacion || 'Pendiente');
      $('#modalTitle').text('Editar Aviso');
      $('#modalAviso').modal('show');
    } else {
      Swal.fire('Error', result.error || 'Error al cargar el aviso', 'error');
    }
  } catch (error) {
    Swal.fire('Error', 'Error de conexi√≥n: ' + error, 'error');
  }
});

$('#btnEstadisticas').on('click', function() {
  console.log('üîµ Click en bot√≥n estad√≠sticas');
  
  // Mostrar loading
  Swal.fire({
    title: 'Cargando estad√≠sticas...',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  fetch('/api/v1/avisos/estadisticas')
    .then(resp => {
      console.log('üîµ Respuesta recibida, status:', resp.status);
      if (!resp.ok) {
        throw new Error(`HTTP error! status: ${resp.status}`);
      }
      return resp.json();
    })
    .then(result => {
      console.log('üìä Datos completos recibidos:', result);
      console.log('üìä result.success:', result.success);
      console.log('üìä result.data:', result.data);
      
      Swal.close(); // Cerrar el loading
      
      if (result.success && result.data) {
        const data = result.data;
        
        console.log('üìä Actualizando valores...');
        console.log('   Total:', data.total);
        console.log('   Pendientes:', data.por_estado?.pendientes);
        console.log('   WhatsApp:', data.por_forma_envio?.whatsapp);
        
        // Actualizar valores
        $('#statTotal').text(data.total || 0);
        $('#statPendientes').text(data.por_estado?.pendientes || 0);
        $('#statEnviados').text(data.por_estado?.enviados || 0);
        $('#statErrores').text(data.por_estado?.errores || 0);
        $('#statWhatsApp').text(data.por_forma_envio?.whatsapp || 0);
        $('#statGmail').text(data.por_forma_envio?.gmail || 0);
        $('#statSMS').text(data.por_forma_envio?.sms || 0);
        $('#statConfirmados').text(data.por_confirmacion?.confirmados || 0);
        $('#statPendientesConf').text(data.por_confirmacion?.pendientes || 0);
        $('#statCancelados').text(data.por_confirmacion?.cancelados || 0);
        
        console.log('‚úÖ Valores actualizados, abriendo modal...');
        
        // Verificar que el modal existe
        if ($('#modalEstadisticas').length === 0) {
          console.error('‚ùå El modal #modalEstadisticas NO existe en el DOM');
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'El modal de estad√≠sticas no se encontr√≥ en la p√°gina'
          });
          return;
        }
        
        // Mostrar modal
        $('#modalEstadisticas').modal('show');
        
        console.log('‚úÖ Modal mostrado');
        
      } else {
        console.error('‚ùå result.success es false o data no existe');
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: result.error || 'No se pudieron cargar las estad√≠sticas'
        });
      }
    })
    .catch(error => {
      console.error('‚ùå Error al cargar estad√≠sticas:', error);
      Swal.close();
      Swal.fire({
        icon: 'error',
        title: 'Error de conexi√≥n',
        text: 'No se pudo conectar con el servidor: ' + error.message
      });
    });
});

// Agregar DESPU√âS del manejador de btn_editar
$('#tblAvisos').on('click', 'button[name="btn_eliminar"]', function() {
  const idAviso = $(this).data('id_aviso');
  
  Swal.fire({
    title: '¬øEst√° seguro?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/api/v1/avisos/${idAviso}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRFToken
        }
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Eliminado',
            text: 'El aviso ha sido eliminado correctamente',
            confirmButtonColor: '#17a2b8'
          });
          $('#tblAvisos').DataTable().ajax.reload();
        } else {
          Swal.fire('Error', result.error || 'Error al eliminar el aviso', 'error');
        }
      })
      .catch(error => {
        Swal.fire('Error', 'Error de conexi√≥n: ' + error, 'error');
      });
    }
  });
});


const initDatatablePaciente = () => {
  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/paciente', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_sel_paciente" class="btn btn-sm btn-warning" data-id="${row.id_paciente}" data-nombre="${row.nombre}" data-apellido="${row.apellido}"><i class="fas fa-check mr-1"></i>Seleccionar</button>`;
      }}
    ]
  });
  $('#tblPaciente').on('click', 'button[name="btn_sel_paciente"]', function () {
    $('#txtpaciente').val($(this).data('nombre') + ' ' + $(this).data('apellido'));
    $('#id_paciente').val($(this).data('id'));
    $('#modalBuscarPaciente').modal('hide');
  });
};

const initDatatablePersonal = () => {
  $('#tblPersonal').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/personal', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_sel_personal" class="btn btn-sm btn-warning" data-id="${row.id_personal}" data-nombre="${row.nombre}" data-apellido="${row.apellido}"><i class="fas fa-check mr-1"></i>Seleccionar</button>`;
      }}
    ]
  });
  $('#tblPersonal').on('click', 'button[name="btn_sel_personal"]', function () {
    $('#txtPersonal').val($(this).data('nombre') + ' ' + $(this).data('apellido'));
    $('#id_personal_modal').val($(this).data('id'));
    $('#modalBuscarPersonal').modal('hide');
  });
};

const initDatatableMedico = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/medico', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_sel_medico" class="btn btn-sm btn-warning" data-id="${row.id_medico}" data-nombre="${row.nombre}" data-apellido="${row.apellido}"><i class="fas fa-check mr-1"></i>Seleccionar</button>`;
      }}
    ]
  });
  $('#tblMedico').on('click', 'button[name="btn_sel_medico"]', function () {
    $('#txtMedico').val($(this).data('nombre') + ' ' + $(this).data('apellido'));
    $('#id_medico').val($(this).data('id'));
    $('#modalBuscarMedico').modal('hide');
  });
};

const initDatatableConsultorio = () => {
  $('#tblConsultorio').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/consultorios',
    columns: [
      { data: 'nombre_consultorio' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_consultorio" class="btn btn-sm btn-warning" data-codigo="${row.codigo}" data-consultorio="${row.nombre_consultorio}"><i class="fas fa-check mr-1"></i>Seleccionar</button>`;
      }}
    ]
  });
  $('#tblConsultorio').on('click', 'button[name="btn_seleccionar_consultorio"]', function () {
    $('#txtConsultorio').val($(this).data('consultorio'));
    $('#codigo').val($(this).data('codigo'));
    $('#modalBuscarConsultorio').modal('hide');
  });
};

const agregarAviso = () => {
  $('#btnAgregar').on('click', () => {
    $('#formAvisoModal')[0].reset();
    $('#id_aviso_modal').val('');
    $('#estado_confirmacion_modal').val('Pendiente');
    $('#modalTitle').text("Agregar Aviso");
    configurarFechaMinima();
    $('#modalAviso').modal('show');
  });
};

$('#formAvisoModal').on('submit', async function(e) {
  e.preventDefault();
  const idAviso = $('#id_aviso_modal').val();
  
  // ‚úÖ Construir hora en formato AM/PM desde los inputs
  const horaAMPM = construirHoraAMPM();
  
  console.log("‚è∞ Hora AM/PM construida:", horaAMPM);
  
  if (!horaAMPM) {
    Swal.fire({
      icon: 'warning',
      title: 'Campo incompleto',
      text: 'Debe ingresar la hora de la cita (horas y minutos).',
      confirmButtonColor: '#f39c12'
    });
    return;
  }
  
  // ‚úÖ Convertir a formato 24h para la base de datos
  const hora24h = convertirAFormato24h(horaAMPM);
  
  console.log("‚è∞ Hora 24h convertida:", hora24h);
  
  // ‚úÖ Obtener valores antes de construir el objeto
  const id_paciente = $('#id_paciente').val();
  const id_personal = $('#id_personal_modal').val();
  const id_medico = $('#id_medico').val();
  const codigo = $('#codigo').val();
  const fecha_cita = $('#fecha_cita_modal').val();
  const forma_envio = $('#forma_envio_modal').val();
  
  // Validaciones tempranas
  if (!id_paciente) {
    Swal.fire('Error', 'Debe seleccionar un paciente', 'error');
    return;
  }
  if (!id_personal) {
    Swal.fire('Error', 'Debe seleccionar un personal', 'error');
    return;
  }
  if (!codigo) {
    Swal.fire('Error', 'Debe seleccionar un consultorio', 'error');
    return;
  }
  if (!fecha_cita) {
    Swal.fire('Error', 'Debe ingresar una fecha de cita', 'error');
    return;
  }
  if (!forma_envio) {
    Swal.fire('Error', 'Debe seleccionar una forma de env√≠o', 'error');
    return;
  }
  
  // ‚ö†Ô∏è VALIDAR QUE LA FECHA/HORA SEAN FUTURAS (PRIMERO)
  const validacionFecha = validarFechaHoraFutura(fecha_cita, hora24h);
  if (!validacionFecha.valido) {
    Swal.fire({
      icon: 'error',
      title: '‚ùå Fecha/Hora Inv√°lida',
      text: validacionFecha.mensaje,
      confirmButtonColor: '#d33'
    });
    return;
  }

  // ‚ö†Ô∏è VALIDACI√ìN DE DUPLICADO (UNA SOLA VEZ)
  const esDuplicado = await verificarDuplicado(
    parseInt(id_paciente),
    id_medico ? parseInt(id_medico) : null,
    fecha_cita,
    hora24h,
    idAviso || null
  );
  
  if (esDuplicado) {
    Swal.fire({
      icon: 'warning',
      title: '‚ö†Ô∏è Aviso Duplicado',
      html: `
        Ya existe un aviso para:<br>
        <strong>Este paciente</strong><br>
        <strong>Este m√©dico</strong><br>
        <strong>Esta fecha y hora</strong><br><br>
      `,
      confirmButtonColor: '#f39c12'
    });
    return;
  }
  
  // ‚úÖ Obtener el mensaje y limpiarlo
  const mensajeTexto = $('#mensaje_modal').val();
  const mensajeLimpio = mensajeTexto ? mensajeTexto.trim() : '';

  // ‚úÖ Construir el objeto data con hora24h
  const data = {
    id_paciente: parseInt(id_paciente),
    id_personal: parseInt(id_personal),
    id_medico: id_medico ? parseInt(id_medico) : null,
    codigo: parseInt(codigo),
    fecha_cita: fecha_cita,
    hora_cita: hora24h,
    forma_envio: forma_envio,
    mensaje: mensajeLimpio,
    estado_confirmacion: $('#estado_confirmacion_modal').val()
  };

  // SOLO agregar estado_envio si es un NUEVO aviso
  if (!idAviso) {
    data.estado_envio = 'Pendiente';
  }

  console.log("üì¶ Datos a enviar:", data);
  
  try {
    const url = idAviso ? `/api/v1/avisos/${idAviso}` : '/api/v1/avisos';
    const method = idAviso ? 'PUT' : 'POST';
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify(data)
    });
    const result = await response.json();
    
    console.log("üì• Respuesta del servidor:", result);
    
    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: idAviso ? 'Aviso actualizado' : 'Aviso creado',
        text: result.message,
        confirmButtonColor: '#17a2b8'
      });
      $('#modalAviso').modal('hide');
      $('#tblAvisos').DataTable().ajax.reload();
    } else {
      Swal.fire('Error', result.error || 'Error al guardar el aviso', 'error');
    }
  } catch (error) {
    console.error('‚ùå Error completo:', error);
    Swal.fire('Error', 'Error de conexi√≥n: ' + error, 'error');
  }
});

// 2. Agregar la funci√≥n faltante validarHoraAMPM
const validarHoraAMPM = () => {
  // Validar horas (1-12)
  $('#hora_cita_horas').on('input', function() {
    let valor = parseInt($(this).val());
    if (valor > 12) {
      $(this).val(12);
    } else if (valor < 1 && $(this).val() !== '') {
      $(this).val(1);
    }
  });
  
  // Validar minutos (0-59)
  $('#hora_cita_minutos').on('input', function() {
    let valor = parseInt($(this).val());
    if (valor > 59) {
      $(this).val(59);
    } else if (valor < 0 && $(this).val() !== '') {
      $(this).val(0);
    }
  });
  
  // Solo permitir n√∫meros
  $('#hora_cita_horas, #hora_cita_minutos').on('keypress', function(e) {
    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
        (e.keyCode === 65 && e.ctrlKey === true) ||
        (e.keyCode === 67 && e.ctrlKey === true) ||
        (e.keyCode === 86 && e.ctrlKey === true) ||
        (e.keyCode === 88 && e.ctrlKey === true)) {
      return;
    }
    if ((e.which < 48 || e.which > 57)) {
      e.preventDefault();
    }
  });
};

// ==========================================
// CONFIGURAR FECHA M√çNIMA EN EL INPUT
// ==========================================
function configurarFechaMinima() {
  const hoy = new Date();
  const a√±o = hoy.getFullYear();
  const mes = String(hoy.getMonth() + 1).padStart(2, '0');
  const dia = String(hoy.getDate()).padStart(2, '0');
  const fechaMinima = `${a√±o}-${mes}-${dia}`;
  
  $('#fecha_cita_modal').attr('min', fechaMinima);
  console.log("üìÖ Fecha m√≠nima establecida:", fechaMinima);
}

// ==========================================
// VALIDACI√ìN DE CAMBIO DE FECHA
// ==========================================
const validarCambioFecha = () => {
  $('#fecha_cita_modal').on('change', function() {
    const fechaSeleccionada = $(this).val();
    const hoy = new Date().toISOString().split('T')[0];
    
    if (fechaSeleccionada < hoy) {
      Swal.fire({
        icon: 'warning',
        title: 'Fecha no v√°lida',
        text: 'No puede seleccionar una fecha anterior a hoy.',
        confirmButtonColor: '#f39c12'
      });
      $(this).val('');
    }
  });
};

// ==========================================
// VALIDACI√ìN DE CAMBIO DE HORA
// ==========================================
const validarCambioHora = () => {
  $('#hora_cita_horas, #hora_cita_minutos, #hora_cita_periodo').on('change', function() {
    const fechaSeleccionada = $('#fecha_cita_modal').val();
    if (!fechaSeleccionada) return;
    
    const hoy = new Date().toISOString().split('T')[0];
    
    // Solo validar si es fecha de hoy
    if (fechaSeleccionada === hoy) {
      const horaAMPM = construirHoraAMPM();
      if (!horaAMPM) return;
      
      const hora24h = convertirAFormato24h(horaAMPM);
      const ahora = new Date();
      const horaActual = `${String(ahora.getHours()).padStart(2, '0')}:${String(ahora.getMinutes()).padStart(2, '0')}`;
      
      console.log("‚è∞ Comparando horas:");
      console.log("   Hora seleccionada:", hora24h);
      console.log("   Hora actual:", horaActual);
      
      if (hora24h <= horaActual) {
        Swal.fire({
          icon: 'warning',
          title: 'Hora no v√°lida',
          text: 'La hora seleccionada ya pas√≥. Seleccione una hora futura.',
          confirmButtonColor: '#f39c12'
        });
        
        $('#hora_cita_horas').val('');
        $('#hora_cita_minutos').val('');
      }
    }
  });
};


// --- Enviar aviso individual ---
 // Manejador para env√≠o individual de WhatsApp
  $('#tblAvisos').on('click', 'button[name="btn_enviar_individual"]', function() {
    const id = $(this).data('id_aviso');
    
    console.log('Click en bot√≥n WhatsApp, ID:', id);
    
    Swal.fire({
      title: '¬øEnviar este aviso?',
      text: 'Se abrir√° WhatsApp Web en una nueva ventana',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'S√≠, enviar',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#25D366'
    }).then((result) => {
      if(result.isConfirmed) {
        console.log('Enviando aviso:', id);
        
        fetch(`/api/v1/avisos/${id}/enviar-whatsapp`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRFToken
          }
        })
        .then(response => {
          console.log('Respuesta del servidor:', response);
          return response.json();
        })
        .then(data => {
          console.log('Datos recibidos:', data);
          
          if (data.success) {
            Swal.fire({
              icon: 'info',
              title: 'Proceso iniciado',
              html: `
                Se abri√≥ WhatsApp Web.<br><br>
                <strong>Pasos:</strong><br>
                1. Escanea el c√≥digo QR si es necesario<br>
                2. Espera a que env√≠e el mensaje<br>
                3. Recarga la p√°gina para ver el estado actualizado
              `,
              confirmButtonColor: '#25D366',
              confirmButtonText: 'Entendido'
            }).then(() => {
              setTimeout(() => {
                $('#tblAvisos').DataTable().ajax.reload();
              }, 20000);
            });
          } else {
            Swal.fire('Error', data.error, 'error');
          }
        })
        .catch(error => {
          console.error('Error en fetch:', error);
          Swal.fire('Error', 'Error de conexi√≥n: ' + error, 'error');
        });
      }
    });
});

// Manejador para ver mensajes personalizados (ya guardados)
$('#tblAvisos').on('click', '.btn-ver-mensaje', function() {
  const idAviso = $(this).data('id');
  
  fetch(`/api/v1/avisos/${idAviso}`)
    .then(response => response.json())
    .then(result => {
      if (result.success && result.data.mensaje) {
        Swal.fire({
          title: 'Mensaje Enviado',
          html: `<pre style="text-align: left; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${result.data.mensaje}</pre>`,
          icon: 'info',
          width: '600px',
          confirmButtonColor: '#17a2b8'
        });
      } else {
        Swal.fire('Error', 'No se pudo cargar el mensaje', 'error');
      }
    })
    .catch(error => {
      Swal.fire('Error', 'Error de conexi√≥n: ' + error, 'error');
    });
});

// ==========================================
// FIX MODAL SHIFT
// ==========================================
const fixModalShift = () => {
  $.fn.modal.Constructor.prototype._setScrollbar = function() {};
  $.fn.modal.Constructor.prototype._resetScrollbar = function() {};
  
  $(document).on('show.bs.modal', '.modal', function () {
    setTimeout(() => {
      $('body').css('padding-right', '0');
      $('.modal').css('padding-right', '0');
      $('.navbar-fixed-top, .navbar-fixed-bottom').css('padding-right', '0');
    }, 0);
  });

  $(document).on('hidden.bs.modal', '.modal', function () {
    $('body').css('padding-right', '0');
  });
};

$(document).ready(function() {
  initDatatableAvisos();
  initDatatablePaciente();
  initDatatablePersonal();
  initDatatableMedico();
  initDatatableConsultorio();
  agregarAviso();
  fixModalShift();
  validarTelefonoAviso(); 
  validarHoraAMPM();
  configurarFechaMinima(); 
  validarCambioFecha();      
  validarCambioHora(); 
});
</script>
{% endblock %}