{% extends 'base.html' %}

{% block titulo %}
Avisos Recordatorios
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">

    <!-- Header -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-light btn-sm" id="btnAgregar">
          <i class="fas fa-plus-circle mr-1"></i> Agregar
        </button>
        <button type="button" class="btn btn-success btn-sm" id="btnEnviarWhatsApp">
          <i class="fab fa-whatsapp mr-1"></i> Enviar WhatsApp
        </button>
        <button type="button" class="btn btn-warning btn-sm" id="btnEstadisticas">
          <i class="fas fa-chart-bar mr-1"></i> Estadísticas
        </button>
      </div>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-bell mr-2"></i> Avisos Recordatorios
      </h5>
    </div>

    <!-- Body -->
    <div class="card-body p-2">
      <div class="table-responsive shadow-sm rounded">
        <table id="tblAvisos" class="table table-hover table-bordered align-middle text-center">
          <thead class="bg-info text-white">
            <tr>
              <th>Personal</th>
              <th>Consultorio</th>
              <th>Paciente</th>
              <th>Teléfono</th>
              <th>Médico</th>
              <th>Fecha Cita</th>
              <th>Hora Cita</th>
              <th>Forma Envío</th>
              <th>Mensaje</th>
              <th>Estado Envío</th>
              <th>Confirmación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Aviso -->
  <!-- =========================== -->
  <div class="modal fade" id="modalAviso" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white rounded-top d-flex justify-content-between align-items-center">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-bell mr-2"></i> <span id="modalTitle">Nuevo Aviso Recordatorio</span>
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <form id="formAvisoModal">
            <input type="hidden" id="id_aviso_modal">

            <div class="row">
              <!-- Personal -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Personal <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="text" id="txtPersonal" class="form-control" placeholder="Click para seleccionar personal" readonly required>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarPersonal').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="id_personal_modal">
            </div>

              <!-- Consultorio -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Consultorio <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="text" id="txtConsultorio" class="form-control" placeholder="Click para seleccionar consultorio" readonly required>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarConsultorio').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="codigo">
              <input type="hidden" id="id_consultorio_modal">
            </div>

              <!-- Paciente -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Paciente <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="text" id="txtpaciente" class="form-control" placeholder="Click para seleccionar paciente" readonly required>
                <button type="button" class="btn btn-info" onclick="$('#modalBuscarPaciente').modal('show')">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <input type="hidden" id="id_paciente">
            </div>

              <!-- Médico -->
              <div class="col-md-6 mb-3">
                <label class="font-weight-bold">Médico <span class="text-danger">*</span></label>
                <div class="input-group">
                  <input type="text" id="txtMedico" class="form-control" placeholder="Click para seleccionar médico" readonly>
                  <button type="button" class="btn btn-info" onclick="$('#modalBuscarMedico').modal('show')">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
                <input type="hidden" id="id_medico">
              </div>

              <!-- Fecha y hora de cita -->
              <div class="col-md-4 mb-3">
                <label class="font-weight-bold">Fecha Cita <span class="text-danger">*</span></label>
                <input type="date" id="fecha_cita_modal" class="form-control text-center" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="font-weight-bold">Hora Cita <span class="text-danger">*</span></label>
                <input type="time" id="hora_cita_modal" class="form-control text-center" required>
              </div>

              <!-- Estado Confirmación -->
              <div class="col-md-4 mb-3">
                <label class="font-weight-bold">Estado Confirmación</label>
                <select id="estado_confirmacion_modal" class="form-control">
                  <option value="Pendiente">Pendiente</option>
                  <option value="Confirmado">Confirmado</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>

              <!-- Forma de envío -->
              <div class="col-md-12 mb-3">
                <label class="font-weight-bold">Forma de Envío <span class="text-danger">*</span></label>
                <select id="forma_envio_modal" class="form-control" required>
                  <option value="" disabled selected>Seleccione</option>
                  <option value="Gmail">Gmail</option>
                  <option value="SMS">SMS</option>
                  <option value="WhatsApp">WhatsApp</option>
                </select>
              </div>

              <!-- Mensaje -->
              <div class="col-12 mb-3">
                <label class="font-weight-bold">Mensaje</label>
                <textarea id="mensaje_modal" class="form-control" rows="4"
                  placeholder="Deje vacío para usar mensaje automático"></textarea>
              </div>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="submit" class="btn btn-info" form="formAvisoModal">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal Estadísticas -->
  <div class="modal fade" id="modalEstadisticas" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Estadísticas de Avisos</h5>
          <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4">
              <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">Por Estado</div>
                <div class="card-body">
                  <p><strong>Pendientes:</strong> <span id="statPendientes" class="badge badge-warning">0</span></p>
                  <p><strong>Enviados:</strong> <span id="statEnviados" class="badge badge-success">0</span></p>
                  <p><strong>Errores:</strong> <span id="statErrores" class="badge badge-danger">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">Por Forma de Envío</div>
                <div class="card-body">
                  <p><strong>WhatsApp:</strong> <span id="statWhatsApp" class="badge badge-success">0</span></p>
                  <p><strong>Gmail:</strong> <span id="statGmail" class="badge badge-info">0</span></p>
                  <p><strong>SMS:</strong> <span id="statSMS" class="badge badge-secondary">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-success mb-3">
                <div class="card-header bg-success text-white">Por Confirmación</div>
                <div class="card-body">
                  <p><strong>Confirmados:</strong> <span id="statConfirmados" class="badge badge-success">0</span></p>
                  <p><strong>Pendientes:</strong> <span id="statPendientesConf" class="badge badge-warning">0</span></p>
                  <p><strong>Cancelados:</strong> <span id="statCancelados" class="badge badge-danger">0</span></p>
                </div>
              </div>
            </div>
          </div>
          <div class="alert alert-info">
            <strong>Total de Avisos:</strong> <span id="statTotal">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Modales Selección Paciente, Personal, Médico, Consultorio -->
  <!-- ========================= -->
  <!-- Modal Paciente -->
  <div class="modal fade" id="modalBuscarPaciente" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Paciente</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblPaciente">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
   </div>
  </div>

  <!-- Modal Personal -->
  <div class="modal fade" id="modalBuscarPersonal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Buscar Personal</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <table id="tblPersonal" class="table table-bordered w-100">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acción</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Médico -->
  <div class="modal fade" id="modalBuscarMedico" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Buscar Médico</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <table id="tblMedico" class="table table-bordered w-100">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acción</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Consultorio -->
  <div class="modal fade" id="modalBuscarConsultorio" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Consultorio</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblConsultorio">
              <thead>
                <tr>
                  <th>Consultorio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Librerías necesarias -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

function formatDateForDisplay(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${day}/${month}/${year}`;
}

const initDatatableAvisos = () => {
  $('#tblAvisos').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/avisos', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'personal' },
      { data: 'nombre_consultorio' },
      { data: 'paciente' },
      { data: 'telefono_paciente', render: data => data || 'Sin teléfono' },
      { data: 'medico', render: data => data || 'Sin médico' },
      { data: 'fecha_cita', render: data => formatDateForDisplay(data) },
      { data: 'hora_cita' },
      { 
        data: 'forma_envio',
        render: function(data) {
          const icons = {
            'WhatsApp': '<i class="fab fa-whatsapp text-success"></i>',
            'Gmail': '<i class="fas fa-envelope text-primary"></i>',
            'SMS': '<i class="fas fa-sms text-info"></i>'
          };
          return (icons[data] || '') + ' ' + data;
        }
      },
      { 
        data: 'mensaje',
        render: function(data, type, row) {
          if (!data || data.trim() === '') {
            // Si está vacío, mostrar que es automático
            return `<span class="badge badge-info">Automático</span>
                    <button type="button" class="btn btn-sm btn-link p-0 ml-1" 
                            onclick="verMensajeAutomatico(${row.id_aviso})" 
                            title="Ver mensaje">
                      <i class="fas fa-eye"></i>
                    </button>`;
          } else {
            // Si tiene mensaje personalizado
            const mensajeCorto = data.length > 30 ? data.substring(0, 30) + '...' : data;
            return `<span title="${data}">${mensajeCorto}</span>
                    <button type="button" class="btn btn-sm btn-link p-0 ml-1" 
                            onclick="verMensajeCompleto('${data.replace(/'/g, "\\'")}', 'Personalizado')" 
                            title="Ver completo">
                      <i class="fas fa-eye"></i>
                    </button>`;
          }
        }
      },
      { 
        data: 'estado_envio', 
        render: function(data) {
          const badges = {
            'Pendiente': 'badge-warning',
            'Enviado': 'badge-success',
            'Error': 'badge-danger'
          };
          return `<span class="badge ${badges[data] || 'badge-secondary'}">${data}</span>`;
        }
      },
      { 
        data: 'estado_confirmacion', 
        render: function(data) {
          const badges = {
            'Pendiente': 'badge-warning',
            'Confirmado': 'badge-success',
            'Cancelado': 'badge-danger'
          };
          return `<span class="badge ${badges[data] || 'badge-secondary'}">${data || 'Pendiente'}</span>`;
        }
      },
      {
        data: function(row) {
          let buttons = `
            <button type="button" name="btn_editar" class="btn btn-info btn-sm" data-id_aviso="${row.id_aviso}" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" name="btn_eliminar" class="btn btn-danger btn-sm" data-id_aviso="${row.id_aviso}" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>`;
          
          if (row.forma_envio === 'WhatsApp' && 
              row.estado_envio === 'Pendiente' && 
              row.estado_confirmacion === 'Pendiente') {
            buttons += `
            <button type="button" name="btn_enviar_individual" class="btn btn-success btn-sm" data-id_aviso="${row.id_aviso}" title="Enviar ahora">
              <i class="fab fa-whatsapp"></i>
            </button>`;
          }
          
          return buttons;
        }
      }
    ]
  });
};

// Función para ver mensaje automático
function verMensajeAutomatico(idAviso) {
  fetch(`/api/v1/avisos/${idAviso}/mensaje-preview`)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        Swal.fire({
          title: 'Mensaje Automático',
          html: `<pre style="text-align: left; white-space: pre-wrap;">${result.mensaje}</pre>`,
          icon: 'info',
          width: '600px',
          confirmButtonColor: '#17a2b8'
        });
      } else {
        Swal.fire('Error', result.error, 'error');
      }
    })
    .catch(error => {
      Swal.fire('Error', 'No se pudo cargar el mensaje: ' + error, 'error');
    });
}

// Función para ver mensaje personalizado completo
function verMensajeCompleto(mensaje, tipo) {
  Swal.fire({
    title: `Mensaje ${tipo}`,
    html: `<pre style="text-align: left; white-space: pre-wrap;">${mensaje}</pre>`,
    icon: 'info',
    width: '600px',
    confirmButtonColor: '#17a2b8'
  });
}

$('#btnEnviarWhatsApp').on('click', function() {
  Swal.fire({
    title: '¿Enviar avisos por WhatsApp?',
    text: 'Se enviarán todos los avisos pendientes de WhatsApp',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sí, enviar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#25D366',
    showLoaderOnConfirm: true,
    preConfirm: () => {
      return fetch('/api/v1/avisos/enviar-whatsapp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRFToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          throw new Error(data.error || 'Error al enviar');
        }
        return data;
      })
      .catch(error => {
        Swal.showValidationMessage(`Error: ${error}`);
      });
    },
    allowOutsideClick: () => !Swal.isLoading()
  }).then((result) => {
    if (result.isConfirmed) {
      $('#tblAvisos').DataTable().ajax.reload();
      Swal.fire({
        icon: 'success',
        title: 'Proceso completado',
        text: 'Los avisos han sido procesados. Revisa la columna de estado.',
        confirmButtonColor: '#25D366'
      });
    }
  });
});

$('#tblAvisos').on('click', 'button[name="btn_editar"]', async function() {
  const idAviso = $(this).data('id_aviso');
  try {
    const response = await fetch(`/api/v1/avisos/${idAviso}`);
    const result = await response.json();
    if (result.success) {
      const aviso = result.data;
      $('#id_aviso_modal').val(aviso.id_aviso);
      
      // ✅ CAMBIAR: usar paciente_nombre en lugar de paciente
      if (aviso.paciente_nombre) {
        $('#txtpaciente').val(aviso.paciente_nombre);
        $('#id_paciente').val(aviso.id_paciente);
      }
      
      // ✅ CAMBIAR: usar personal_nombre en lugar de personal
      if (aviso.personal_nombre) {
        $('#txtPersonal').val(aviso.personal_nombre);
        $('#id_personal_modal').val(aviso.id_personal);
      }
      
      // ✅ CAMBIAR: usar medico_nombre en lugar de medico
      if (aviso.medico_nombre) {
        $('#txtMedico').val(aviso.medico_nombre);
        $('#id_medico').val(aviso.id_medico);
      }
      
      if (aviso.nombre_consultorio) {
        $('#txtConsultorio').val(aviso.nombre_consultorio);
        $('#codigo').val(aviso.codigo);
      }
      
      $('#fecha_cita_modal').val(formatDateForInput(aviso.fecha_cita));
      $('#hora_cita_modal').val(aviso.hora_cita);
      $('#forma_envio_modal').val(aviso.forma_envio);
      $('#mensaje_modal').val(aviso.mensaje || '');
      $('#estado_confirmacion_modal').val(aviso.estado_confirmacion || 'Pendiente');
      $('#modalTitle').text('Editar Aviso');
      $('#modalAviso').modal('show');
    } else {
      Swal.fire('Error', result.error || 'Error al cargar el aviso', 'error');
    }
  } catch (error) {
    Swal.fire('Error', 'Error de conexión: ' + error, 'error');
  }
});

$('#btnEstadisticas').on('click', function() {
  fetch('/api/v1/avisos/estadisticas')
    .then(resp => resp.json())
    .then(result => {
      if (result.success) {
        const data = result.data;
        $('#statTotal').text(data.total);
        $('#statPendientes').text(data.por_estado.pendientes);
        $('#statEnviados').text(data.por_estado.enviados);
        $('#statErrores').text(data.por_estado.errores);
        $('#statWhatsApp').text(data.por_forma_envio.whatsapp);
        $('#statGmail').text(data.por_forma_envio.gmail);
        $('#statSMS').text(data.por_forma_envio.sms);
        $('#statConfirmados').text(data.por_confirmacion.confirmados);
        $('#statPendientesConf').text(data.por_confirmacion.pendientes);
        $('#statCancelados').text(data.por_confirmacion.cancelados);
        $('#modalEstadisticas').modal('show');
      }
    });
});

const initDatatablePaciente = () => {
  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/paciente', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_sel_paciente" class="btn btn-primary btn-sm" data-id="${row.id_paciente}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });
  $('#tblPaciente').on('click', 'button[name="btn_sel_paciente"]', function () {
    $('#txtpaciente').val($(this).data('nombre') + ' ' + $(this).data('apellido'));
    $('#id_paciente').val($(this).data('id'));
    $('#modalBuscarPaciente').modal('hide');
  });
};

const initDatatablePersonal = () => {
  $('#tblPersonal').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/personal', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_sel_personal" class="btn btn-primary btn-sm" data-id="${row.id_personal}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });
  $('#tblPersonal').on('click', 'button[name="btn_sel_personal"]', function () {
    $('#txtPersonal').val($(this).data('nombre') + ' ' + $(this).data('apellido'));
    $('#id_personal_modal').val($(this).data('id'));
    $('#modalBuscarPersonal').modal('hide');
  });
};

const initDatatableMedico = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: { url: '/api/v1/medico', dataSrc: 'data' },
    destroy: true,
    columns: [
      { data: 'nombre' },
      { data: 'apellido' },
      { data: function(row) {
        return `<button type="button" name="btn_sel_medico" class="btn btn-primary btn-sm" data-id="${row.id_medico}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">Seleccionar</button>`;
      }}
    ]
  });
  $('#tblMedico').on('click', 'button[name="btn_sel_medico"]', function () {
    $('#txtMedico').val($(this).data('nombre') + ' ' + $(this).data('apellido'));
    $('#id_medico').val($(this).data('id'));
    $('#modalBuscarMedico').modal('hide');
  });
};

const initDatatableConsultorio = () => {
  $('#tblConsultorio').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/consultorios',
    columns: [
      { data: 'nombre_consultorio' },
      { data: function(row) {
        return `<button type="button" name="btn_seleccionar_consultorio" class="btn btn-primary" data-codigo="${row.codigo}" data-consultorio="${row.nombre_consultorio}">Seleccionar</button>`;
      }}
    ]
  });
  $('#tblConsultorio').on('click', 'button[name="btn_seleccionar_consultorio"]', function () {
    $('#txtConsultorio').val($(this).data('consultorio'));
    $('#codigo').val($(this).data('codigo'));
    $('#modalBuscarConsultorio').modal('hide');
  });
};

const agregarAviso = () => {
  $('#btnAgregar').on('click', () => {
    $('#formAvisoModal')[0].reset();
    $('#id_aviso_modal').val('');
    $('#estado_confirmacion_modal').val('Pendiente');
    $('#modalTitle').text("Agregar Aviso");
    $('#modalAviso').modal('show');
  });
};

$('#formAvisoModal').on('submit', async function(e) {
  e.preventDefault();
  const idAviso = $('#id_aviso_modal').val();
  
  // ✅ Obtener el mensaje y limpiarlo
  const mensajeTexto = $('#mensaje_modal').val();
  const mensajeLimpio = mensajeTexto ? mensajeTexto.trim() : '';
  
  const data = {
    id_paciente: $('#id_paciente').val(),
    id_personal: $('#id_personal_modal').val(),
    id_medico: $('#id_medico').val() || null,
    codigo: $('#codigo').val() ? parseInt($('#codigo').val()) : null,
    fecha_cita: $('#fecha_cita_modal').val(),
    hora_cita: $('#hora_cita_modal').val(),
    forma_envio: $('#forma_envio_modal').val(),
    mensaje: mensajeLimpio,  // ✅ Envía "" si está vacío (no null)
    estado_confirmacion: $('#estado_confirmacion_modal').val()
  };

  // SOLO agregar estado_envio si es un NUEVO aviso
  if (!idAviso) {
    data.estado_envio = 'Pendiente';
  }

  // Validaciones
  if (!data.id_paciente) {
    Swal.fire('Error', 'Debe seleccionar un paciente', 'error');
    return;
  }
  if (!data.id_personal) {
    Swal.fire('Error', 'Debe seleccionar un personal', 'error');
    return;
  }
  if (!data.fecha_cita) {
    Swal.fire('Error', 'Debe ingresar una fecha de cita', 'error');
    return;
  }
  if (!data.hora_cita) {
    Swal.fire('Error', 'Debe ingresar una hora de cita', 'error');
    return;
  }
  if (!data.forma_envio) {
    Swal.fire('Error', 'Debe seleccionar una forma de envío', 'error');
    return;
  }
  
  try {
    const url = idAviso ? `/api/v1/avisos/${idAviso}` : '/api/v1/avisos';
    const method = idAviso ? 'PUT' : 'POST';
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify(data)
    });
    const result = await response.json();
    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: idAviso ? 'Aviso actualizado' : 'Aviso creado',
        text: result.message,
        confirmButtonColor: '#17a2b8'
      });
      $('#modalAviso').modal('hide');
      $('#tblAvisos').DataTable().ajax.reload();
    } else {
      Swal.fire('Error', result.error || 'Error al guardar el aviso', 'error');
    }
  } catch (error) {
    Swal.fire('Error', 'Error de conexión: ' + error, 'error');
  }
});

// --- Enviar aviso individual ---
$('#tblAvisos').on('click', 'button[name="btn_enviar_individual"]', function() {
  const id = $(this).data('id_aviso');
  
  console.log('Click en botón WhatsApp, ID:', id);  // ✅ Para debug
  
  Swal.fire({
    title: '¿Enviar este aviso?',
    text: 'Se abrirá WhatsApp Web en una nueva ventana',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sí, enviar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#25D366'
  }).then((result) => {
    if(result.isConfirmed) {
      console.log('Enviando aviso:', id);  // ✅ Para debug
      
      fetch(`/api/v1/avisos/${id}/enviar-whatsapp`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRFToken
        }
      })
      .then(response => {
        console.log('Respuesta del servidor:', response);  // ✅ Para debug
        return response.json();
      })
      .then(data => {
        console.log('Datos recibidos:', data);  // ✅ Para debug
        
        if (data.success) {
          Swal.fire({
            icon: 'info',
            title: 'Proceso iniciado',
            html: `
              Se abrió WhatsApp Web.<br><br>
              <strong>Pasos:</strong><br>
              1. Escanea el código QR si es necesario<br>
              2. Espera a que envíe el mensaje<br>
              3. Recarga la página para ver el estado actualizado
            `,
            confirmButtonColor: '#25D366',
            confirmButtonText: 'Entendido'
          }).then(() => {
            // Recargar después de 20 segundos para ver el estado
            setTimeout(() => {
              $('#tblAvisos').DataTable().ajax.reload();
            }, 20000);
          });
        } else {
          Swal.fire('Error', data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error en fetch:', error);  // ✅ Para debug
        Swal.fire('Error', 'Error de conexión: ' + error, 'error');
      });
    }
  });
});

$(document).ready(function() {
  initDatatableAvisos();
  initDatatablePaciente();
  initDatatablePersonal();
  initDatatableMedico();
  initDatatableConsultorio();
  agregarAviso();
});
</script>
{% endblock %}