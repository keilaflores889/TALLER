{% extends 'base.html' %}

{% block titulo %}
Registrar Cita
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
  <!-- Card principal -->
  <div class="card shadow-sm border-0 rounded-lg">

    <!-- Header -->
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-light btn-sm" id="btnAgregar">
        <i class="fas fa-plus-circle mr-1"></i> Agregar Cita
      </button>
      <h5 class="mb-0 font-weight-bold">
        <i class="fas fa-notes-medical mr-2"></i> Registro de Citas
      </h5>
    </div>

    <!-- Body -->
    <div class="card-body">
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover table-bordered align-middle text-center" id="tbl">
          <thead class="bg-info text-white">
            <tr>
              <th>Fecha / Cita</th>
              <th>MÃ©dico</th>
              <th>Especialidad</th>
              <th>Paciente</th>
              <th>Turno</th>
              <th>Hora / Cita</th>
              <th>Motivo Consulta</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- =========================== -->
  <!-- Modal Formulario Cita -->
  <!-- =========================== -->
  <div class="modal fade" id="modalFormulario" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="document">
      <div class="modal-content shadow-lg border-0 rounded-lg">

        <!-- Header -->
        <div class="modal-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="modal-title font-weight-bold">
            <i class="fas fa-calendar-check mr-2"></i> <span id="modalTitle">Nueva Cita</span>
          </h5>

          <!-- Estado en el encabezado -->
          <div class="form-group mb-0 d-flex align-items-center">
            <label for="txtestado" class="mr-2 mb-0 text-white">Estado:</label>
            <input type="hidden" id="id_estado">
            <input type="text" id="txtestado" class="form-control form-control-sm" 
                   placeholder="Click para seleccionar estado" readonly>
          </div>

          <button type="button" class="close text-white ml-2" data-dismiss="modal">&times;</button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <input type="hidden" id="txtIdCita">
          <input type="hidden" id="id_agenda_medica" value="{{ id_agenda_medica }}">

          <!-- Agenda MÃ©dica -->
          <div class="mb-3">
            <label class="font-weight-bold">Agenda MÃ©dica:</label>
            <input type="text" id="txtagenda" class="form-control" 
                   placeholder="Click para seleccionar agenda" readonly>
          </div>

          <!-- Campos en dos columnas -->
          <div class="row">
            <!-- Columna izquierda -->
            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Fecha de la Cita:</label>
              <input type="date" id="fecha" class="form-control">
            </div>

            <div class="col-md-6 mb-3">
              <label class="font-weight-bold">Hora de la Cita:</label>
              <input type="time" id="hora" class="form-control">
            </div>

            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_medico">
              <label class="font-weight-bold">MÃ©dico:</label>
              <input type="text" id="txtmedico" class="form-control" placeholder="Click para seleccionar mÃ©dico" readonly>
            </div>

            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_especialidad">
              <label class="font-weight-bold">Especialidad:</label>
              <input type="text" id="txtespecialidad" class="form-control" placeholder="Click para seleccionar especialidad" readonly>
            </div>

            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_paciente">
              <label class="font-weight-bold">Paciente:</label>
              <input type="text" id="txtpaciente" class="form-control" placeholder="Click para seleccionar paciente" readonly>
            </div>

            <div class="col-md-6 mb-3">
              <input type="hidden" id="id_turno">
              <label class="font-weight-bold">Turno:</label>
              <input type="text" id="txtturno" class="form-control" placeholder="Click para seleccionar turno" readonly>
            </div>

            <div class="col-12 mb-3">
              <label class="font-weight-bold">Motivo de la Consulta:</label>
              <textarea id="txtmotivo" class="form-control" rows="3" placeholder="Describa el motivo de la consulta"></textarea>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-info" id="btnGuardarCita">
            <i class="fas fa-save mr-1"></i> Guardar
          </button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i> Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
  
<!-- Modal Buscar Agenda -->
<div class="modal fade" id="modalBuscarAgenda" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Buscar Agenda</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <table id="tblAgenda" class="table table-striped table-bordered w-100">
          <thead>
            <tr>
              <th>MÃ©dico</th>
              <th>Especialidad</th>
              <th>Fecha</th>
              <th>Turno</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- Modal de selecciÃ³n de Medico -->
<div class="modal fade" id="modalBuscarMedico" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modalMedicoTitle">Seleccionar Medico</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblMedico">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Especialidad -->
  <div class="modal fade" id="modalBuscarEspecialidad" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Especialidad</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblEspecialidad">
              <thead>
                <tr>
                  <th>Especialidad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Modal de selecciÃ³n de Paciente -->
<div class="modal fade" id="modalBuscarPaciente" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modalPacienteTitle">Seleccionar Paciente</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblPaciente">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
 </div>
</div>

<!-- Modal Turno -->
  <div class="modal fade" id="modalBuscarTurno" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Seleccionar Turno</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblTurno">
              <thead>
                <tr>
                  <th>Turno</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Modal de selecciÃ³n de estado -->
 <div class="modal fade" id="modalBuscarEstado" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modalEstadoCitaTitle">Seleccionar Estado</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblEstado">
            <thead>
              <tr>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<!-- LibrerÃ­as necesarias -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">

{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

// ðŸ‘‰ id_agenda_medica se inyecta desde Flask
let AGENDA_ID = null; 
let id_cita = null;

// ------------------------ HELPERS ------------------------
function formatDateForInput(fecha) {
  if (!fecha) return '';
  const d = new Date(fecha);
  if (isNaN(d)) return '';
  const day = String(d.getUTCDate()).padStart(2, '0');
  const month = String(d.getUTCMonth() + 1).padStart(2, '0');
  const year = d.getUTCFullYear();
  return `${year}-${month}-${day}`;
}

// ------------------------ DATATABLE PRINCIPAL ------------------------
const initDatatable = () => {
  $('#tbl').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/registroc',
    columns: [
      { data: 'fecha_cita', render: function(data) {
        if (!data) return '';
        const d = new Date(data);
        if (isNaN(d)) return '';
        const day = String(d.getUTCDate()).padStart(2, '0');
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const year = d.getUTCFullYear();
        return `${day}/${month}/${year}`;
      }},
      { data: row => `${row.medico_nombre} ${row.medico_apellido}` },
      { data: 'especialidad' },
      { data: row => `${row.paciente_nombre} ${row.paciente_apellido}` },
      { data: 'turno' },
      { data: row => row.hora ? row.hora.slice(0,5) : "" }, // HH:MM
      { data: 'motivo_consulta' },
      { data: 'estado' },
      { data: null, render: (row) => `
        <button type="button" name="btn_editar" class="btn btn-info btn-sm" data-id_cita="${row.id_cita}">
          <i class="fas fa-edit"></i>
        </button>
        <button type="button" name="btn_eliminar" class="btn btn-danger btn-sm" data-id_cita="${row.id_cita}">
          <i class="fas fa-trash-alt"></i>
        </button>` }
    ]
  });
};

// --------- LISTA AGENDAS ---------
// --------- LISTA AGENDAS ---------
const initDatatableAgenda = () => {
  $('#tblAgenda').DataTable({
    language: { 
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" 
    },
    ajax: '/api/v1/agenda',
    columns: [
  { data: row => `${row.medico_nombre || ''} ${row.medico_apellido || ''}` },
  { data: 'especialidad' },
  {
    data: 'fecha_agenda',
    render: function(data) {
      if (!data) return '';
      const d = new Date(data);
      if (isNaN(d)) return '';
      const day = String(d.getUTCDate()).padStart(2, '0');
      const month = String(d.getUTCMonth() + 1).padStart(2, '0');
      const year = d.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }
  },
  { data: 'turno' },
  { 
    data: null, 
    render: (row) => {
      const nombre = row.medico_nombre || '';
      const apellido = row.medico_apellido || '';
      const turno = row.turno || '';
      let fechaLabel = '';
      if (row.fecha_agenda) {
        const d = new Date(row.fecha_agenda);
        if (!isNaN(d)) {
          const day = String(d.getUTCDate()).padStart(2, '0');
          const month = String(d.getUTCMonth() + 1).padStart(2, '0');
          const year = d.getUTCFullYear();
          fechaLabel = `${day}/${month}/${year}`;
        }
      }
      return `
  <button type="button" name="btn_seleccionar_Agenda" class="btn btn-sm btn-primary"
    data-id="${row.id_agenda_medica}" 
    data-label="${nombre} ${apellido} - ${row.especialidad || ''} - ${fechaLabel} (${turno})">
    Seleccionar
  </button>`;

    }
  }
]

  });

  // Evento Seleccionar Agenda
  $('#tblAgenda').on('click', 'button[name="btn_seleccionar_Agenda"]', function () {
    const idAgenda = $(this).data('id');
    const label = $(this).data('label');

    // Poner valores en el modal de Cita
    $('#id_agenda_medica').val(idAgenda);
    $('#txtagenda').val(label);

    // Actualizamos variable global
    AGENDA_ID = idAgenda;

    // Cerrar modal de bÃºsqueda
    $('#modalBuscarAgenda').modal('hide');
  });
};

const buscarAgenda = () => 
  $('#txtagenda').on('click', () => $('#modalBuscarAgenda').modal());


// ------------------------ PACIENTE ------------------------
const initDatatablep = () => {
  $('#tblPaciente').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/paciente',
    columns: [
      { data: 'nombre' }, { data: 'apellido' },
      { data: null, render: (row) => `
        <button type="button" name="btn_seleccionar_Paciente" class="btn btn-primary" 
          data-id="${row.id_paciente}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">
          Seleccionar
        </button>` }
    ]
  });

  $('#tblPaciente').on('click', 'button[name="btn_seleccionar_Paciente"]', function () {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    $('#txtpaciente').val(`${nombre} ${apellido}`);
    $('#id_paciente').val(id);
    $('#modalBuscarPaciente').modal('hide');
  });
};
const buscarPaciente = () => $('#txtpaciente').on('click', () => $('#modalBuscarPaciente').modal());

// ------------------------ MEDICO ------------------------
const initDatatablem = () => {
  $('#tblMedico').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/medico',
    columns: [
      { data: 'nombre' }, { data: 'apellido' },
      { data: null, render: (row) => `
        <button type="button" name="btn_seleccionar_Medico" class="btn btn-primary" 
          data-id="${row.id_medico}" data-nombre="${row.nombre}" data-apellido="${row.apellido}">
          Seleccionar
        </button>` }
    ]
  });

  $('#tblMedico').on('click', 'button[name="btn_seleccionar_Medico"]', function () {
    const id = $(this).data('id');
    const nombre = $(this).data('nombre');
    const apellido = $(this).data('apellido');
    $('#txtmedico').val(`${nombre} ${apellido}`);
    $('#id_medico').val(id);
    $('#modalBuscarMedico').modal('hide');
  });
};
const buscarMedico = () => $('#txtmedico').on('click', () => $('#modalBuscarMedico').modal());

// ------------------------ ESPECIALIDAD ------------------------
const initDatatablee = () => {
  $('#tblEspecialidad').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax: '/api/v1/especialidades',
    columns: [
      { data: 'descripcion' },
      { data: null, render: (row) => `
        <button type="button" name="btn_seleccionar_Especialidad" class="btn btn-primary"
          data-id="${row.id_especialidad}" data-especialidad="${row.descripcion}">Seleccionar</button>` }
    ]
  });

  $('#tblEspecialidad').on('click', 'button[name="btn_seleccionar_Especialidad"]', function() {
    $('#txtespecialidad').val($(this).data('especialidad'));
    $('#id_especialidad').val($(this).data('id'));
    $('#modalBuscarEspecialidad').modal('hide');
  });
};
const buscarEspecialidad = () => $('#txtespecialidad').on('click', () => $('#modalBuscarEspecialidad').modal());

// ------------------------ ESTADO ------------------------
const initDatatableestado = () => {
  $('#tblEstado').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/estadocita',
    columns: [
      { data: 'descripcion' },
      { data: null, render: (row) => `
        <button type="button" name="btn_seleccionar_Estado" class="btn btn-primary"
          data-id="${row.id_estado}" data-estado="${row.descripcion}">Seleccionar</button>` }
    ]
  });

  $('#tblEstado').on('click', 'button[name="btn_seleccionar_Estado"]', function() {
    $('#txtestado').val($(this).data('estado'));
    $('#id_estado').val($(this).data('id'));
    $('#modalBuscarEstado').modal('hide');
  });
};
const buscarEstado = () => $('#txtestado').on('click', () => $('#modalBuscarEstado').modal());

// ------------------------ TURNO ------------------------
const initDatatableTurno = () => {
  $('#tblTurno').DataTable({
    language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
    ajax:'/api/v1/turnos',
    columns: [
      { data: 'descripcion' },
      { data: null, render: (row) => `
        <button type="button" name="btn_seleccionar_Turno" class="btn btn-primary"
          data-id="${row.id_turno}" data-turno="${row.descripcion}">Seleccionar</button>` }
    ]
  });

  $('#tblTurno').on('click', 'button[name="btn_seleccionar_Turno"]', function() {
    $('#txtturno').val($(this).data('turno'));
    $('#id_turno').val($(this).data('id'));
    $('#modalBuscarTurno').modal('hide');
  });
};
const buscarTurno = () => $('#txtturno').on('click', () => $('#modalBuscarTurno').modal());

// FunciÃ³n para limpiar el modal
function limpiarModal() {
    // Limpiar campos ocultos
    $('#txtIdCita').val('');
    $('#id_paciente').val('');
    $('#id_medico').val('');
    $('#id_especialidad').val('');
    $('#id_turno').val('');
    $('#id_estado').val('');
    $('#id_agenda_medica').val('');
    
    // Limpiar campos visibles
    $('#txtpaciente').val('');
    $('#txtmedico').val('');
    $('#txtespecialidad').val('');
    $('#txtturno').val('');
    $('#txtestado').val('');
    $('#txtagenda').val('');
    $('#fecha').val('');
    $('#hora').val('');
    $('#txtmotivo').val('');
    
    // Resetear tÃ­tulo del modal
    $('#modalTitle').text("Registrar Cita");
}

// ------------------------ AGREGAR / GUARDAR ------------------------
const agregar = () => {
  $('#btnAgregar').on('click', () => {
    $('#txtIdCita').val('');
    $('#txtIdAgenda').val('');
    $('#txtpaciente, #id_paciente').val('');
    $('#txtmedico, #id_medico').val('');
    $('#txtespecialidad, #id_especialidad').val('');
    $('#txtturno, #id_turno').val('');
    $('#fecha, #hora').val('');
    $('#txtestado, #id_estado').val('');
    $('#txtmotivo').val('');
    $('#id_agenda_medica').val('');
    // <--- asignamos el valor de la agenda actual
    $('#id_agenda_medica').val(AGENDA_ID);
    $('#modalTitle').text("Registrar Cita");
    $('#modalFormulario').modal('show');
    limpiarModal();  // Llamar la funciÃ³n de limpieza
    $('#id_agenda_medica').val(AGENDA_ID);
    $('#modalFormulario').modal('show');
  });
};

const guardar = () => {
  $('#btnGuardarCita').on('click', () => {
    const idCita = $('#txtIdCita').val();

    // siempre usamos la variable global AGENDA_ID
    const id_agenda_medica = AGENDA_ID || null;  

    const payload = {
      id_paciente: $('#id_paciente').val(),
      id_medico: $('#id_medico').val(),
      id_especialidad: $('#id_especialidad').val(),
      id_turno: $('#id_turno').val(),
      fecha_cita: $('#fecha').val(),
      hora: $('#hora').val(),
      id_estado: $('#id_estado').val(),
      motivo_consulta: $('#txtmotivo').val(),
      id_agenda_medica: id_agenda_medica
    };

    console.log("Payload enviado:", payload); // âœ… verificaciÃ³n

    // validar agenda
    if (!id_agenda_medica) {
      Swal.fire("Error", "No se ha vinculado la cita con una agenda mÃ©dica.", "error");
      return;
    }

    const tabla = $('#tbl').DataTable();
    const url = idCita ? `/api/v1/registroc/${idCita}` : '/api/v1/registroc';
    const method = idCita ? 'PUT' : 'POST';

    fetch(url, {
      method: method,
      headers: { 
        'Content-Type': 'application/json', 
        'X-CSRFToken': CSRFToken 
      },
      body: JSON.stringify(payload)
    })
    .then(resp => resp.json())
    .then(data => {
      if (data && !data.error && data.success) {
        tabla.ajax.reload();
        Swal.fire(
          idCita ? "Actualizado" : "Registrado", 
          "La cita se guardÃ³ correctamente.", 
          "success"
        );
        $('#modalFormulario').modal('hide');
      } else {
        Swal.fire("Error", data.error || "No se pudo guardar la cita.", "error");
      }
    })
    .catch(err => Swal.fire("Error", "OcurriÃ³ un error al guardar la cita.", "error"));
  });
};



// ------------------------ EDITAR ------------------------
// ------------------------ EDITAR ------------------------
const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function () {
    const idCita = $(this).data('id_cita');
    fetch(`/api/v1/registroc/${idCita}`)
      .then(resp => resp.json())
      .then(data => {
        if (data && data.success && data.data) {
          const cita = data.data;

          // Rellenar campos bÃ¡sicos
          $('#txtIdCita').val(idCita);
          $('#fecha').val(formatDateForInput(cita.fecha_cita));
          $('#hora').val(cita.hora ? cita.hora.slice(0,5) : "");
          $('#txtmotivo').val(cita.motivo_consulta);

          // Paciente
          $('#id_paciente').val(cita.id_paciente);
          $('#txtpaciente').val(`${cita.paciente_nombre} ${cita.paciente_apellido}`);

          // MÃ©dico
          $('#id_medico').val(cita.id_medico);
          $('#txtmedico').val(`${cita.medico_nombre} ${cita.medico_apellido}`);

          // Especialidad
          $('#id_especialidad').val(cita.id_especialidad);
          $('#txtespecialidad').val(cita.especialidad);

          // Turno
          $('#id_turno').val(cita.id_turno);
          $('#txtturno').val(cita.turno);

          // Estado
          $('#id_estado').val(cita.id_estado);
          $('#txtestado').val(cita.estado);

          // Agenda
          $('#id_agenda_medica').val(cita.id_agenda_medica);

          let agendaLabel = '';
          if (cita.agenda_descripcion && cita.agenda_fecha) {
            const d = new Date(cita.agenda_fecha);
            const day = String(d.getUTCDate()).padStart(2,'0');
            const month = String(d.getUTCMonth()+1).padStart(2,'0');
            const year = d.getUTCFullYear();
            agendaLabel = `${cita.agenda_descripcion} - ${day}/${month}/${year} (${cita.turno})`;
          }
          $('#txtagenda').val(agendaLabel);

          // Actualizamos la variable global
          AGENDA_ID = cita.id_agenda_medica;

          // Modal
          $('#modalTitle').text("Editar Cita");
          $('#modalFormulario').modal('show');
        } else {
          Swal.fire("Error", data.error || "No se pudo cargar la cita", "error");
        }
      })
      .catch(err => Swal.fire("Error", "OcurriÃ³ un error al cargar la cita", "error"));
  });
};


// ------------------------ ELIMINAR ------------------------
const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function () {
    const idCita = $(this).data('id_cita');
    Swal.fire({
      title: "Â¿Deseas eliminar esta cita?",
      showCancelButton: true,
      confirmButtonText: "SÃ­",
      cancelButtonText: "No"
    }).then((result) => {
      if(result.isConfirmed){
        fetch(`/api/v1/registroc/${idCita}`, {
          method:'DELETE',
          headers:{ 'X-CSRFToken': CSRFToken }
        }).then(resp=>resp.json()).then(data=>{
          if(data && !data.error && data.success){
            $('#tbl').DataTable().ajax.reload();
            Swal.fire("Eliminado", "La cita ha sido eliminada correctamente.", "success");
          } else Swal.fire("Error", data.error, "error");
        });
      }
    });
  });
};

// ------------------------ INICIALIZACIÃ“N ------------------------
$(function(){
  AGENDA_ID = $('#id_agenda_medica').val();  
  console.log("AGENDA_ID cargado:", AGENDA_ID);
  initDatatable();
  initDatatablep();
  initDatatablem();
  initDatatablee();
  initDatatableestado();
  initDatatableTurno();
  agregar();
  guardar();
  editar();
  eliminar();
  buscarPaciente();
  buscarMedico();
  buscarEspecialidad();
  buscarEstado();
  buscarTurno();
  initDatatableAgenda();
buscarAgenda();
});
</script>
{% endblock %}



